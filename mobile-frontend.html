<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Event Scout - Mobile</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        // Tailwind configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        'primary-dark': '#1e40af',
                        secondary: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b'
                    }
                }
            }
        }
    </script>

    <style>
        /* CSS Custom Properties (kept from original) */
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        /* Utility classes */
        .hidden {
            display: none !important;
        }

        /* Mobile-specific animations */
        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .slide-up {
            animation: slideUp 0.3s ease-out;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        /* Safe area insets for notched devices */
        .safe-area-inset-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }

        .safe-area-inset-top {
            padding-top: env(safe-area-inset-top);
        }

        /* Touch feedback */
        .touch-feedback:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        /* Bottom nav active indicator */
        .nav-btn {
            position: relative;
            transition: all 0.2s ease;
        }
        .nav-btn.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            height: 3px;
            background: #2563eb;
            border-radius: 0 0 4px 4px;
        }
        .nav-btn:active {
            transform: scale(0.9);
        }

        /* Voice recording pulse */
        @keyframes recordingPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 12px rgba(239, 68, 68, 0); }
        }
        .recording-pulse {
            animation: recordingPulse 1.5s ease-in-out infinite;
        }

        /* Swipe voice indicator */
        .swipe-voice-indicator {
            position: absolute;
            right: -60px;
            top: 0;
            bottom: 0;
            width: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(90deg, transparent, #7c3aed);
            border-radius: 0 8px 8px 0;
            color: white;
            font-size: 20px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .contact-card {
            position: relative;
            overflow: hidden;
        }
        .contact-card-inner {
            transition: transform 0.2s ease;
        }

        /* Swipe gesture indicator */
        .swipeable {
            position: relative;
            overflow: hidden;
        }

        .swipe-actions {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            display: flex;
            transform: translateX(100%);
        }

        /* Loading spinner */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        /* Contact detail view slide-in */
        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); }
            to { transform: translateX(100%); }
        }
        .slide-in-right {
            animation: slideInRight 0.25s ease-out forwards;
        }
        .slide-out-right {
            animation: slideOutRight 0.25s ease-in forwards;
        }

        /* Avatar color generation */
        .avatar-gradient-0 { background: linear-gradient(135deg, #667eea, #764ba2); }
        .avatar-gradient-1 { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .avatar-gradient-2 { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .avatar-gradient-3 { background: linear-gradient(135deg, #43e97b, #38f9d7); }
        .avatar-gradient-4 { background: linear-gradient(135deg, #fa709a, #fee140); }
        .avatar-gradient-5 { background: linear-gradient(135deg, #a18cd1, #fbc2eb); }
        .avatar-gradient-6 { background: linear-gradient(135deg, #fccb90, #d57eeb); }
        .avatar-gradient-7 { background: linear-gradient(135deg, #e0c3fc, #8ec5fc); }

        /* Link chip */
        .link-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            background: #eff6ff;
            color: #2563eb;
            border: 1px solid #bfdbfe;
            text-decoration: none;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .link-chip.auto {
            background: #f0fdf4;
            color: #16a34a;
            border-color: #bbf7d0;
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- ========================================
         AUTH SCREEN (Login/Register)
    ======================================== -->
    <div id="authScreen" class="screen min-h-screen bg-gradient-to-br from-purple-600 to-blue-500 flex items-center justify-center p-4">
        <div class="w-full max-w-md">
            <!-- Logo/Header -->
            <div class="text-center mb-8">
                <div class="mb-4 flex justify-center">
                    <svg width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="logoGrad" x1="0" y1="0" x2="80" y2="80" gradientUnits="userSpaceOnUse">
                                <stop offset="0%" stop-color="#a78bfa"/>
                                <stop offset="100%" stop-color="#60a5fa"/>
                            </linearGradient>
                        </defs>
                        <!-- Outer ring -->
                        <circle cx="40" cy="40" r="38" stroke="url(#logoGrad)" stroke-width="2" fill="none" opacity="0.3"/>
                        <!-- Middle ring -->
                        <circle cx="40" cy="40" r="28" stroke="url(#logoGrad)" stroke-width="2" fill="none" opacity="0.5"/>
                        <!-- Inner ring -->
                        <circle cx="40" cy="40" r="18" stroke="url(#logoGrad)" stroke-width="2" fill="none" opacity="0.7"/>
                        <!-- Center dot -->
                        <circle cx="40" cy="40" r="4" fill="url(#logoGrad)"/>
                        <!-- Radar sweep -->
                        <path d="M40 40 L40 2 A38 38 0 0 1 72 22 Z" fill="url(#logoGrad)" opacity="0.15"/>
                        <!-- Contact nodes -->
                        <circle cx="58" cy="18" r="4" fill="#a78bfa" opacity="0.9"/>
                        <circle cx="65" cy="38" r="3" fill="#818cf8" opacity="0.7"/>
                        <circle cx="22" cy="56" r="3.5" fill="#60a5fa" opacity="0.8"/>
                        <circle cx="50" cy="60" r="3" fill="#93c5fd" opacity="0.6"/>
                        <!-- Crosshair lines -->
                        <line x1="40" y1="8" x2="40" y2="16" stroke="white" stroke-width="1" opacity="0.4"/>
                        <line x1="40" y1="64" x2="40" y2="72" stroke="white" stroke-width="1" opacity="0.4"/>
                        <line x1="8" y1="40" x2="16" y2="40" stroke="white" stroke-width="1" opacity="0.4"/>
                        <line x1="64" y1="40" x2="72" y2="40" stroke="white" stroke-width="1" opacity="0.4"/>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-white">Event Scout</h1>
                <p class="text-purple-100 mt-2">Smart Contact Management</p>
            </div>

            <!-- Auth Card -->
            <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
                <!-- Tabs -->
                <div class="flex border-b border-gray-200">
                    <button onclick="switchAuthTab('login')" class="auth-tab active flex-1 py-4 text-center font-semibold text-gray-600 border-b-2 border-transparent transition-all">
                        Login
                    </button>
                    <button onclick="switchAuthTab('register')" class="auth-tab flex-1 py-4 text-center font-semibold text-gray-600 border-b-2 border-transparent transition-all">
                        Register
                    </button>
                </div>

                <!-- Alert Container -->
                <div id="authAlert" class="px-6 pt-4"></div>

                <!-- Login Form -->
                <form id="loginForm" class="p-6 space-y-4" onsubmit="handleLogin(event)">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input id="loginEmail"
                               type="email"
                               autocomplete="email"
                               inputmode="email"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                               placeholder="you@example.com"
                               required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <div class="relative">
                            <input id="loginPassword"
                                   type="password"
                                   autocomplete="current-password"
                                   class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                                   placeholder="••••••••"
                                   required>
                            <button type="button"
                                    onclick="togglePassword('loginPassword')"
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold active:bg-blue-700 transition touch-feedback">
                        Sign In
                    </button>
                </form>

                <!-- Register Form -->
                <form id="registerForm" class="p-6 space-y-4 hidden" onsubmit="handleRegister(event)">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                        <input id="registerName"
                               type="text"
                               autocomplete="name"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                               placeholder="John Doe"
                               required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input id="registerEmail"
                               type="email"
                               autocomplete="email"
                               inputmode="email"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                               placeholder="you@example.com"
                               required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <div class="relative">
                            <input id="registerPassword"
                                   type="password"
                                   autocomplete="new-password"
                                   class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                                   placeholder="••••••••"
                                   minlength="6"
                                   required>
                            <button type="button"
                                    onclick="togglePassword('registerPassword')"
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold active:bg-blue-700 transition touch-feedback">
                        Create Account
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- ========================================
         MAIN APP (Dashboard with Bottom Nav)
    ======================================== -->
    <div id="mainApp" class="screen hidden flex flex-col h-screen bg-gray-50">
        <!-- Content Area (swappable screens) -->
        <div id="contentArea" class="flex-1 overflow-y-auto pb-20" style="scroll-padding-top: 120px">

            <!-- CONTACTS SCREEN -->
            <div id="contactsScreen" class="content-screen">
                <!-- Sticky Header with Search -->
                <div class="sticky top-0 bg-white border-b border-gray-200 safe-area-inset-top z-30">
                    <div class="px-4 pt-3 pb-2">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <svg width="24" height="24" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <defs><linearGradient id="logoGradSm" x1="0" y1="0" x2="80" y2="80" gradientUnits="userSpaceOnUse"><stop offset="0%" stop-color="#7c3aed"/><stop offset="100%" stop-color="#2563eb"/></linearGradient></defs>
                                    <circle cx="40" cy="40" r="38" stroke="url(#logoGradSm)" stroke-width="3" fill="none" opacity="0.3"/>
                                    <circle cx="40" cy="40" r="28" stroke="url(#logoGradSm)" stroke-width="3" fill="none" opacity="0.5"/>
                                    <circle cx="40" cy="40" r="18" stroke="url(#logoGradSm)" stroke-width="3" fill="none" opacity="0.7"/>
                                    <circle cx="40" cy="40" r="5" fill="url(#logoGradSm)"/>
                                    <path d="M40 40 L40 2 A38 38 0 0 1 72 22 Z" fill="url(#logoGradSm)" opacity="0.15"/>
                                    <circle cx="58" cy="18" r="5" fill="#7c3aed" opacity="0.9"/>
                                    <circle cx="22" cy="56" r="4" fill="#2563eb" opacity="0.8"/>
                                </svg>
                                <div>
                                    <h2 class="text-lg font-bold text-gray-900">Contacts</h2>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500">Hi, <span id="userName"></span>!</p>
                        </div>
                        <div class="relative">
                            <input type="search"
                                   id="searchInput"
                                   placeholder="Search contacts..."
                                   class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-full focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm"
                                   oninput="handleSearch()">
                            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                        </div>
                    </div>
                </div>

                <!-- Hot Leads Spotlight -->
                <div id="hotLeadsBanner" class="hidden px-4 pt-3">
                    <div class="bg-gradient-to-r from-red-500 to-orange-500 rounded-xl p-4 shadow-sm">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-white font-bold text-sm"><i class="fas fa-fire mr-1"></i>Your Hottest Leads</h3>
                        </div>
                        <div id="hotLeadsScroll" class="flex gap-3 overflow-x-auto pb-1">
                            <!-- Hot leads cards injected here -->
                        </div>
                    </div>
                </div>

                <!-- Contact List -->
                <div id="contactsList" class="divide-y divide-gray-200 pt-4">
                    <!-- Contacts will be rendered here -->
                </div>

                <!-- Floating Action Button -->
                <button id="contactsFab" onclick="openAddContactSheet()"
                        class="fixed bottom-24 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-lg active:scale-95 transition z-30 touch-feedback">
                    <i class="fas fa-plus text-xl"></i>
                </button>
            </div>

            <!-- SCAN SCREEN -->
            <div id="scanScreen" class="content-screen hidden">
                <div class="fixed inset-0 flex flex-col bg-black" style="top:0;bottom:0;z-index:40;">
                    <!-- Camera View - fills available space -->
                    <div id="cameraView" class="flex-1 relative overflow-hidden" style="min-height:0;">
                        <!-- Video Stream -->
                        <video id="cameraStream" class="absolute inset-0 w-full h-full object-cover" autoplay playsinline></video>

                        <!-- Overlay Guide -->
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <div class="border-4 border-white/80 rounded-2xl shadow-2xl relative" style="width:85%;max-width:340px;aspect-ratio:1.7/1;">
                                <div class="absolute -top-10 left-0 right-0 text-center">
                                    <p class="text-white text-xs font-medium bg-black/60 px-3 py-1.5 rounded-full inline-block">
                                        Align card within frame
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Bulk scan counter toast -->
                        <div id="scanCounter" class="hidden absolute top-4 right-4 bg-green-500 text-white px-3 py-1.5 rounded-full text-sm font-semibold shadow-lg z-10">
                            <i class="fas fa-check mr-1"></i><span id="scanCountText">0 scanned</span>
                        </div>

                        <!-- Pending scans badge (non-blocking) -->
                        <div id="pendingScanBadge" class="hidden absolute top-4 left-4 bg-blue-500 text-white px-3 py-1.5 rounded-full text-sm font-semibold shadow-lg z-10 animate-pulse">
                            <i class="fas fa-spinner fa-spin mr-1"></i><span id="pendingScanText">Processing...</span>
                        </div>

                        <!-- Camera Error State -->
                        <div id="cameraError" class="hidden absolute inset-0 flex items-center justify-center bg-gray-900 p-8 text-center">
                            <div>
                                <i class="fas fa-camera-slash text-6xl text-gray-400 mb-4"></i>
                                <h3 class="text-xl font-semibold text-white mb-2">Camera Not Available</h3>
                                <p class="text-sm text-gray-300 mb-6">
                                    Please allow camera access or upload an image
                                </p>
                                <button onclick="uploadFromGallery()" class="bg-white text-gray-900 px-6 py-3 rounded-lg font-semibold">
                                    Upload from Gallery
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Controls - fixed at bottom, always visible -->
                    <div class="bg-gray-900/95 backdrop-blur-sm px-4 pt-3 pb-20 safe-area-inset-bottom" style="flex-shrink:0;">
                        <div class="flex justify-center gap-5 items-center">
                            <button onclick="uploadFromGallery()" class="w-11 h-11 bg-gray-700 rounded-full text-white flex items-center justify-center active:bg-gray-600">
                                <i class="fas fa-image text-sm"></i>
                            </button>

                            <button id="captureBtn" onclick="captureBusinessCard()" class="w-16 h-16 bg-white rounded-full shadow-lg active:scale-95 transition flex items-center justify-center border-4 border-gray-300">
                                <div class="w-12 h-12 bg-white rounded-full border-2 border-gray-400"></div>
                            </button>

                            <button onclick="switchCamera()" class="w-11 h-11 bg-gray-700 rounded-full text-white flex items-center justify-center active:bg-gray-600">
                                <i class="fas fa-sync-alt text-sm"></i>
                            </button>
                        </div>
                        <!-- Done button for bulk scan mode -->
                        <div id="bulkScanDone" class="hidden mt-2">
                            <button onclick="finishBulkScan()" class="w-full py-2 bg-green-500 text-white rounded-lg font-semibold text-sm active:bg-green-600">
                                <i class="fas fa-check mr-1"></i>Done - View Contacts
                            </button>
                        </div>
                    </div>

                    <!-- Scan Feed - per-card processing status -->
                    <div id="scanFeed" class="absolute bottom-28 left-2 right-2 z-20 space-y-1.5 pointer-events-none flex flex-col items-start">
                        <!-- Dynamically populated with scan status pills -->
                    </div>

                    <!-- Shutter flash overlay -->
                    <div id="shutterFlash" class="absolute inset-0 bg-white z-30 pointer-events-none opacity-0" style="transition: opacity 0.15s"></div>

                    <!-- Hidden file input (supports multiple) -->
                    <input type="file" id="galleryInput" accept="image/*" multiple class="hidden" onchange="handleGalleryUpload(event)">

                    <!-- Processing Overlay - multi-step -->
                    <div id="processingOverlay" class="hidden absolute inset-0 bg-black/90 flex-col items-center justify-center z-50">
                        <div class="text-center px-8">
                            <div id="processStep1" class="flex items-center gap-3 text-white mb-3">
                                <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center">
                                    <i class="fas fa-upload text-sm"></i>
                                </div>
                                <span class="text-sm">Uploading image...</span>
                            </div>
                            <div id="processStep2" class="flex items-center gap-3 text-gray-500 mb-3">
                                <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center">
                                    <i class="fas fa-brain text-sm"></i>
                                </div>
                                <span class="text-sm">AI analyzing card...</span>
                            </div>
                            <div id="processStep3" class="flex items-center gap-3 text-gray-500 mb-3">
                                <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center">
                                    <i class="fas fa-save text-sm"></i>
                                </div>
                                <span class="text-sm">Saving contact...</span>
                            </div>
                            <div id="processStep4" class="flex items-center gap-3 text-gray-500">
                                <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center">
                                    <i class="fas fa-check text-sm"></i>
                                </div>
                                <span class="text-sm">Done!</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CHAT SCREEN -->
            <div id="chatScreen" class="content-screen hidden flex flex-col h-screen bg-gray-50">
                <!-- Chat Header -->
                <div class="bg-gradient-to-r from-purple-600 to-blue-500 text-white p-4 flex items-center justify-between safe-area-inset-top">
                    <div>
                        <h2 class="font-semibold text-lg">AI Assistant</h2>
                        <p class="text-xs text-purple-100" id="chatModelLabel">Powered by Claude Opus 4.6</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="toggleTeamMode()" id="teamModeBtn" class="hidden px-2.5 py-1 rounded-full text-[10px] font-medium bg-white/20 text-white/80 active:bg-white/30 transition-all">
                            <i class="fas fa-users mr-1"></i>Team Mode
                        </button>
                        <button onclick="clearChatHistory()" class="p-2 text-white/80 active:bg-white/20 rounded-lg">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>

                <!-- Suggested Queries (shown when empty) -->
                <div id="chatSuggestions" class="p-4 space-y-2">
                    <p class="text-sm text-gray-600 mb-3">Try asking:</p>
                    <button onclick="askAI('Who are my hottest leads right now?')" class="block w-full text-left px-4 py-3 bg-blue-50 hover:bg-blue-100 rounded-lg text-sm text-gray-700 active:bg-blue-200">
                        "Who are my hottest leads right now?"
                    </button>
                    <button onclick="askAI('Which exhibitors should I visit today?')" class="block w-full text-left px-4 py-3 bg-purple-50 hover:bg-purple-100 rounded-lg text-sm text-gray-700 active:bg-purple-200">
                        "Which exhibitors should I visit today?"
                    </button>
                    <button onclick="askAI('Brief me on my top 3 contacts')" class="block w-full text-left px-4 py-3 bg-green-50 hover:bg-green-100 rounded-lg text-sm text-gray-700 active:bg-green-200">
                        "Brief me on my top 3 contacts"
                    </button>
                    <button onclick="askAI('Suggest pitch angles for my warm leads')" class="block w-full text-left px-4 py-3 bg-orange-50 hover:bg-orange-100 rounded-lg text-sm text-gray-700 active:bg-orange-200">
                        "Suggest pitch angles for my warm leads"
                    </button>
                </div>

                <!-- Messages Container -->
                <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 pb-24">
                    <!-- Messages rendered here -->
                </div>

                <!-- Input Area (fixed at bottom) -->
                <div class="border-t border-gray-200 bg-white p-4 pb-safe-area fixed bottom-16 left-0 right-0">
                    <form onsubmit="sendChatMessage(event)" class="flex gap-2">
                        <textarea id="chatInput"
                               rows="1"
                               placeholder="Ask about your contacts..."
                               class="flex-1 px-4 py-3 text-base border border-gray-300 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none resize-none max-h-24 overflow-y-auto"
                               oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,96)+'px'"
                               onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();this.closest('form').dispatchEvent(new Event('submit',{cancelable:true}))}"
                               required></textarea>
                        <button type="button" onclick="toggleChatVoice()" id="chatMicBtn"
                                class="w-12 h-12 bg-gray-100 text-gray-500 rounded-full flex items-center justify-center active:bg-purple-100 flex-shrink-0 transition">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button type="submit"
                                class="w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center active:bg-blue-700 flex-shrink-0">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>

            <!-- EXPO SCREEN -->
            <div id="expoScreen" class="content-screen hidden">
                <div class="safe-area-inset-top">
                    <!-- Expo Header -->
                    <div class="bg-gradient-to-r from-emerald-600 to-teal-500 text-white p-4">
                        <h2 id="expoEventName" class="font-semibold text-lg">Select Event in Profile</h2>
                        <p id="expoEventDetails" class="text-xs text-emerald-100">Set your current event to see exhibitors</p>
                    </div>

                    <!-- Search & Filter -->
                    <div class="p-4 bg-white border-b border-gray-200">
                        <input type="search" id="expoSearchInput" placeholder="Search exhibitors..."
                               class="w-full px-4 py-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-emerald-500 outline-none mb-2"
                               oninput="filterExhibitors()">
                        <div id="categoryFilter" class="flex gap-2 overflow-x-auto pb-1 text-sm">
                            <button onclick="filterByCategory('')" class="category-btn px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full whitespace-nowrap text-xs font-medium">All</button>
                        </div>
                    </div>

                    <!-- Event Materials Section -->
                    <div class="p-4 bg-blue-50 border-b border-blue-200">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-file-download text-blue-600 text-lg"></i>
                                <h3 class="text-base font-semibold text-gray-900">Event Materials</h3>
                            </div>
                            <button onclick="refreshEventFiles()" class="text-xs text-blue-600 hover:text-blue-700">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div class="flex gap-2 overflow-x-auto pb-1 mb-3">
                            <button onclick="filterFilesByCategory('')" class="file-cat-btn px-3 py-1 bg-blue-600 text-white rounded-full whitespace-nowrap text-xs font-medium">All</button>
                            <button onclick="filterFilesByCategory('catalog')" class="file-cat-btn px-3 py-1 bg-white text-gray-700 rounded-full whitespace-nowrap text-xs font-medium">Catalogs</button>
                            <button onclick="filterFilesByCategory('brochure')" class="file-cat-btn px-3 py-1 bg-white text-gray-700 rounded-full whitespace-nowrap text-xs font-medium">Brochures</button>
                            <button onclick="filterFilesByCategory('pricing')" class="file-cat-btn px-3 py-1 bg-white text-gray-700 rounded-full whitespace-nowrap text-xs font-medium">Pricing</button>
                        </div>
                        <div id="eventFilesList" class="space-y-2">
                            <p class="text-sm text-gray-400 text-center py-2">No files available</p>
                        </div>
                    </div>

                    <!-- Exhibitor List -->
                    <div id="exhibitorList" class="p-4 space-y-3">
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-spinner fa-spin text-2xl mb-3 block"></i>
                            <p>Loading exhibitors...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PROFILE SCREEN -->
            <div id="profileScreen" class="content-screen hidden">
                <div class="p-6 space-y-6 safe-area-inset-top">
                    <h2 class="text-2xl font-bold text-gray-900">Profile</h2>

                    <div class="bg-white rounded-xl p-6 shadow-sm">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-20 h-20 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-white text-3xl font-bold">
                                <span id="profileInitial"></span>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900" id="profileName"></h3>
                                <p class="text-sm text-gray-500" id="profileEmail"></p>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <div class="flex items-center justify-between py-3 border-t border-gray-100">
                                <span class="text-gray-700">Total Contacts</span>
                                <span class="font-semibold text-gray-900" id="totalContacts">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Personalization Settings -->
                    <div class="bg-white rounded-xl p-6 shadow-sm space-y-3">
                        <h3 class="font-semibold text-gray-900">Personalization</h3>
                        <p class="text-xs text-gray-500">Help AI personalize scoring, pitches, and advice</p>
                        <button onclick="openSettingsSheet('products')" class="w-full flex items-center justify-between py-3 px-4 bg-purple-50 rounded-lg active:bg-purple-100 transition">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-box text-purple-600 text-lg w-6 text-center"></i>
                                <span class="text-gray-700">Products & Services</span>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>
                        <button onclick="openSettingsSheet('targeting')" class="w-full flex items-center justify-between py-3 px-4 bg-blue-50 rounded-lg active:bg-blue-100 transition">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-crosshairs text-blue-600 text-lg w-6 text-center"></i>
                                <span class="text-gray-700">Target Market</span>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>
                        <button onclick="openSettingsSheet('pitch')" class="w-full flex items-center justify-between py-3 px-4 bg-green-50 rounded-lg active:bg-green-100 transition">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-bullseye text-green-600 text-lg w-6 text-center"></i>
                                <span class="text-gray-700">Pitch & Value Props</span>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>
                        <button onclick="openSettingsSheet('event')" class="w-full flex items-center justify-between py-3 px-4 bg-orange-50 rounded-lg active:bg-orange-100 transition">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-calendar-check text-orange-600 text-lg w-6 text-center"></i>
                                <span class="text-gray-700">Current Event</span>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>

                        <!-- AI Model Selection -->
                        <div class="mt-4 pt-4 border-t border-gray-100">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">AI Assistant Model</h4>
                            <select id="aiModelSelect" onchange="saveAIModel()"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white text-gray-700">
                                <option value="claude-opus">Claude Opus 4.6 (Recommended)</option>
                                <option value="gpt-5">GPT-5.2</option>
                                <option value="gemini-pro">Gemini 2.5 Pro</option>
                            </select>
                            <p class="text-xs text-gray-400 mt-1">Controls the AI chat. OCR scanning uses Gemini.</p>
                        </div>
                    </div>

                    <!-- Lead Intelligence -->
                    <div class="bg-white rounded-xl p-6 shadow-sm space-y-3">
                        <h3 class="font-semibold text-gray-900">Lead Intelligence</h3>
                        <div id="dashboardStats" class="grid grid-cols-3 gap-3 text-center">
                            <div class="bg-red-50 rounded-lg p-3">
                                <p class="text-2xl font-bold text-red-600" id="statHot">-</p>
                                <p class="text-xs text-gray-500">Hot</p>
                            </div>
                            <div class="bg-orange-50 rounded-lg p-3">
                                <p class="text-2xl font-bold text-orange-500" id="statWarm">-</p>
                                <p class="text-xs text-gray-500">Warm</p>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3">
                                <p class="text-2xl font-bold text-gray-500" id="statCold">-</p>
                                <p class="text-xs text-gray-500">Cold</p>
                            </div>
                        </div>
                        <button onclick="scoreAllContacts()" id="scoreAllBtn" class="w-full flex items-center justify-center gap-2 py-3 px-4 bg-gradient-to-r from-purple-600 to-blue-500 text-white rounded-lg font-semibold active:opacity-90 transition">
                            <i class="fas fa-bolt"></i>
                            <span>Score All Contacts</span>
                        </button>
                    </div>

                    <!-- Digital Business Card -->
                    <div class="bg-white rounded-xl p-6 shadow-sm space-y-3">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-900">My Digital Card</h3>
                            <i class="fas fa-qrcode text-blue-500 text-lg"></i>
                        </div>
                        <p class="text-xs text-gray-500">Share your contact info via QR code or NFC tap</p>

                        <!-- Card Form -->
                        <div class="space-y-2">
                            <!-- Profile Photo Upload -->
                            <div class="flex items-center gap-3 py-2">
                                <div id="cardPhotoPreview" class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center text-gray-400 text-2xl overflow-hidden flex-shrink-0 border-2 border-dashed border-gray-300">
                                    <i class="fas fa-camera"></i>
                                </div>
                                <div class="flex-1">
                                    <label class="block text-xs text-gray-500 mb-1">Profile Photo</label>
                                    <input type="file" id="cardPhotoInput" accept="image/*" class="hidden" onchange="handleCardPhotoUpload(event)">
                                    <button onclick="document.getElementById('cardPhotoInput').click()" class="text-sm text-blue-600 font-medium">
                                        <i class="fas fa-upload mr-1"></i>Upload Photo
                                    </button>
                                </div>
                            </div>
                            <input type="text" id="cardFullName" placeholder="Full Name" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            <input type="text" id="cardJobTitle" placeholder="Job Title" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            <input type="text" id="cardCompanyName" placeholder="Company" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            <input type="email" id="cardEmail" placeholder="Email" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            <input type="tel" id="cardPhone" placeholder="Phone Number" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            <input type="url" id="cardLinkedIn" placeholder="LinkedIn URL (encouraged)" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            <input type="tel" id="cardZoom" placeholder="Zoom Number (optional)" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            <input type="url" id="cardWebsite" placeholder="Website (optional)" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>

                        <!-- Save Card Button -->
                        <button onclick="saveDigitalCard()" id="saveCardBtn" class="w-full flex items-center justify-center gap-2 py-3 px-4 bg-gradient-to-r from-blue-600 to-cyan-500 text-white rounded-lg font-semibold active:opacity-90 transition">
                            <i class="fas fa-save"></i>
                            <span>Save Card</span>
                        </button>

                        <!-- Generate QR Button -->
                        <button onclick="generateCardQR()" id="generateQRBtn" class="w-full flex items-center justify-center gap-2 py-3 px-4 bg-gradient-to-r from-purple-600 to-pink-500 text-white rounded-lg font-semibold active:opacity-90 transition">
                            <i class="fas fa-qrcode"></i>
                            <span>Generate QR Code</span>
                        </button>

                        <!-- QR Code Display -->
                        <div id="cardQRContainer" class="hidden mt-3">
                            <div class="bg-gray-50 rounded-lg p-4 text-center">
                                <img id="cardQRImage" src="" alt="QR Code" class="mx-auto max-w-full" style="max-width: 250px;">
                                <p class="text-xs text-gray-600 mt-2">Share this QR code with people you meet!</p>
                                <p id="cardShareableURL" class="text-xs text-blue-600 mt-1 break-all"></p>
                                <button onclick="saveMyCardToPhone()" class="mt-3 w-full flex items-center justify-center gap-2 py-3 px-4 bg-blue-600 text-white rounded-lg font-semibold active:bg-blue-700 transition">
                                    <i class="fas fa-address-book"></i>
                                    <span>Save My Card to Phone</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Export Section -->
                    <div class="bg-white rounded-xl p-6 shadow-sm space-y-3">
                        <h3 class="font-semibold text-gray-900">Data Export</h3>
                        <button onclick="exportContacts('csv')" class="w-full flex items-center justify-between py-3 px-4 bg-green-50 rounded-lg active:bg-green-100 transition">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-file-csv text-green-600 text-lg"></i>
                                <span class="text-gray-700">Export as CSV</span>
                            </div>
                            <i class="fas fa-download text-gray-400"></i>
                        </button>
                        <button onclick="exportContacts('json')" class="w-full flex items-center justify-between py-3 px-4 bg-blue-50 rounded-lg active:bg-blue-100 transition">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-file-code text-blue-600 text-lg"></i>
                                <span class="text-gray-700">Export as JSON</span>
                            </div>
                            <i class="fas fa-download text-gray-400"></i>
                        </button>
                    </div>

                    <button onclick="handleLogout()" class="w-full bg-red-500 text-white py-3 rounded-lg font-semibold active:bg-red-600 transition touch-feedback">
                        <i class="fas fa-sign-out-alt mr-2"></i>
                        Logout
                    </button>
                </div>
            </div>
        </div>

            <!-- ADMIN SCREEN (hidden by default, shown only for admins) -->
            <div id="adminScreen" class="content-screen hidden">
                <div class="p-4 space-y-4">
                    <div class="flex items-center gap-3 mb-2">
                        <i class="fas fa-shield-alt text-purple-600 text-xl"></i>
                        <h2 class="text-xl font-bold text-gray-900">Admin Dashboard</h2>
                    </div>

                    <!-- Global Stats -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-gradient-to-br from-purple-500 to-blue-500 text-white rounded-xl p-4">
                            <p class="text-3xl font-bold" id="adminStatUsers">-</p>
                            <p class="text-sm opacity-80">Total Users</p>
                        </div>
                        <div class="bg-gradient-to-br from-blue-500 to-cyan-500 text-white rounded-xl p-4">
                            <p class="text-3xl font-bold" id="adminStatContacts">-</p>
                            <p class="text-sm opacity-80">Total Contacts</p>
                        </div>
                        <div class="bg-red-50 rounded-xl p-4">
                            <p class="text-2xl font-bold text-red-600" id="adminStatHot">-</p>
                            <p class="text-xs text-gray-500">Hot Leads</p>
                        </div>
                        <div class="bg-orange-50 rounded-xl p-4">
                            <p class="text-2xl font-bold text-orange-500" id="adminStatWarm">-</p>
                            <p class="text-xs text-gray-500">Warm Leads</p>
                        </div>
                    </div>

                    <!-- Quick Actions Row -->
                    <div class="flex gap-2">
                        <button onclick="adminExportAll()" class="flex-1 px-3 py-2.5 bg-green-600 text-white rounded-lg text-sm font-medium flex items-center justify-center gap-2">
                            <i class="fas fa-file-csv"></i> Export All CSV
                        </button>
                        <button onclick="loadAdminDashboard()" class="px-3 py-2.5 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium flex items-center justify-center gap-2">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>

                    <!-- Admin Search -->
                    <div class="bg-white rounded-xl p-4 shadow-sm">
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            <input type="text" id="adminSearchInput" placeholder="Search all contacts (name, email, company)..."
                                   class="w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-purple-300 focus:border-purple-400"
                                   oninput="debounceAdminSearch()">
                        </div>
                        <div id="adminSearchResults" class="mt-3 hidden space-y-2 max-h-80 overflow-y-auto"></div>
                    </div>

                    <!-- Broadcast to Team -->
                    <div class="bg-white rounded-xl p-4 shadow-sm">
                        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-3">
                            <i class="fas fa-bullhorn mr-1"></i>Broadcast to Team
                        </h3>
                        <textarea id="broadcastMessage" rows="2" placeholder="Send a message to your entire team..."
                                  class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm mb-2 focus:ring-2 focus:ring-purple-300"></textarea>
                        <div class="flex gap-2">
                            <select id="broadcastPriority" class="px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                <option value="normal">Normal</option>
                                <option value="urgent">Urgent</option>
                            </select>
                            <button onclick="sendBroadcast()" class="flex-1 px-4 py-2.5 bg-purple-600 text-white rounded-lg text-sm font-medium active:bg-purple-700 flex items-center justify-center gap-2">
                                <i class="fas fa-paper-plane"></i> Send
                            </button>
                        </div>
                        <div id="broadcastHistory" class="mt-3 space-y-2 hidden"></div>
                    </div>

                    <!-- Team Members -->
                    <div class="bg-white rounded-xl p-4 shadow-sm">
                        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-3">Team Members</h3>
                        <div id="adminTeamList" class="space-y-3">
                            <p class="text-sm text-gray-400 text-center py-4">Loading...</p>
                        </div>
                    </div>

                    <!-- Webhook Configuration -->
                    <div class="bg-white rounded-xl p-4 shadow-sm">
                        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-3">Webhook Configuration</h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div>
                                    <p class="text-sm font-medium text-gray-900">Webhook Status</p>
                                    <p id="webhookStatus" class="text-xs text-gray-500">Checking...</p>
                                </div>
                                <div id="webhookIndicator" class="w-3 h-3 rounded-full bg-gray-300"></div>
                            </div>

                            <div>
                                <label class="text-xs font-medium text-gray-600 mb-1 block">Webhook URL (n8n endpoint)</label>
                                <input type="url" id="webhookUrlInput"
                                       placeholder="https://your-n8n.app/webhook/..."
                                       class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none">
                            </div>

                            <div class="flex gap-2">
                                <button onclick="testWebhook()"
                                        class="flex-1 px-4 py-2.5 bg-purple-600 text-white rounded-lg text-sm font-medium active:bg-purple-700 flex items-center justify-center gap-2">
                                    <i class="fas fa-paper-plane"></i>
                                    Test
                                </button>
                                <button onclick="saveAndTestWebhook()"
                                        class="flex-1 px-4 py-2.5 bg-green-600 text-white rounded-lg text-sm font-medium active:bg-green-700 flex items-center justify-center gap-2">
                                    <i class="fas fa-save"></i>
                                    Save & Test
                                </button>
                            </div>

                            <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                                <p class="text-xs text-blue-700">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Enter your n8n webhook URL. Scanned cards will automatically trigger this webhook for greeting emails.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Real-Time Activity Feed -->
                    <div class="bg-white rounded-xl p-4 shadow-sm">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Real-Time Activity Feed</h3>
                            <button onclick="loadAdminActivity()" class="text-xs text-blue-600 hover:text-blue-700">
                                <i class="fas fa-sync-alt mr-1"></i>Refresh
                            </button>
                        </div>
                        <div id="adminActivityFeed" class="space-y-2 max-h-96 overflow-y-auto">
                            <p class="text-sm text-gray-400 text-center py-4">Loading...</p>
                        </div>
                    </div>

                    <!-- Event Files Management -->
                    <div class="bg-white rounded-xl p-4 shadow-sm">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                <i class="fas fa-file-upload mr-1"></i>Event Files
                            </h3>
                            <button onclick="refreshAdminFiles()" class="text-xs text-blue-600 hover:text-blue-700">
                                <i class="fas fa-sync-alt mr-1"></i>Refresh
                            </button>
                        </div>

                        <!-- Upload Form -->
                        <div class="mb-4 p-3 bg-purple-50 rounded-lg">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Upload New File</label>
                            <input type="file" id="adminFileInput" accept=".pdf,.ppt,.pptx"
                                   class="w-full text-sm text-gray-600 mb-2 file:mr-3 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-600 file:text-white">
                            <input type="text" id="adminFileDescription" placeholder="Description (optional)"
                                   class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm mb-2">
                            <select id="adminFileCategory" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm mb-2">
                                <option value="general">General</option>
                                <option value="catalog">Product Catalog</option>
                                <option value="brochure">Brochure</option>
                                <option value="pricing">Pricing</option>
                            </select>
                            <button onclick="uploadAdminFile()"
                                    class="w-full px-4 py-2.5 bg-purple-600 text-white rounded-lg text-sm font-medium active:bg-purple-700 flex items-center justify-center gap-2">
                                <i class="fas fa-cloud-upload-alt"></i> Upload File
                            </button>
                            <p class="text-xs text-gray-500 mt-2">PDF, PPT, PPTX only. Max 20MB.</p>
                        </div>

                        <!-- Uploaded Files List -->
                        <div id="adminFilesList" class="space-y-2">
                            <p class="text-sm text-gray-400 text-center py-4">No files uploaded yet</p>
                        </div>
                    </div>

                    <!-- Pipeline Monitor -->
                    <div class="bg-white rounded-xl p-4 shadow-sm">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                <i class="fas fa-robot mr-1"></i>AI Pipeline Monitor
                            </h3>
                            <button onclick="loadPipelineMonitor()" class="text-xs text-blue-600 active:text-blue-800"><i class="fas fa-sync-alt"></i></button>
                        </div>
                        <div id="pipelineMonitorStats" class="flex gap-2 mb-3">
                            <span class="px-2 py-1 bg-blue-100 text-blue-600 rounded-full text-[10px] font-medium">Active: <span id="pipelineActiveCount">-</span></span>
                            <span class="px-2 py-1 bg-green-100 text-green-600 rounded-full text-[10px] font-medium">Done: <span id="pipelineDoneCount">-</span></span>
                            <span class="px-2 py-1 bg-red-100 text-red-600 rounded-full text-[10px] font-medium">Failed: <span id="pipelineFailedCount">-</span></span>
                        </div>
                        <div id="pipelineMonitorList" class="space-y-2 max-h-48 overflow-y-auto">
                            <p class="text-xs text-gray-400 text-center py-2">Loading pipelines...</p>
                        </div>
                        <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-100">
                            <span class="text-xs text-gray-500">Auto-pipeline on scan</span>
                            <button onclick="toggleAutoPipeline()" id="autoPipelineToggle" class="px-3 py-1 rounded-full text-xs font-medium bg-gray-200 text-gray-600">
                                Loading...
                            </button>
                        </div>
                    </div>

                    <!-- Database Backup -->
                    <div class="bg-white rounded-xl p-4 shadow-sm">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                <i class="fas fa-database mr-1"></i>Database Backup
                            </h3>
                            <span id="backupStatusDot" class="w-2.5 h-2.5 rounded-full bg-gray-300" title="No backup yet"></span>
                        </div>
                        <div id="backupStatusInfo" class="text-xs text-gray-500 mb-3">
                            <p>Click below to sync data to backup database.</p>
                        </div>
                        <button onclick="triggerBackup()" id="backupBtn"
                                class="w-full px-4 py-2.5 bg-emerald-600 text-white rounded-lg text-sm font-medium active:bg-emerald-700 flex items-center justify-center gap-2 transition-all">
                            <i class="fas fa-shield-alt"></i> Backup Now
                        </button>
                        <button onclick="checkBackupStatus()"
                                class="w-full mt-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-xs font-medium active:bg-gray-200 flex items-center justify-center gap-2">
                            <i class="fas fa-info-circle"></i> Check Status
                        </button>
                        <div id="backupDetails" class="hidden mt-3 p-3 bg-gray-50 rounded-lg text-xs space-y-1"></div>
                    </div>
                </div>
            </div>

            <!-- Admin User Drill-Down Overlay -->
            <div id="adminUserDrilldown" class="fixed inset-0 bg-white z-50 hidden overflow-y-auto">
                <div class="sticky top-0 bg-white border-b border-gray-200 p-4 z-10">
                    <div class="flex items-center gap-3">
                        <button onclick="closeUserDrilldown()" class="p-2 rounded-lg hover:bg-gray-100">
                            <i class="fas fa-arrow-left text-gray-600"></i>
                        </button>
                        <div class="flex-1 min-w-0">
                            <h2 id="drilldownUserName" class="text-lg font-bold text-gray-900 truncate"></h2>
                            <p id="drilldownUserEmail" class="text-xs text-gray-500 truncate"></p>
                        </div>
                        <div class="flex gap-1.5">
                            <button onclick="findDuplicatesInDrilldown()" class="px-2.5 py-1.5 bg-orange-100 text-orange-600 rounded-lg text-[10px] font-medium"><i class="fas fa-clone mr-1"></i>Dupes</button>
                            <button id="drilldownSelectBtn" onclick="toggleDrilldownSelectMode()" class="px-2.5 py-1.5 bg-gray-100 text-gray-600 rounded-lg text-[10px] font-medium"><i class="fas fa-check-square mr-1"></i>Select</button>
                        </div>
                    </div>
                </div>
                <div class="p-4">
                    <div id="drilldownStats" class="grid grid-cols-4 gap-2 mb-4"></div>
                    <div id="drilldownContactList" class="space-y-2">
                        <p class="text-sm text-gray-400 text-center py-8"><i class="fas fa-spinner fa-spin mr-2"></i>Loading contacts...</p>
                    </div>
                </div>
                <div id="drilldownBulkActions" class="hidden sticky bottom-0 bg-white border-t border-gray-200 p-3 flex gap-2 shadow-lg">
                    <button onclick="deleteSelectedDrilldown()" class="flex-1 py-2.5 bg-red-500 text-white rounded-lg text-sm font-medium active:bg-red-600"><i class="fas fa-trash mr-1"></i>Delete Selected (<span id="drilldownSelectedCount">0</span>)</button>
                    <button onclick="toggleDrilldownSelectMode()" class="px-4 py-2.5 bg-gray-100 text-gray-600 rounded-lg text-sm font-medium">Cancel</button>
                </div>
            </div>

            <!-- Admin Contact Detail Overlay -->
            <div id="adminContactDetail" class="fixed inset-0 bg-white z-50 hidden overflow-y-auto">
                <div class="sticky top-0 bg-white border-b border-gray-200 p-4 flex items-center gap-3 z-10">
                    <button onclick="closeAdminContactDetail()" class="p-2 rounded-lg hover:bg-gray-100">
                        <i class="fas fa-arrow-left text-gray-600"></i>
                    </button>
                    <h2 class="text-lg font-bold text-gray-900">Contact Detail</h2>
                </div>
                <div id="adminContactDetailContent" class="p-4 space-y-4"></div>
            </div>

            <!-- Broadcast Banner (shown to all users at top) -->
            <div id="broadcastBanner" class="fixed top-0 left-0 right-0 z-50 hidden"></div>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 safe-area-inset-bottom z-40">
            <div class="flex justify-around items-center h-16">
                <button onclick="switchScreen('contacts')" class="nav-btn active flex flex-col items-center justify-center flex-1 h-full text-gray-600 transition">
                    <i class="fas fa-address-book text-2xl mb-1"></i>
                    <span class="text-xs">Contacts</span>
                </button>
                <button id="scanNavBtn" onclick="switchScreen('scan')" class="nav-btn flex flex-col items-center justify-center flex-1 h-full text-gray-600 transition">
                    <i class="fas fa-camera text-2xl mb-1"></i>
                    <span class="text-xs">Scan</span>
                </button>
                <button onclick="switchScreen('chat')" class="nav-btn flex flex-col items-center justify-center flex-1 h-full text-gray-600 transition">
                    <i class="fas fa-comments text-2xl mb-1"></i>
                    <span class="text-xs">AI Chat</span>
                </button>
                <button onclick="switchScreen('expo')" class="nav-btn flex flex-col items-center justify-center flex-1 h-full text-gray-600 transition">
                    <i class="fas fa-calendar-check text-2xl mb-1"></i>
                    <span class="text-xs">Expo</span>
                </button>
                <button id="adminNavBtn" onclick="switchScreen('admin')" class="nav-btn hidden flex flex-col items-center justify-center flex-1 h-full text-gray-600 transition">
                    <i class="fas fa-shield-alt text-2xl mb-1"></i>
                    <span class="text-xs">Admin</span>
                </button>
                <button onclick="switchScreen('profile')" class="nav-btn flex flex-col items-center justify-center flex-1 h-full text-gray-600 transition">
                    <i class="fas fa-user text-2xl mb-1"></i>
                    <span class="text-xs">Profile</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- ========================================
         VOICE RECORDING OVERLAY
    ======================================== -->
    <div id="voiceRecordingOverlay" class="fixed inset-0 z-60 hidden" style="background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);">
        <div class="flex flex-col items-center justify-center h-full px-6">
            <div class="bg-white rounded-2xl p-6 w-full max-w-sm text-center shadow-2xl">
                <div id="voiceContactName" class="text-sm text-gray-500 mb-2">Recording for...</div>
                <div class="mb-4">
                    <button id="voiceRecordBtn" onclick="toggleVoiceRecording()" class="w-20 h-20 rounded-full bg-red-500 text-white text-3xl flex items-center justify-center mx-auto recording-pulse">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>
                <div id="voiceTimer" class="text-2xl font-mono text-gray-700 mb-2">0:00</div>
                <div id="voiceStatus" class="text-sm text-gray-500 mb-3">Tap to start recording</div>
                <div id="voiceTranscript" class="text-sm text-gray-800 bg-gray-50 rounded-lg p-3 min-h-[60px] max-h-[120px] overflow-y-auto text-left mb-4 hidden">
                    <span class="text-gray-400 italic">Listening...</span>
                </div>
                <div class="flex gap-3">
                    <button onclick="cancelVoiceRecording()" class="flex-1 py-3 rounded-lg bg-gray-100 text-gray-600 font-medium active:bg-gray-200">Cancel</button>
                    <button id="voiceSaveBtn" onclick="saveVoiceNote()" class="flex-1 py-3 rounded-lg bg-purple-600 text-white font-medium active:bg-purple-700 hidden">Save Note</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
         CONTACT DETAIL VIEW (slide-in)
    ======================================== -->
    <div id="contactDetailView" class="fixed inset-0 z-45 bg-white hidden">
        <div id="contactDetailContent" class="h-full overflow-y-auto">
            <!-- Populated by openContactDetail() -->
        </div>
    </div>

    <!-- ========================================
         BOTTOM SHEET - Add/Edit Contact
    ======================================== -->
    <div id="contactSheet" class="fixed inset-0 z-50 hidden">
        <!-- Backdrop -->
        <div class="backdrop absolute inset-0 bg-black/50" onclick="closeContactSheet()"></div>

        <!-- Sheet Content -->
        <div class="sheet-content absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl max-h-[90vh] flex flex-col transform translate-y-full transition-transform duration-300 slide-up">
            <!-- Handle (for visual affordance) -->
            <div class="flex justify-center py-3 border-b border-gray-200">
                <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
            </div>

            <!-- Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                <h2 id="sheetTitle" class="text-xl font-semibold">Add Contact</h2>
                <button onclick="closeContactSheet()" class="p-2 text-gray-400 active:bg-gray-100 rounded-lg transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Alert Container -->
            <div id="modalAlert" class="px-6 pt-2"></div>

            <!-- Scrollable Form -->
            <form id="contactForm" onsubmit="handleContactSubmit(event)" class="flex-1 overflow-y-auto p-6 space-y-5">
                <input type="hidden" id="contactId">

                <!-- Contact Info Section -->
                <div class="space-y-4">
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Contact Info</p>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                        <input type="text" id="contactName" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50 focus:bg-white transition">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                        <input type="email" id="contactEmail" inputmode="email" autocomplete="email" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50 focus:bg-white transition">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone *</label>
                        <input type="tel" id="contactPhone" inputmode="tel" autocomplete="tel" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50 focus:bg-white transition">
                    </div>
                </div>

                <!-- Professional Section -->
                <div class="space-y-4">
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Professional</p>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Company</label>
                        <input type="text" id="contactCompany" autocomplete="organization"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50 focus:bg-white transition">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">LinkedIn</label>
                        <input type="url" id="contactLinkedin" inputmode="url"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50 focus:bg-white transition"
                               placeholder="https://linkedin.com/in/username">
                    </div>
                </div>

                <!-- Notes Section -->
                <div class="space-y-4">
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Notes</p>
                    <div>
                        <textarea id="contactNotes" rows="3"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50 focus:bg-white transition resize-none"
                                  placeholder="Add notes about this contact..."></textarea>
                    </div>
                </div>

                <!-- Submit Button (sticky at bottom) -->
                <div class="sticky bottom-0 bg-white pt-4 pb-safe-area">
                    <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-lg font-semibold active:bg-blue-700 transition touch-feedback">
                        Save Contact
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ========================================
         BOTTOM SHEET - Settings
    ======================================== -->
    <div id="settingsSheet" class="fixed inset-0 z-50 hidden">
        <div class="backdrop absolute inset-0 bg-black/50" onclick="closeSettingsSheet()"></div>
        <div class="sheet-content absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl max-h-[90vh] flex flex-col transform translate-y-full transition-transform duration-300 slide-up">
            <div class="flex justify-center py-3 border-b border-gray-200">
                <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
            </div>
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                <h2 id="settingsSheetTitle" class="text-xl font-semibold">Settings</h2>
                <button onclick="closeSettingsSheet()" class="p-2 text-gray-400 active:bg-gray-100 rounded-lg transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="settingsSheetBody" class="flex-1 overflow-y-auto p-6 space-y-5">
                <!-- Populated dynamically -->
            </div>
        </div>
    </div>

    <!-- ========================================
         JAVASCRIPT
    ======================================== -->
    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            API_BASE_URL: window.location.hostname === 'localhost'
                ? 'http://localhost:8000'
                : 'https://event-scout-production.up.railway.app',
            API_KEY: 'OGibuBdW6KP52UMTpv8g46Zs37g47d9SGv4w21W-o6s'
        };

        // ==================== NETWORK RESILIENCE ====================
        const NETWORK = { TIMEOUT_MS: 60000, MAX_RETRIES: 1, RETRY_DELAY_MS: 2000 };

        function getNetworkErrorMessage(error) {
            if (!navigator.onLine) return 'You appear to be offline. Please check your network connection.';
            if (error.name === 'AbortError') return 'Request timed out. Please check your connection and try again.';
            if (error.message?.includes('Failed to fetch') || error.message?.includes('NetworkError'))
                return 'Cannot reach server. Please check your internet connection.';
            return 'Connection error: ' + (error.message || 'Unknown error');
        }

        const _nativeFetch = window.fetch.bind(window);
        async function resilientFetch(url, options = {}, retries = NETWORK.MAX_RETRIES) {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), NETWORK.TIMEOUT_MS);
            try {
                const response = await _nativeFetch(url, { ...options, signal: controller.signal });
                clearTimeout(timeout);
                return response;
            } catch (error) {
                clearTimeout(timeout);
                if (retries > 0 && (error.name === 'AbortError' || error.name === 'TypeError')) {
                    console.warn(`[NET] Retry ${NETWORK.MAX_RETRIES - retries + 1}/${NETWORK.MAX_RETRIES} for ${url.split('?')[0]}`);
                    await new Promise(r => setTimeout(r, NETWORK.RETRY_DELAY_MS));
                    return resilientFetch(url, options, retries - 1);
                }
                error.userMessage = getNetworkErrorMessage(error);
                throw error;
            }
        }

        // Offline/online detection
        function showOfflineBanner() {
            let banner = document.getElementById('offlineBanner');
            if (!banner) {
                banner = document.createElement('div');
                banner.id = 'offlineBanner';
                banner.className = 'fixed top-0 left-0 right-0 bg-red-600 text-white text-center py-2 text-sm font-medium z-[9999]';
                banner.textContent = 'You are offline — some features may not work';
                document.body.prepend(banner);
            }
            banner.classList.remove('hidden');
        }
        function hideOfflineBanner() {
            const banner = document.getElementById('offlineBanner');
            if (banner) banner.classList.add('hidden');
        }
        window.addEventListener('offline', showOfflineBanner);
        window.addEventListener('online', hideOfflineBanner);
        if (!navigator.onLine) showOfflineBanner();

        // ==================== STATE MANAGEMENT ====================
        const AppState = {
            currentUser: null,
            contacts: [],
            activeScreen: 'contacts',
            editingContactId: null,
            userProfile: {},
            teamModeEnabled: false,
            _voiceContactId: null,
            _voiceTranscript: '',
            _voiceAudioBlob: null,
        };

        // ==================== INITIALIZATION ====================
        async function validateUserSession() {
            /** Validate that the current user_id exists in database. Prevents foreign key errors. */
            if (!AppState.currentUser || !AppState.currentUser.user_id) {
                return false;
            }

            try {
                const response = await resilientFetch(
                    `${CONFIG.API_BASE_URL}/user/validate?user_id=${encodeURIComponent(AppState.currentUser.user_id)}`,
                    { method: 'GET', headers: { 'Content-Type': 'application/json' } }
                );

                if (!response.ok) {
                    console.error('[VALIDATE] User validation failed:', response.status);
                    return false;
                }

                const data = await response.json();
                if (data.valid === true) {
                    console.log('[VALIDATE] User session valid:', data.user_id);
                    return true;
                } else {
                    console.error('[VALIDATE] User not found in database:', data.message);
                    return false;
                }
            } catch (error) {
                console.error('[VALIDATE] Validation error:', error);
                // If validation fails due to network, assume valid to avoid blocking user
                return true;
            }
        }

        window.addEventListener('DOMContentLoaded', async () => {
            // Check for saved session FIRST (instant, no network call)
            const savedUser = localStorage.getItem('eventScoutUser');
            if (savedUser) {
                AppState.currentUser = JSON.parse(savedUser);

                // Show dashboard IMMEDIATELY — don't block on network
                showDashboard();

                // Validate in background — only force re-login if user truly doesn't exist
                validateUserSession().then(isValid => {
                    if (!isValid) {
                        console.log('[INIT] User not found in DB, forcing re-login');
                        AppState.currentUser = null;
                        localStorage.removeItem('eventScoutUser');
                        AppState.contacts = [];
                        document.getElementById('mainApp').classList.add('hidden');
                        document.getElementById('authScreen').classList.remove('hidden');
                        showAlert('authAlert', 'Your session has expired. Please log in again.', 'error');
                    }
                });
            } else {
                // No saved user — check connectivity for login screen
                try {
                    await resilientFetch(`${CONFIG.API_BASE_URL}/health/`, { method: 'GET' });
                    console.log('[INIT] API connectivity confirmed');
                } catch (err) {
                    console.error('[INIT] API connectivity check failed:', err);
                    showAlert('authAlert', 'Cannot connect to server. Check internet and refresh.', 'error');
                }
            }

            // Unregister stale service workers that may interfere with requests
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(reg => { reg.unregister(); console.log('[SW] Unregistered stale service worker'); });
                });
            }
        });

        // ==================== AUTH FUNCTIONS ====================
        function switchAuthTab(tab) {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const tabs = document.querySelectorAll('.auth-tab');

            tabs.forEach(t => {
                t.classList.remove('active', 'text-blue-600', 'border-blue-600');
                t.classList.add('text-gray-600', 'border-transparent');
            });

            if (tab === 'login') {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                tabs[0].classList.add('active', 'text-blue-600', 'border-blue-600');
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                tabs[1].classList.add('active', 'text-blue-600', 'border-blue-600');
            }

            document.getElementById('authAlert').innerHTML = '';
        }

        async function handleLogin(event) {
            event.preventDefault();

            const btn = event.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Signing in...';

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await resilientFetch(`${CONFIG.API_BASE_URL}/login/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok && data.status === 'success') {
                    AppState.currentUser = {
                        user_id: data.user_id,
                        name: data.name,
                        email: data.email,
                        is_admin: data.is_admin || false
                    };
                    localStorage.setItem('eventScoutUser', JSON.stringify(AppState.currentUser));
                    showAlert('authAlert', '✓ Login successful!', 'success');
                    setTimeout(() => showDashboard(), 500);
                } else {
                    showAlert('authAlert', data.detail || 'Login failed', 'error');
                }
            } catch (error) {
                showAlert('authAlert', error.userMessage || 'Network error. Please try again.', 'error');
                console.error('Login error:', error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function handleRegister(event) {
            event.preventDefault();

            const btn = event.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating account...';

            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            try {
                const response = await resilientFetch(`${CONFIG.API_BASE_URL}/register/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password })
                });

                const data = await response.json();

                if (response.ok && data.status === 'success') {
                    showAlert('authAlert', '✓ Registration successful! Logging you in...', 'success');
                    AppState.currentUser = {
                        user_id: data.user_id,
                        name: data.name,
                        email: data.email,
                        is_admin: data.is_admin || false
                    };
                    localStorage.setItem('eventScoutUser', JSON.stringify(AppState.currentUser));
                    setTimeout(() => showDashboard(), 1000);
                } else {
                    showAlert('authAlert', data.detail || 'Registration failed', 'error');
                }
            } catch (error) {
                showAlert('authAlert', error.userMessage || 'Network error. Please try again.', 'error');
                console.error('Register error:', error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('eventScoutUser');
                AppState.currentUser = null;
                AppState.contacts = [];
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('authScreen').classList.remove('hidden');
            }
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling.querySelector('i');

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        // ==================== DASHBOARD FUNCTIONS ====================
        async function showDashboard() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userName').textContent = AppState.currentUser.name;
            document.getElementById('profileName').textContent = AppState.currentUser.name;
            document.getElementById('profileEmail').textContent = AppState.currentUser.email;
            document.getElementById('profileInitial').textContent = AppState.currentUser.name.charAt(0).toUpperCase();

            // Show/hide nav buttons based on admin status
            const adminBtn = document.getElementById('adminNavBtn');
            const scanBtn = document.getElementById('scanNavBtn');
            if (AppState.currentUser.is_admin) {
                adminBtn.classList.remove('hidden');
                scanBtn.classList.add('hidden');  // Admin at desktop doesn't need scan
            } else {
                adminBtn.classList.add('hidden');
                scanBtn.classList.remove('hidden');
            }

            loadContacts();
            await loadUserProfile();  // Must complete before expo can read event name
            loadDigitalCard();
            checkBroadcasts();  // Show any admin broadcasts
            // Poll for broadcasts every 30 seconds
            setInterval(() => { if (AppState.currentUser) checkBroadcasts(); }, 30000);

            // Admin defaults to admin dashboard as home screen
            if (AppState.currentUser.is_admin) {
                switchScreen('admin');
            }
        }

        async function switchScreen(screenName) {
            // Close any open contact detail overlay
            closeContactDetail();

            // Stop camera if leaving scan screen
            if (AppState.activeScreen === 'scan' && cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }

            // Stop admin auto-refresh if leaving admin screen
            if (AppState.activeScreen === 'admin') {
                stopAdminAutoRefresh();
            }

            // Hide all content screens
            document.querySelectorAll('.content-screen').forEach(s => {
                s.classList.add('hidden');
                s.classList.remove('fade-in');
            });

            // Show target screen with fade animation
            const targetScreen = document.getElementById(`${screenName}Screen`);
            targetScreen.classList.remove('hidden');
            void targetScreen.offsetWidth; // Force reflow to restart animation
            targetScreen.classList.add('fade-in');

            // Update nav button states
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active', 'text-blue-600');
                btn.classList.add('text-gray-600');
            });

            // Highlight the correct nav button
            const navMap = { contacts: 0, scan: 1, chat: 2, expo: 3, admin: 4, profile: 5 };
            const navBtns = document.querySelectorAll('.nav-btn');
            const idx = navMap[screenName];
            if (idx !== undefined && navBtns[idx]) {
                navBtns[idx].classList.add('active', 'text-blue-600');
                navBtns[idx].classList.remove('text-gray-600');
            }

            // Update app state
            AppState.activeScreen = screenName;

            // Update URL (for back button)
            history.pushState({ screen: screenName }, '', `#${screenName}`);

            // Initialize screen-specific features
            if (screenName === 'profile') {
                document.getElementById('totalContacts').textContent = AppState.contacts.length;
                loadDashboardStats();
                loadDigitalCard();
            } else if (screenName === 'scan') {
                // Initialize camera and reset bulk scan counter
                scanSessionCount = 0;
                scanQueue.length = 0;
                document.getElementById('scanCounter').classList.add('hidden');
                document.getElementById('bulkScanDone').classList.add('hidden');
                document.getElementById('pendingScanBadge').classList.add('hidden');
                const scanFeedEl = document.getElementById('scanFeed');
                if (scanFeedEl) scanFeedEl.innerHTML = '';
                initCamera();
            } else if (screenName === 'chat') {
                // Load chat history when entering chat screen
                loadChatHistory();
                // Show team mode toggle for admins
                const teamBtn = document.getElementById('teamModeBtn');
                if (teamBtn && AppState.currentUser?.is_admin) teamBtn.classList.remove('hidden');
            } else if (screenName === 'expo') {
                // Ensure profile is loaded before reading event name (fixes timing issue for regular users)
                try {
                    if (!AppState.userProfile || Object.keys(AppState.userProfile).length === 0) {
                        await loadUserProfile();
                    }
                } catch (e) { console.warn('[EXPO] Profile load failed, using defaults:', e); }
                if (AppState.userProfile && !AppState.userProfile.current_event_name) {
                    showToast('Tip: Set your event in Profile for best results', 'info');
                }
                // Always load exhibitors regardless of profile state
                console.log('[EXPO] Loading exhibitors for user:', AppState.currentUser?.user_id, 'event:', AppState.userProfile?.current_event_name || 'WHX Dubai 2026 (default)');
                loadExhibitors();
                refreshEventFiles();
            } else if (screenName === 'admin') {
                loadAdminDashboard();
                startAdminAutoRefresh();
                refreshAdminFiles();
                loadBroadcastHistory();
            }
        }

        // ==================== CONTACT FUNCTIONS ====================
        async function loadContacts() {
            const contactsList = document.getElementById('contactsList');
            contactsList.innerHTML = [1,2,3,4,5].map(() => `
                <div class="bg-white rounded-xl shadow-sm p-4 mb-2 mx-2 animate-pulse">
                    <div class="flex gap-3">
                        <div class="w-12 h-12 bg-gray-200 rounded-full flex-shrink-0"></div>
                        <div class="flex-1 space-y-2 py-1">
                            <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                            <div class="h-3 bg-gray-200 rounded w-1/2"></div>
                            <div class="h-3 bg-gray-100 rounded w-2/3"></div>
                        </div>
                    </div>
                </div>
            `).join('');

            try {
                // Admin sees ALL contacts from all team members; regular users see only their own
                const url = AppState.currentUser.is_admin
                    ? `${CONFIG.API_BASE_URL}/admin/contacts?user_id=${AppState.currentUser.user_id}&limit=500`
                    : `${CONFIG.API_BASE_URL}/list_contacts/?user_id=${AppState.currentUser.user_id}`;

                const response = await resilientFetch(url, {
                    headers: { 'X-API-Key': CONFIG.API_KEY }
                });

                const data = await response.json();

                if (response.ok && data.status === 'success') {
                    AppState.contacts = data.contacts;
                    renderContacts(AppState.contacts);
                    renderHotLeads();
                } else {
                    contactsList.innerHTML = `<div class="p-6 text-center text-red-500">Failed to load contacts</div>`;
                }
            } catch (error) {
                contactsList.innerHTML = `<div class="p-6 text-center text-red-500">${error.userMessage || 'Network error. Please try again.'}</div>`;
                console.error('Load contacts error:', error);
            }
        }

        function getAvatarClass(name) {
            let hash = 0;
            for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
            return 'avatar-gradient-' + (Math.abs(hash) % 8);
        }

        function renderContacts(contacts) {
            const contactsList = document.getElementById('contactsList');

            if (contacts.length === 0) {
                contactsList.innerHTML = `
                    <div class="p-12 text-center text-gray-400">
                        <i class="fas fa-address-book text-6xl mb-4"></i>
                        <p class="text-lg font-medium">No contacts yet</p>
                        <p class="text-sm mt-2">Tap + to add or scan your first contact</p>
                    </div>
                `;
                return;
            }

            contactsList.innerHTML = contacts.map(contact => {
                const hasNotes = contact.notes && contact.notes.trim() && contact.notes !== 'N/A';
                const hasLinks = contact.links && contact.links.length > 0;
                const company = contact.company_name && contact.company_name !== 'N/A' ? contact.company_name : '';
                const escapedName = contact.name.replace(/'/g, "\\'");
                const score = contact.lead_score;
                const temp = contact.lead_temperature;
                const scoreColor = temp === 'hot' ? 'bg-red-500' : temp === 'warm' ? 'bg-orange-400' : temp === 'cold' ? 'bg-gray-400' : '';

                return `
                <div class="contact-card bg-white rounded-xl shadow-sm active:shadow-md mb-2 mx-2 transition-all duration-200" data-id="${contact.id}" onclick="openContactDetail('${contact.id}')">
                    <div class="flex items-start p-4 gap-3">
                        <!-- Avatar with score badge -->
                        <div class="relative flex-shrink-0 mt-0.5">
                            ${contact.photo_base64
                                ? `<img src="data:image/jpeg;base64,${contact.photo_base64}" class="w-12 h-12 rounded-full object-cover" alt="${contact.name}">`
                                : `<div class="w-12 h-12 rounded-full ${getAvatarClass(contact.name)} flex items-center justify-center text-white font-bold text-lg">
                                    ${contact.name.charAt(0).toUpperCase()}
                                </div>`}
                            ${score != null ? `<div class="absolute -top-1 -right-1 w-6 h-6 rounded-full ${scoreColor} text-white text-[10px] flex items-center justify-center font-bold shadow-sm">${score}</div>` : ''}
                        </div>

                        <!-- Info -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 flex-wrap">
                                <h3 class="font-semibold text-gray-900 truncate">${contact.name}</h3>
                                ${contact.source === 'scan' ? '<span class="text-xs bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded-full">scanned</span>' : ''}
                                ${temp === 'hot' ? '<span class="text-xs bg-red-100 text-red-600 px-1.5 py-0.5 rounded-full">hot</span>' : ''}
                                ${AppState.currentUser.is_admin && contact.user_name ? `<span class="text-xs bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded-full">${escapeHtml(contact.user_name)}</span>` : ''}
                            </div>
                            ${company ? `<p class="text-sm font-medium text-gray-600 truncate">${company}</p>` : ''}
                            <div class="flex items-center gap-3 mt-1">
                                ${contact.email && contact.email !== 'N/A' ? `<span class="text-xs text-gray-400 truncate"><i class="fas fa-envelope mr-1"></i>${contact.email}</span>` : ''}
                            </div>
                            ${hasNotes ? `<p class="text-xs text-gray-400 italic mt-1 truncate"><i class="fas fa-sticky-note mr-1"></i>${contact.notes.substring(0, 60)}${contact.notes.length > 60 ? '...' : ''}</p>` : ''}
                            ${hasLinks ? `<div class="flex gap-1 mt-1">${contact.links.slice(0, 2).map(l => `<span class="text-xs bg-blue-50 text-blue-500 px-1.5 py-0.5 rounded">${l.label || 'Link'}</span>`).join('')}${contact.links.length > 2 ? `<span class="text-xs text-gray-400">+${contact.links.length - 2}</span>` : ''}</div>` : ''}
                        </div>

                        <!-- Quick Actions -->
                        <div class="flex flex-col gap-1 flex-shrink-0" onclick="event.stopPropagation()">
                            <button onclick="editContact('${contact.id}')" class="w-10 h-10 flex items-center justify-center text-gray-400 active:bg-blue-50 active:text-blue-600 rounded-lg transition-colors" title="Edit">
                                <i class="fas fa-pen text-sm"></i>
                            </button>
                            <button onclick="viewContactQR('${contact.id}')" class="w-10 h-10 flex items-center justify-center text-gray-400 active:bg-purple-50 active:text-purple-600 rounded-lg transition-colors" title="QR">
                                <i class="fas fa-qrcode text-sm"></i>
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function renderHotLeads() {
            const hotContacts = AppState.contacts
                .filter(c => c.lead_temperature === 'hot')
                .sort((a, b) => (b.lead_score || 0) - (a.lead_score || 0))
                .slice(0, 5);

            const banner = document.getElementById('hotLeadsBanner');
            if (hotContacts.length === 0) {
                banner.classList.add('hidden');
                return;
            }

            banner.classList.remove('hidden');
            const container = document.getElementById('hotLeadsScroll');
            container.innerHTML = hotContacts.map(c => `
                <div onclick="openContactDetail('${c.id}')"
                     class="flex-shrink-0 bg-white/20 backdrop-blur-sm rounded-lg p-3 min-w-[140px] cursor-pointer active:bg-white/30">
                    <div class="flex items-center gap-2 mb-1">
                        ${c.photo_base64
                            ? `<img src="data:image/jpeg;base64,${c.photo_base64}" class="w-8 h-8 rounded-full object-cover">`
                            : `<div class="w-8 h-8 rounded-full bg-white/30 flex items-center justify-center text-white text-sm font-bold">
                                ${c.name.charAt(0)}
                            </div>`}
                        <span class="text-white font-bold text-lg">${c.lead_score || '?'}</span>
                    </div>
                    <p class="text-white text-sm font-medium truncate">${c.name}</p>
                    <p class="text-white/70 text-xs truncate">${c.company_name || 'N/A'}</p>
                </div>
            `).join('');
        }

        function findLinkedIn(name, company) {
            let keywords = name || '';
            if (company && company !== 'N/A') keywords += ' ' + company;
            const searchUrl = 'https://www.linkedin.com/search/results/people/?keywords=' + encodeURIComponent(keywords);
            window.open(searchUrl, '_blank');
            showToast('Opening LinkedIn search...', 'info');
        }

        function generateContactVCard(contact) {
            const lines = ['BEGIN:VCARD', 'VERSION:3.0'];
            if (contact.name && contact.name !== 'N/A') {
                const parts = contact.name.split(' ');
                const first = parts[0] || '';
                const last = parts.slice(1).join(' ') || '';
                lines.push('N:' + last + ';' + first + ';;;');
                lines.push('FN:' + contact.name);
            }
            if (contact.company_name && contact.company_name !== 'N/A') lines.push('ORG:' + contact.company_name);
            if (contact.email && contact.email !== 'N/A') lines.push('EMAIL;TYPE=INTERNET:' + contact.email);
            if (contact.phone && contact.phone !== 'N/A') lines.push('TEL;TYPE=CELL:' + contact.phone);
            if (contact.linkedin && contact.linkedin !== 'N/A') {
                const url = contact.linkedin.startsWith('http') ? contact.linkedin : 'https://' + contact.linkedin;
                lines.push('URL:' + url);
            }
            if (contact.photo_base64) {
                lines.push('PHOTO;ENCODING=b;TYPE=JPEG:' + contact.photo_base64);
            }
            lines.push('END:VCARD');
            return lines.join('\r\n');
        }

        function saveContactToPhone(contactId) {
            const contact = AppState.contacts.find(c => c.id === contactId);
            if (!contact) { showToast('Contact not found', 'error'); return; }
            const vcard = generateContactVCard(contact);
            const blob = new Blob([vcard], { type: 'text/vcard' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = (contact.name || 'contact').replace(/\s+/g, '_') + '.vcf';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Opening contact save dialog...', 'info');
        }

        function viewContactQR(contactId) {
            const contact = AppState.contacts.find(c => c.id === contactId);
            if (!contact) return;

            // Create QR modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70';
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };

            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-6 max-w-sm w-full">
                    <div class="text-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-900">${contact.name}</h3>
                        <p class="text-sm text-gray-500">${contact.company_name || 'No company'}</p>
                    </div>
                    ${contact.qr_base64 ? `
                        <img src="data:image/png;base64,${contact.qr_base64}"
                             alt="QR Code"
                             class="w-full rounded-lg border-2 border-gray-200 mb-4">
                        <p class="text-xs text-gray-500 text-center mb-4">Scan to save contact</p>
                    ` : '<p class="text-center text-gray-500 py-8">QR code not available</p>'}
                    <button onclick="saveContactToPhone('${contact.id}')"
                            class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold active:bg-blue-700 mb-2">
                        <i class="fas fa-address-book mr-2"></i>Save to Phone
                    </button>
                    <button onclick="this.closest('.fixed').remove()"
                            class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold active:bg-gray-300">
                        Close
                    </button>
                </div>
            `;

            document.body.appendChild(modal);
        }

        let searchTimeout;
        function handleSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const query = document.getElementById('searchInput').value.toLowerCase().trim();

                if (!query) {
                    renderContacts(AppState.contacts);
                    return;
                }

                // Multi-field search with relevance scoring
                const results = AppState.contacts.map(contact => {
                    let score = 0;

                    // Exact match bonus
                    if (contact.name.toLowerCase().includes(query)) score += 10;
                    if (contact.email.toLowerCase().includes(query)) score += 8;
                    if ((contact.company_name || '').toLowerCase().includes(query)) score += 6;
                    if (contact.phone.includes(query)) score += 5;
                    if ((contact.notes || '').toLowerCase().includes(query)) score += 4;

                    // Starts-with bonus
                    if (contact.name.toLowerCase().startsWith(query)) score += 5;
                    if ((contact.company_name || '').toLowerCase().startsWith(query)) score += 3;

                    return { contact, score };
                })
                .filter(r => r.score > 0)
                .sort((a, b) => b.score - a.score)
                .map(r => r.contact);

                renderContacts(results);

                // Show search-specific empty state
                if (results.length === 0) {
                    document.getElementById('contactsList').innerHTML = `
                        <div class="p-12 text-center text-gray-400">
                            <i class="fas fa-search text-5xl mb-4 opacity-50"></i>
                            <p class="text-lg font-medium">No results for "${escapeHtml(query)}"</p>
                            <p class="text-sm mt-2">Try a different search term</p>
                            <button onclick="document.getElementById('searchInput').value='';handleSearch()" class="mt-4 px-4 py-2 bg-blue-50 text-blue-600 rounded-lg text-sm font-medium active:bg-blue-100">
                                Clear Search
                            </button>
                        </div>`;
                }
            }, 300); // 300ms debounce
        }


        // ==================== BOTTOM SHEET FUNCTIONS ====================
        function openAddContactSheet() {
            AppState.editingContactId = null;
            document.getElementById('sheetTitle').textContent = 'Add Contact';
            document.getElementById('contactForm').reset();
            document.getElementById('contactId').value = '';
            document.getElementById('modalAlert').innerHTML = '';

            const sheet = document.getElementById('contactSheet');
            sheet.classList.remove('hidden');

            // Trigger animation
            setTimeout(() => {
                sheet.querySelector('.sheet-content').style.transform = 'translateY(0)';
            }, 10);
        }

        function closeContactSheet() {
            const sheet = document.getElementById('contactSheet');
            const content = sheet.querySelector('.sheet-content');

            content.style.transform = 'translateY(100%)';

            setTimeout(() => {
                sheet.classList.add('hidden');
            }, 300); // Match transition duration
        }

        function editContact(contactId) {
            const contact = AppState.contacts.find(c => c.id === contactId);
            if (!contact) return;

            // Close detail view if open
            closeContactDetail();

            AppState.editingContactId = contactId;
            document.getElementById('sheetTitle').textContent = 'Edit Contact';
            document.getElementById('contactId').value = contactId;
            document.getElementById('contactName').value = contact.name;
            document.getElementById('contactEmail').value = contact.email;
            document.getElementById('contactPhone').value = contact.phone;
            document.getElementById('contactLinkedin').value = contact.linkedin !== 'N/A' ? contact.linkedin : '';
            document.getElementById('contactCompany').value = contact.company_name !== 'N/A' ? contact.company_name : '';
            document.getElementById('contactNotes').value = contact.notes && contact.notes !== 'N/A' ? contact.notes : '';
            document.getElementById('modalAlert').innerHTML = '';

            const sheet = document.getElementById('contactSheet');
            sheet.classList.remove('hidden');

            setTimeout(() => {
                sheet.querySelector('.sheet-content').style.transform = 'translateY(0)';
            }, 10);
        }

        async function handleContactSubmit(event) {
            event.preventDefault();

            const btn = event.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

            const contactData = {
                name: document.getElementById('contactName').value,
                email: document.getElementById('contactEmail').value,
                phone: document.getElementById('contactPhone').value,
                linkedin: document.getElementById('contactLinkedin').value || 'N/A',
                company_name: document.getElementById('contactCompany').value || 'N/A',
                notes: document.getElementById('contactNotes').value || ''
            };

            try {
                let response;

                if (AppState.editingContactId) {
                    // Update contact
                    response = await resilientFetch(
                        `${CONFIG.API_BASE_URL}/contact/${AppState.editingContactId}?user_id=${AppState.currentUser.user_id}`,
                        {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-API-Key': CONFIG.API_KEY
                            },
                            body: JSON.stringify(contactData)
                        }
                    );
                } else {
                    // Add new contact
                    response = await resilientFetch(`${CONFIG.API_BASE_URL}/add_contact/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': CONFIG.API_KEY
                        },
                        body: JSON.stringify({
                            contact: contactData,
                            user_id: AppState.currentUser.user_id
                        })
                    });
                }

                const data = await response.json();

                if (response.ok && data.status === 'success') {
                    showAlert('modalAlert', '✓ Contact saved successfully!', 'success');
                    setTimeout(() => {
                        closeContactSheet();
                        loadContacts();
                    }, 1000);
                } else {
                    showAlert('modalAlert', data.detail || 'Failed to save contact', 'error');
                }
            } catch (error) {
                showAlert('modalAlert', 'Network error', 'error');
                console.error('Save contact error:', error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function deleteContact(contactId, contactName) {
            if (!confirm(`Are you sure you want to delete ${contactName}?`)) {
                return;
            }

            try {
                const response = await resilientFetch(
                    `${CONFIG.API_BASE_URL}/contact/${contactId}?user_id=${AppState.currentUser.user_id}`,
                    {
                        method: 'DELETE',
                        headers: { 'X-API-Key': CONFIG.API_KEY }
                    }
                );

                const data = await response.json();

                if (response.ok && data.status === 'success') {
                    showToast('✓ Contact deleted', 'success');
                    loadContacts();
                } else {
                    showToast('Failed to delete contact', 'error');
                }
            } catch (error) {
                showToast('Network error', 'error');
                console.error('Delete contact error:', error);
            }
        }

        // ==================== CAMERA SCANNER FUNCTIONS ====================
        let cameraStream = null;
        let facingMode = 'environment';
        let scanSessionCount = 0; // Bulk scan counter
        let scanProcessing = false; // Prevent double-tap

        async function initCamera() {
            try {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }
                const constraints = {
                    video: {
                        facingMode: facingMode,
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                const videoElement = document.getElementById('cameraStream');
                videoElement.srcObject = cameraStream;
                document.getElementById('cameraError').classList.add('hidden');
                videoElement.classList.remove('hidden');
            } catch (error) {
                console.error('Camera initialization error:', error);

                // CRITICAL: Force clear video stream to prevent stale frames
                const videoElement = document.getElementById('cameraStream');
                if (videoElement.srcObject) {
                    videoElement.srcObject.getTracks().forEach(track => track.stop());
                    videoElement.srcObject = null;
                }

                const errorDiv = document.getElementById('cameraError');
                errorDiv.classList.remove('hidden');
                videoElement.classList.add('hidden');
                errorDiv.innerHTML = `
                    <div class="text-center text-white">
                        <i class="fas fa-camera-slash text-6xl mb-4 text-gray-400"></i>
                        <h3 class="text-xl font-semibold mb-2">Camera Not Available</h3>
                        <p class="text-sm text-gray-300 mb-6">
                            ${error.name === 'NotAllowedError' ? 'Camera permission denied. Please enable camera access in settings.' : 'Unable to access camera. Use gallery upload instead.'}
                        </p>
                        <button onclick="uploadFromGallery()" class="bg-blue-600 px-6 py-3 rounded-lg text-white font-medium">
                            <i class="fas fa-image mr-2"></i>Upload from Gallery
                        </button>
                    </div>
                `;
            }
        }

        function updateProcessStep(step) {
            for (let i = 1; i <= 4; i++) {
                const el = document.getElementById(`processStep${i}`);
                const icon = el.querySelector('.w-8');
                if (i < step) {
                    el.classList.remove('text-gray-500');
                    el.classList.add('text-green-400');
                    icon.classList.remove('bg-gray-700', 'bg-blue-500');
                    icon.classList.add('bg-green-500');
                } else if (i === step) {
                    el.classList.remove('text-gray-500');
                    el.classList.add('text-white');
                    icon.classList.remove('bg-gray-700');
                    icon.classList.add('bg-blue-500');
                } else {
                    el.classList.remove('text-white', 'text-green-400');
                    el.classList.add('text-gray-500');
                    icon.classList.remove('bg-blue-500', 'bg-green-500');
                    icon.classList.add('bg-gray-700');
                }
            }
        }

        function showProcessing() {
            updateProcessStep(1);
            document.getElementById('processingOverlay').classList.remove('hidden');
            document.getElementById('processingOverlay').classList.add('flex');
        }

        function hideProcessing() {
            document.getElementById('processingOverlay').classList.add('hidden');
            document.getElementById('processingOverlay').classList.remove('flex');
        }

        function updateScanCounter() {
            const counter = document.getElementById('scanCounter');
            const text = document.getElementById('scanCountText');
            if (scanSessionCount > 0) {
                counter.classList.remove('hidden');
                text.textContent = `${scanSessionCount} scanned`;
                document.getElementById('bulkScanDone').classList.remove('hidden');
            }
        }

        const scanQueue = []; // { id, status: 'uploading'|'done'|'error'|'duplicate', name, ts }
        let scanQueueIdCounter = 0;
        let scanImageQueue = []; // Sequential processing queue: { blob, filename, scanId }
        let isDrainingScanQueue = false;

        function addToScanQueue() {
            const id = ++scanQueueIdCounter;
            scanQueue.push({ id, status: 'uploading', name: null, ts: Date.now() });
            renderScanFeed();
            return id;
        }

        function updateScanQueueEntry(id, status, name) {
            const entry = scanQueue.find(e => e.id === id);
            if (entry) { entry.status = status; entry.name = name || entry.name; }
            renderScanFeed();
            // Auto-remove completed/duplicate entries after 4s
            if (status === 'done' || status === 'duplicate') {
                setTimeout(() => {
                    const idx = scanQueue.findIndex(e => e.id === id);
                    if (idx !== -1) scanQueue.splice(idx, 1);
                    renderScanFeed();
                }, 4000);
            }
            // Auto-remove errors after 6s
            if (status === 'error') {
                setTimeout(() => {
                    const idx = scanQueue.findIndex(e => e.id === id);
                    if (idx !== -1) scanQueue.splice(idx, 1);
                    renderScanFeed();
                }, 6000);
            }
        }

        function renderScanFeed() {
            const feed = document.getElementById('scanFeed');
            if (!feed) return;

            const total = scanQueue.length + scanSessionCount;
            const done = scanQueue.filter(e => e.status === 'done').length + scanSessionCount;
            const uploading = scanQueue.filter(e => e.status === 'uploading').length;

            // Update the top-left badge with progress
            const badge = document.getElementById('pendingScanBadge');
            const badgeText = document.getElementById('pendingScanText');
            if (uploading > 0) {
                badge.classList.remove('hidden');
                badgeText.textContent = `${done}/${total} done`;
            } else {
                badge.classList.add('hidden');
            }

            // Render individual status pills
            feed.innerHTML = scanQueue.map(entry => {
                const icons = { uploading: 'fa-spinner fa-spin', done: 'fa-check', error: 'fa-times', duplicate: 'fa-clone' };
                const colors = { uploading: 'bg-blue-500/90', done: 'bg-green-500/90', error: 'bg-red-500/90', duplicate: 'bg-yellow-500/90' };
                const labels = {
                    uploading: 'Processing...',
                    done: entry.name ? `${entry.name} saved` : 'Saved',
                    error: entry.name || 'Failed',
                    duplicate: entry.name ? `Already saved: ${entry.name}` : 'Duplicate'
                };
                const fadeClass = (entry.status === 'done' || entry.status === 'duplicate') ? 'opacity-90' : '';
                return `<div class="flex items-center gap-2 ${colors[entry.status]} text-white px-3 py-1.5 rounded-full text-xs font-medium shadow-lg ${fadeClass}" style="transition: opacity 0.5s">
                    <i class="fas ${icons[entry.status]} text-[10px]"></i>
                    <span class="truncate max-w-[200px]">${labels[entry.status]}</span>
                </div>`;
            }).join('');
        }

        async function drainScanQueue() {
            if (isDrainingScanQueue) return;
            isDrainingScanQueue = true;

            while (scanImageQueue.length > 0) {
                const { blob, filename, scanId } = scanImageQueue.shift();
                console.log(`[SCAN] Processing queued image #${scanId} (${scanImageQueue.length} remaining)`);
                try {
                    await processImageUploadWithId(blob, filename, scanId);
                } catch (error) {
                    console.error(`[SCAN] Queue item #${scanId} failed:`, error);
                    updateScanQueueEntry(scanId, 'error', 'Processing failed');
                }
            }

            isDrainingScanQueue = false;
            // Refresh contacts ONCE after all scans complete
            if (scanSessionCount > 0) {
                loadContacts();
            }
        }

        async function processImageUpload(blob, filename) {
            /** Backward-compatible wrapper for gallery uploads. */
            const scanId = addToScanQueue();
            return processImageUploadWithId(blob, filename, scanId);
        }

        async function processImageUploadWithId(blob, filename, scanId) {
            /** Core upload function - processes one image with pre-created scan bubble. */
            console.log('[SCAN] Blob size:', blob.size, 'bytes, type:', blob.type);
            if (!blob || blob.size < 1000) {
                updateScanQueueEntry(scanId, 'error', 'Image too small');
                console.error('[SCAN] Blob too small:', blob.size);
                return false;
            }

            try {
                const formData = new FormData();
                formData.append('file', blob, filename);

                const url = `${CONFIG.API_BASE_URL}/add_contact_from_image/?user_id=${encodeURIComponent(AppState.currentUser.user_id)}`;

                const response = await resilientFetch(url, {
                    method: 'POST',
                    headers: { 'X-API-Key': CONFIG.API_KEY },
                    body: formData
                });

                let data;
                try {
                    data = await response.json();
                } catch (parseError) {
                    throw new Error('Server returned invalid response.');
                }

                if (response.ok && data.status === 'duplicate') {
                    updateScanQueueEntry(scanId, 'duplicate', data.existing_name);
                    return true;
                }

                if (response.ok && data.status === 'success') {
                    const fields = data.extracted_fields || {};
                    const name = fields.name || 'Unknown';
                    const contactId = data.contact_id;
                    scanSessionCount++;
                    updateScanCounter();
                    updateScanQueueEntry(scanId, 'done', name);

                    // Trigger webhook for card acceptance (sends CookieMail)
                    if (contactId) {
                        triggerCardAcceptedWebhook(contactId, name);
                    }

                    return true;
                } else {
                    let errMsg = 'Failed to process card';
                    if (response.status === 401) {
                        errMsg = 'Session expired. Please log in again.';
                    } else if (response.status === 404) {
                        errMsg = 'User not found. Please log in again.';
                    } else if (response.status === 500) {
                        errMsg = data.detail || 'Server error. Please try again.';
                    } else if (response.status === 504) {
                        errMsg = 'AI processing timed out. Please try again.';
                    } else if (data.detail) {
                        errMsg = typeof data.detail === 'string' ? data.detail : JSON.stringify(data.detail);
                    } else if (data.message) {
                        errMsg = data.message;
                    }

                    updateScanQueueEntry(scanId, 'error', errMsg);
                    console.error('Scan error:', { status: response.status, data });
                    return false;
                }
            } catch (error) {
                let errorMessage = 'Network error';
                if (error.message && error.message.includes('Failed to fetch')) {
                    errorMessage = 'Cannot connect to server. Check your internet connection.';
                } else if (error.message) {
                    errorMessage = error.message;
                }

                updateScanQueueEntry(scanId, 'error', errorMessage);
                console.error('Upload error:', error);
                return false;
            }
        }

        async function captureBusinessCard() {
            if (scanProcessing) {
                console.log('Scan already in progress, ignoring...');
                return;
            }

            scanProcessing = true;

            const videoElement = document.getElementById('cameraStream');
            if (!videoElement.srcObject) {
                showToast('Camera not initialized. Please refresh the page.', 'error');
                scanProcessing = false;
                return;
            }

            try {
                const canvas = document.createElement('canvas');
                canvas.width = videoElement.videoWidth;
                canvas.height = videoElement.videoHeight;

                if (canvas.width === 0 || canvas.height === 0) {
                    throw new Error('Invalid video dimensions. Camera may not be ready.');
                }

                const ctx = canvas.getContext('2d');
                ctx.drawImage(videoElement, 0, 0);

                canvas.toBlob(async (blob) => {
                    if (!blob || blob.size < 1000) {
                        showToast('Failed to capture image. Please try again.', 'error');
                        scanProcessing = false;
                        return;
                    }

                    // Create a safe copy of the blob data (immune to GC of original)
                    const arrayBuffer = await blob.arrayBuffer();
                    const safeBlob = new Blob([arrayBuffer], { type: 'image/jpeg' });
                    console.log('[SCAN] Captured image:', safeBlob.size, 'bytes');

                    // Shutter flash feedback
                    const flash = document.getElementById('shutterFlash');
                    if (flash) { flash.style.opacity = '0.6'; setTimeout(() => flash.style.opacity = '0', 150); }

                    // Create "Processing..." bubble immediately (instant visual feedback)
                    const scanId = addToScanQueue();

                    // Add to sequential queue (processes one at a time)
                    scanImageQueue.push({ blob: safeBlob, filename: 'business-card.jpg', scanId });
                    console.log(`[SCAN] Queued image #${scanId} (${scanImageQueue.length} in queue)`);

                    // Start processing if not already running
                    if (!isDrainingScanQueue) drainScanQueue();

                    scanProcessing = false;
                }, 'image/jpeg', 0.92);
            } catch (error) {
                console.error('Capture error:', error);
                showToast(error.message || 'Failed to capture photo', 'error');
                scanProcessing = false;
            }
        }

        function finishBulkScan() {
            // Stop camera and go to contacts
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            scanSessionCount = 0;
            scanQueue.length = 0; // Clear scan feed
            document.getElementById('scanCounter').classList.add('hidden');
            document.getElementById('bulkScanDone').classList.add('hidden');
            document.getElementById('pendingScanBadge').classList.add('hidden');
            const feed = document.getElementById('scanFeed');
            if (feed) feed.innerHTML = '';
            switchScreen('contacts');
            loadContacts();
        }

        function uploadFromGallery() {
            document.getElementById('galleryInput').click();
        }

        async function handleGalleryUpload(event) {
            const files = Array.from(event.target.files);
            if (!files.length) return;

            // Process multiple files in sequence
            for (const file of files) {
                await processImageUpload(file, file.name);
            }

            if (files.length > 1) {
                showToast(`${scanSessionCount} cards processed!`, 'success');
            }

            // If not in camera mode, go to contacts
            if (!cameraStream) {
                loadContacts();
                if (AppState.activeScreen !== 'scan') {
                    switchScreen('contacts');
                }
            }

            event.target.value = '';
        }

        async function switchCamera() {
            facingMode = facingMode === 'environment' ? 'user' : 'environment';
            await initCamera();
        }

        // ==================== AI CHAT FUNCTIONS ====================
        let chatHistory = [];

        function loadChatHistory() {
            const saved = localStorage.getItem('eventScoutChatHistory');
            if (saved) {
                try {
                    chatHistory = JSON.parse(saved);
                    renderChatHistory();
                } catch (error) {
                    console.error('Failed to load chat history:', error);
                    chatHistory = [];
                }
            }
        }

        function saveChatHistory() {
            localStorage.setItem('eventScoutChatHistory', JSON.stringify(chatHistory));
        }

        function renderChatHistory() {
            const messagesContainer = document.getElementById('chatMessages');
            const suggestionsContainer = document.getElementById('chatSuggestions');

            if (chatHistory.length === 0) {
                messagesContainer.innerHTML = '';
                suggestionsContainer.classList.remove('hidden');
            } else {
                suggestionsContainer.classList.add('hidden');
                messagesContainer.innerHTML = chatHistory.map(msg => renderChatMessage(msg)).join('');

                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        function renderChatMessage(message) {
            const timeStr = message.timestamp ? new Date(message.timestamp).toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit'}) : '';
            if (message.role === 'user') {
                return `
                    <div class="flex justify-end">
                        <div class="bg-blue-600 text-white rounded-2xl rounded-tr-sm px-4 py-3 max-w-[80%]">
                            <p class="text-sm">${escapeHtml(message.content)}</p>
                            ${timeStr ? `<p class="text-[10px] text-white/50 mt-1 text-right">${timeStr}</p>` : ''}
                        </div>
                    </div>
                `;
            } else {
                const hasComponents = message.ui_components && message.ui_components.length > 0;
                const uiComponentsHtml = hasComponents ? renderUIComponents(message.ui_components) : '';
                const maxWidth = hasComponents ? 'max-w-[95%]' : 'max-w-[85%]';
                return `
                    <div class="flex justify-start">
                        <div class="bg-white border border-gray-200 rounded-2xl rounded-tl-sm px-4 py-3 ${maxWidth}">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fas fa-robot text-purple-600"></i>
                                <span class="text-xs font-medium text-gray-500">AI Assistant</span>
                                ${timeStr ? `<span class="text-[10px] text-gray-400 ml-auto">${timeStr}</span>` : ''}
                            </div>
                            <div class="text-sm text-gray-800 leading-relaxed">${formatAIResponse(message.content)}</div>
                            ${uiComponentsHtml}
                        </div>
                    </div>
                `;
            }
        }

        async function sendChatMessage(event) {
            event.preventDefault();

            const btn = event.target.querySelector('button[type="submit"]');
            const input = document.getElementById('chatInput');
            const query = input.value.trim();

            if (!query) return;

            btn.disabled = true;

            // Add user message to history
            chatHistory.push({ role: 'user', content: query, timestamp: Date.now() });
            renderChatHistory();

            // Clear input and reset height
            input.value = '';
            input.style.height = 'auto';

            // Show typing indicator
            const messagesContainer = document.getElementById('chatMessages');
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'flex justify-start';
            typingIndicator.id = 'typingIndicator';
            typingIndicator.innerHTML = `
                <div class="bg-gray-100 rounded-2xl rounded-tl-sm px-4 py-3">
                    <div class="flex gap-1">
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(typingIndicator);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            try {
                const response = await resilientFetch(`${CONFIG.API_BASE_URL}/converse/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': CONFIG.API_KEY
                    },
                    body: JSON.stringify({
                        user_id: AppState.currentUser.user_id,
                        query: query,
                        admin_mode: AppState.teamModeEnabled || false,
                        conversation_history: chatHistory.slice(-10).map(m => ({
                            role: m.role,
                            content: m.content
                        }))
                    })
                });

                const data = await response.json();

                // Remove typing indicator
                document.getElementById('typingIndicator')?.remove();

                if (response.ok) {
                    // Add AI response to history with UI components
                    const aiMessage = data.response || data.message || 'I found some information for you.';
                    chatHistory.push({
                        role: 'assistant',
                        content: aiMessage,
                        timestamp: Date.now(),
                        ui_components: data.ui_components || [],
                        intent: data.intent || 'chat'
                    });

                    if (data.model) {
                        document.getElementById('chatModelLabel').textContent = `Powered by ${data.model}`;
                    }

                    saveChatHistory();
                    renderChatHistory();
                } else {
                    showToast(data.detail || 'Failed to get response', 'error');
                    chatHistory.pop(); // Remove user message if failed
                    renderChatHistory();
                }
            } catch (error) {
                document.getElementById('typingIndicator')?.remove();
                showToast('Network error', 'error');
                console.error('Chat error:', error);
                chatHistory.pop();
                renderChatHistory();
            } finally {
                btn.disabled = false;
            }
        }

        function askAI(query, autoSend = false) {
            const input = document.getElementById('chatInput');
            input.value = query;
            input.focus();
            if (autoSend) {
                const form = input.closest('form');
                if (form) form.dispatchEvent(new Event('submit', { cancelable: true }));
            }
        }

        function toggleTeamMode() {
            AppState.teamModeEnabled = !AppState.teamModeEnabled;
            const btn = document.getElementById('teamModeBtn');
            if (btn) {
                btn.className = AppState.teamModeEnabled
                    ? 'px-2.5 py-1 rounded-full text-[10px] font-medium bg-white text-purple-600 active:bg-white/90 transition-all'
                    : 'px-2.5 py-1 rounded-full text-[10px] font-medium bg-white/20 text-white/80 active:bg-white/30 transition-all';
                btn.innerHTML = AppState.teamModeEnabled
                    ? '<i class="fas fa-users mr-1"></i>Team Mode ON'
                    : '<i class="fas fa-users mr-1"></i>Team Mode';
            }
            const label = document.getElementById('chatModelLabel');
            if (label) {
                label.textContent = AppState.teamModeEnabled
                    ? 'Team Mode — searching all contacts'
                    : 'Powered by Claude Opus 4.6';
            }
            showToast(AppState.teamModeEnabled ? 'Team Mode ON — queries all team contacts' : 'Team Mode OFF — your contacts only', 'info');
        }

        function clearChatHistory() {
            if (confirm('Clear all chat history?')) {
                chatHistory = [];
                saveChatHistory();
                renderChatHistory();
                showToast('Chat history cleared', 'success');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatAIResponse(text) {
            /** Convert markdown-like AI output to readable HTML. Escape first for safety. */
            let safe = escapeHtml(text);
            return safe
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/^### (.*$)/gm, '<h4 class="font-bold text-sm mt-3 mb-1 text-gray-900">$1</h4>')
                .replace(/^## (.*$)/gm, '<h3 class="font-bold text-base mt-3 mb-1 text-gray-900">$1</h3>')
                .replace(/^# (.*$)/gm, '<h3 class="font-bold text-lg mt-3 mb-1 text-gray-900">$1</h3>')
                .replace(/^- (.*$)/gm, '<div class="flex gap-2 ml-2"><span class="text-gray-400">&#8226;</span><span>$1</span></div>')
                .replace(/^(\d+)\. (.*$)/gm, '<div class="flex gap-2 ml-2"><span class="text-gray-500 font-medium">$1.</span><span>$2</span></div>')
                .replace(/\n{2,}/g, '<div class="mt-2"></div>')
                .replace(/\n/g, '<br>');
        }

        // ==================== GENERATIVE UI COMPONENTS ====================
        function renderUIComponents(components) {
            if (!components || !components.length) return '';
            return '<div class="mt-3 space-y-3">' +
                components.map(comp => {
                    switch (comp.type) {
                        case 'contact_cards': return renderContactCards(comp.data);
                        case 'exhibitor_cards': return renderExhibitorCards(comp.data);
                        case 'score_summary': return renderScoreSummary(comp.data);
                        case 'action_buttons': return renderActionButtons(comp.data);
                        case 'quick_replies': return renderQuickReplies(comp.data);
                        case 'research_card': return renderResearchCard(comp.data);
                        case 'pitch_preview': return renderPitchPreview(comp.data);
                        default: return '';
                    }
                }).join('') + '</div>';
        }

        function renderContactCards(contacts) {
            if (!contacts || !contacts.length) return '';
            return '<div class="space-y-2">' + contacts.map(c => {
                const scoreColor = c.lead_temperature === 'hot' ? 'bg-red-500' :
                                   c.lead_temperature === 'warm' ? 'bg-orange-400' : 'bg-gray-400';
                const avatar = c.photo_base64
                    ? `<img src="data:image/jpeg;base64,${c.photo_base64}" class="w-11 h-11 rounded-full object-cover">`
                    : `<span class="text-white font-bold text-lg">${(c.name || '?').charAt(0).toUpperCase()}</span>`;
                return `
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-3 cursor-pointer active:bg-gray-50 transition"
                     onclick="openContactDetail('${c.id}')">
                    <div class="flex items-center gap-3">
                        <div class="w-11 h-11 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center flex-shrink-0 overflow-hidden">
                            ${avatar}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold text-gray-900 text-sm truncate">${escapeHtml(c.name)}</p>
                            <p class="text-xs text-gray-500 truncate">${escapeHtml(c.company_name || '')}</p>
                        </div>
                        ${c.lead_score != null ? `<div class="w-8 h-8 rounded-full ${scoreColor} flex items-center justify-center text-white text-xs font-bold flex-shrink-0">${c.lead_score}</div>` : ''}
                    </div>
                    <div class="flex gap-2 mt-2 ml-14" onclick="event.stopPropagation()">
                        ${c.phone && c.phone !== 'N/A' ? `<a href="tel:${c.phone}" class="text-xs bg-green-50 text-green-600 px-2.5 py-1 rounded-full"><i class="fas fa-phone mr-1"></i>Call</a>` : ''}
                        ${c.email && c.email !== 'N/A' ? `<a href="mailto:${c.email}" class="text-xs bg-blue-50 text-blue-600 px-2.5 py-1 rounded-full"><i class="fas fa-envelope mr-1"></i>Email</a>` : ''}
                        ${c.linkedin && c.linkedin !== 'N/A' ? `<a href="${c.linkedin}" target="_blank" class="text-xs bg-indigo-50 text-indigo-600 px-2.5 py-1 rounded-full"><i class="fab fa-linkedin mr-1"></i>LinkedIn</a>` : ''}
                    </div>
                </div>`;
            }).join('') + '</div>';
        }

        function renderExhibitorCards(exhibitors) {
            if (!exhibitors || !exhibitors.length) return '';
            return '<div class="space-y-2">' + exhibitors.map(e => `
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-3">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center text-white flex-shrink-0">
                            <i class="fas fa-building text-sm"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold text-gray-900 text-sm truncate">${escapeHtml(e.name)}</p>
                            <p class="text-xs text-gray-500">${e.booth ? `Booth ${escapeHtml(e.booth)}` : ''}${e.hall ? ` | Hall ${escapeHtml(e.hall)}` : ''}${e.category ? ` | ${escapeHtml(e.category)}` : ''}</p>
                        </div>
                        ${e.country ? `<span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full flex-shrink-0">${escapeHtml(e.country)}</span>` : ''}
                    </div>
                    ${e.description ? `<p class="text-xs text-gray-600 mt-2 ml-13 line-clamp-2">${escapeHtml(e.description).substring(0, 120)}${e.description.length > 120 ? '...' : ''}</p>` : ''}
                    <div class="flex gap-2 mt-2 ml-13">
                        <button onclick="askAI('Tell me about ${escapeHtml(e.name).replace(/'/g, "\\'")} and should I visit their booth?')" class="text-xs bg-purple-50 text-purple-600 px-2.5 py-1 rounded-full"><i class="fas fa-robot mr-1"></i>Ask AI</button>
                    </div>
                </div>
            `).join('') + '</div>';
        }

        function renderScoreSummary(data) {
            if (!data) return '';
            const total = data.hot + data.warm + data.cold || 1;
            const hotPct = Math.round((data.hot / total) * 100);
            const warmPct = Math.round((data.warm / total) * 100);
            const coldPct = Math.round((data.cold / total) * 100);
            return `
            <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                <div class="flex items-center justify-between mb-3">
                    <p class="text-sm font-semibold text-gray-900">Lead Pipeline</p>
                    <span class="text-xs text-gray-400">${data.scored}/${data.total} scored</span>
                </div>
                <div class="flex gap-3 mb-3">
                    <div class="flex-1 text-center p-2 bg-red-50 rounded-lg">
                        <p class="text-lg font-bold text-red-600">${data.hot}</p>
                        <p class="text-[10px] text-red-500 uppercase font-medium">Hot</p>
                    </div>
                    <div class="flex-1 text-center p-2 bg-orange-50 rounded-lg">
                        <p class="text-lg font-bold text-orange-500">${data.warm}</p>
                        <p class="text-[10px] text-orange-400 uppercase font-medium">Warm</p>
                    </div>
                    <div class="flex-1 text-center p-2 bg-gray-50 rounded-lg">
                        <p class="text-lg font-bold text-gray-500">${data.cold}</p>
                        <p class="text-[10px] text-gray-400 uppercase font-medium">Cold</p>
                    </div>
                </div>
                <div class="h-2 rounded-full bg-gray-100 overflow-hidden flex">
                    <div class="bg-red-500" style="width:${hotPct}%"></div>
                    <div class="bg-orange-400" style="width:${warmPct}%"></div>
                    <div class="bg-gray-300" style="width:${coldPct}%"></div>
                </div>
                ${data.top_contacts && data.top_contacts.length ? `
                <div class="mt-3 space-y-1">
                    <p class="text-xs font-medium text-gray-500 uppercase">Top Leads</p>
                    ${data.top_contacts.map(c => `
                        <div class="flex items-center justify-between py-1">
                            <span class="text-sm text-gray-900 truncate">${escapeHtml(c.name || '')} <span class="text-xs text-gray-400">${escapeHtml(c.company_name || '')}</span></span>
                            <span class="text-sm font-bold ${c.lead_temperature === 'hot' ? 'text-red-600' : 'text-orange-500'}">${c.lead_score}</span>
                        </div>
                    `).join('')}
                </div>` : ''}
            </div>`;
        }

        function renderActionButtons(actions) {
            if (!actions || !actions.length) return '';
            return '<div class="flex flex-wrap gap-2">' + actions.map(a => {
                let onclick = '';
                if (a.action === 'score') {
                    onclick = `scoreContactFromChat('${a.contact_id}')`;
                } else if (a.action === 'research') {
                    const contact = AppState.contacts.find(c => c.id === a.contact_id);
                    const company = contact ? contact.company_name : '';
                    onclick = `askAI('Research ${company || a.label}', true)`;
                } else if (a.action === 'pitch') {
                    onclick = `askAI('Generate pitch for ${a.label.replace("Pitch for ", "")}', true)`;
                }
                return `<button onclick="${onclick}" class="inline-flex items-center gap-1.5 px-3 py-2 bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 text-purple-700 rounded-xl text-xs font-medium active:scale-95 transition-transform">
                    <i class="fas ${a.icon || 'fa-bolt'}"></i> ${escapeHtml(a.label)}
                </button>`;
            }).join('') + '</div>';
        }

        function renderQuickReplies(replies) {
            if (!replies || !replies.length) return '';
            return '<div class="flex flex-wrap gap-1.5 pt-1">' + replies.map(r =>
                `<button onclick="askAI('${escapeHtml(r).replace(/'/g, "\\'")}', true)" class="text-xs px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-full transition active:bg-gray-300 border border-gray-200">${escapeHtml(r)}</button>`
            ).join('') + '</div>';
        }

        function renderResearchCard(data) {
            if (!data) return '';
            return `
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl border border-blue-200 p-4">
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-8 h-8 rounded-lg bg-blue-500 flex items-center justify-center">
                        <i class="fas fa-microscope text-white text-sm"></i>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-900">Company Research</p>
                        <p class="text-xs text-gray-500">${escapeHtml(data.company || '')}</p>
                    </div>
                </div>
                <div class="flex gap-2 mt-2">
                    <button onclick="saveResearchToContact('${data.contact_id}')" class="text-xs bg-blue-600 text-white px-3 py-1.5 rounded-lg flex items-center gap-1">
                        <i class="fas fa-save"></i> Save to Contact
                    </button>
                    <button onclick="askAI('Generate pitch for ${escapeHtml(data.contact_name || '').replace(/'/g, "\\'")}', true)" class="text-xs bg-purple-600 text-white px-3 py-1.5 rounded-lg flex items-center gap-1">
                        <i class="fas fa-file-powerpoint"></i> Generate Pitch
                    </button>
                </div>
            </div>`;
        }

        function renderPitchPreview(data) {
            if (!data) return '';
            return `
            <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl border border-purple-200 p-4">
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-8 h-8 rounded-lg bg-purple-500 flex items-center justify-center">
                        <i class="fas fa-file-powerpoint text-white text-sm"></i>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-900">Pitch Deck Generated</p>
                        <p class="text-xs text-gray-500">For ${escapeHtml(data.contact_name || '')} at ${escapeHtml(data.company || '')}</p>
                    </div>
                </div>
                <div class="flex gap-2 mt-2">
                    <button onclick="downloadPitchDeck('${data.contact_id}')" class="text-xs bg-purple-600 text-white px-3 py-1.5 rounded-lg flex items-center gap-1">
                        <i class="fas fa-download"></i> Download HTML Deck
                    </button>
                    <button onclick="savePitchToContact('${data.contact_id}')" class="text-xs bg-blue-600 text-white px-3 py-1.5 rounded-lg flex items-center gap-1">
                        <i class="fas fa-save"></i> Save to Contact
                    </button>
                </div>
            </div>`;
        }

        // Helper: Score contact from chat action button
        async function scoreContactFromChat(contactId) {
            showToast('Scoring lead...', 'info');
            try {
                const resp = await resilientFetch(`${CONFIG.API_BASE_URL}/contact/${contactId}/score?user_id=${AppState.currentUser.user_id}`, {
                    method: 'POST', headers: { 'X-API-Key': CONFIG.API_KEY }
                });
                const data = await resp.json();
                if (resp.ok && data.status === 'success') {
                    showToast(`Scored: ${data.score}/100 (${data.temperature})`, 'success');
                    loadContacts(); // Refresh contacts list
                } else {
                    showToast(data.detail || 'Scoring failed', 'error');
                }
            } catch (err) { showToast('Failed to score contact', 'error'); }
        }

        // Helper: Save last research response to contact notes
        async function saveResearchToContact(contactId) {
            // Find the last AI response that was a research response
            const lastResearch = chatHistory.filter(m => m.role === 'assistant').pop();
            if (!lastResearch) { showToast('No research to save', 'error'); return; }

            try {
                const resp = await resilientFetch(`${CONFIG.API_BASE_URL}/contact/${contactId}/enrich`, {
                    method: 'POST',
                    headers: { 'X-API-Key': CONFIG.API_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: AppState.currentUser.user_id,
                        notes_append: `\n\n--- AI Research (${new Date().toLocaleDateString()}) ---\n${lastResearch.content.substring(0, 2000)}`
                    })
                });
                if (resp.ok) {
                    showToast('Research saved to contact!', 'success');
                    loadContacts();
                } else { showToast('Failed to save research', 'error'); }
            } catch (err) { showToast('Failed to save research', 'error'); }
        }

        // Helper: Save pitch to contact + generate downloadable HTML
        async function savePitchToContact(contactId) {
            const lastPitch = chatHistory.filter(m => m.role === 'assistant').pop();
            if (!lastPitch) { showToast('No pitch to save', 'error'); return; }
            try {
                const resp = await resilientFetch(`${CONFIG.API_BASE_URL}/contact/${contactId}/enrich`, {
                    method: 'POST',
                    headers: { 'X-API-Key': CONFIG.API_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: AppState.currentUser.user_id,
                        notes_append: `\n\n--- Pitch Deck (${new Date().toLocaleDateString()}) ---\n${lastPitch.content.substring(0, 3000)}`,
                        links: [{ url: '#pitch-generated', label: 'Pitch Deck', added_by: 'ai_pitch' }]
                    })
                });
                if (resp.ok) {
                    showToast('Pitch saved to contact!', 'success');
                    loadContacts();
                } else { showToast('Failed to save pitch', 'error'); }
            } catch (err) { showToast('Failed to save pitch', 'error'); }
        }

        // Helper: Generate and download HTML pitch deck
        function downloadPitchDeck(contactId) {
            const lastPitch = chatHistory.filter(m => m.role === 'assistant').pop();
            if (!lastPitch) { showToast('No pitch to download', 'error'); return; }

            const contact = AppState.contacts.find(c => c.id === contactId) || {};
            const profile = AppState.userProfile || {};
            const content = lastPitch.content;

            const html = `<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pitch - ${escapeHtml(contact.name || 'Contact')} | ${escapeHtml(profile.company_name || 'Event Scout')}</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,system-ui,sans-serif;background:#0f172a;color:#fff}
.slide{min-height:100vh;display:flex;flex-direction:column;justify-content:center;padding:3rem 2rem;max-width:800px;margin:0 auto}
.slide h2{font-size:2rem;margin-bottom:1.5rem;background:linear-gradient(135deg,#818cf8,#c084fc);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.slide p,.slide li{font-size:1.1rem;line-height:1.7;color:#cbd5e1;margin-bottom:0.75rem}
.slide ul{list-style:none;padding:0}.slide li:before{content:"\\2022";color:#818cf8;font-weight:bold;margin-right:0.75rem}
.hero{background:linear-gradient(135deg,#1e1b4b,#312e81);text-align:center}.hero h1{font-size:2.5rem;margin-bottom:0.5rem}
.hero .subtitle{font-size:1.2rem;color:#a5b4fc}.divider{width:60px;height:4px;background:linear-gradient(90deg,#818cf8,#c084fc);border-radius:2px;margin:2rem auto}
.cta{background:linear-gradient(135deg,#312e81,#1e1b4b);text-align:center}.cta .btn{display:inline-block;padding:1rem 2.5rem;background:linear-gradient(135deg,#818cf8,#c084fc);color:#fff;border-radius:12px;font-weight:600;font-size:1.1rem;text-decoration:none;margin-top:1.5rem}
@media print{.slide{min-height:auto;page-break-after:always;padding:2rem}}
</style></head><body>
<div class="slide hero"><h1>${escapeHtml(profile.company_name || 'Our Company')}</h1><p class="subtitle">A Personalized Presentation for ${escapeHtml(contact.name || 'You')}</p><p class="subtitle" style="font-size:0.9rem;margin-top:0.5rem">${escapeHtml(contact.company_name || '')}</p><div class="divider"></div></div>
${content.split(/##\s+Slide\s+\d+:/i).filter(s=>s.trim()).map(slide => {
    const lines = slide.trim().split('\\n');
    const title = lines[0].replace(/^#+\s*/, '').replace(/\*\*/g, '');
    const body = lines.slice(1).join('\\n');
    return '<div class="slide"><h2>' + escapeHtml(title) + '</h2>' + formatAIResponse(body) + '</div>';
}).join('')}
<div class="slide cta"><h2>Let's Connect</h2><p>Generated by Event Scout AI</p><p style="font-size:0.9rem;color:#64748b;margin-top:1rem">${new Date().toLocaleDateString()}</p></div>
</body></html>`;

            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pitch_${(contact.name || 'contact').replace(/[^a-zA-Z0-9]/g, '_')}.html`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Pitch deck downloaded!', 'success');
        }

        // ==================== CONTACT DETAIL VIEW ====================
        let _swipeVoiceTriggered = 0;
        function openContactDetail(contactId) {
            // Skip if voice recording was just triggered by swipe
            if (Date.now() - _swipeVoiceTriggered < 500) return;
            const contact = AppState.contacts.find(c => c.id === contactId);
            if (!contact) return;

            // Admin viewing another user's contact -> use admin detail overlay with richer features
            if (AppState.currentUser.is_admin && contact.user_id && contact.user_id !== AppState.currentUser.user_id) {
                openAdminContactDetail(contactId, contact.user_id);
                return;
            }

            const detailView = document.getElementById('contactDetailView');
            const detailContent = document.getElementById('contactDetailContent');
            const company = contact.company_name && contact.company_name !== 'N/A' ? contact.company_name : '';
            const hasNotes = contact.notes && contact.notes.trim() && contact.notes !== 'N/A';
            const hasLinks = contact.links && contact.links.length > 0;
            const linkedin = contact.linkedin && contact.linkedin !== 'N/A' ? contact.linkedin : '';
            const escapedName = contact.name.replace(/'/g, "\\'");

            detailContent.innerHTML = `
                <!-- Header -->
                <div class="bg-gradient-to-br from-gray-900 to-gray-700 text-white p-6 pt-16 safe-area-inset-top">
                    <button onclick="closeContactDetail()" class="mb-4 flex items-center gap-2 text-white/80 active:text-white">
                        <i class="fas fa-arrow-left"></i>
                        <span class="text-sm">Back</span>
                    </button>
                    <div class="flex items-center gap-4">
                        ${contact.photo_base64
                            ? `<img src="data:image/jpeg;base64,${contact.photo_base64}" class="w-16 h-16 rounded-full object-cover flex-shrink-0 border-2 border-white/30" alt="${contact.name}">`
                            : `<div class="w-16 h-16 rounded-full ${getAvatarClass(contact.name)} flex items-center justify-center text-white text-2xl font-bold flex-shrink-0">
                                ${contact.name.charAt(0).toUpperCase()}
                            </div>`}
                        <div>
                            <h1 class="text-xl font-bold">${contact.name}</h1>
                            ${company ? `<p class="text-white/70 text-sm">${company}</p>` : ''}
                            ${contact.source === 'scan' ? '<span class="text-xs bg-white/20 px-2 py-0.5 rounded-full mt-1 inline-block">Scanned</span>' : ''}
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="flex justify-around py-4 bg-white border-b border-gray-100">
                    ${contact.phone && contact.phone !== 'N/A' ? `
                        <a href="tel:${contact.phone}" class="flex flex-col items-center gap-1 text-blue-600">
                            <div class="w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center shadow-sm"><i class="fas fa-phone text-base"></i></div>
                            <span class="text-xs">Call</span>
                        </a>` : ''}
                    ${contact.email && contact.email !== 'N/A' ? `
                        <a href="mailto:${contact.email}" class="flex flex-col items-center gap-1 text-green-600">
                            <div class="w-12 h-12 rounded-full bg-green-50 flex items-center justify-center shadow-sm"><i class="fas fa-envelope text-base"></i></div>
                            <span class="text-xs">Email</span>
                        </a>` : ''}
                    ${linkedin ? `
                        <a href="${linkedin.startsWith('http') ? linkedin : 'https://' + linkedin}" target="_blank" class="flex flex-col items-center gap-1 text-blue-700">
                            <div class="w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center shadow-sm"><i class="fab fa-linkedin text-base"></i></div>
                            <span class="text-xs">LinkedIn</span>
                        </a>` : `
                        <button onclick="findLinkedIn('${escapedName}', '${(company || '').replace(/'/g, "\\'")}')" class="flex flex-col items-center gap-1 text-blue-700">
                            <div class="w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center shadow-sm"><i class="fab fa-linkedin text-base"></i></div>
                            <span class="text-xs">Find</span>
                        </button>`}
                    <button onclick="viewContactQR('${contact.id}')" class="flex flex-col items-center gap-1 text-purple-600">
                        <div class="w-12 h-12 rounded-full bg-purple-50 flex items-center justify-center shadow-sm"><i class="fas fa-qrcode text-base"></i></div>
                        <span class="text-xs">QR Code</span>
                    </button>
                    <button onclick="saveContactToPhone('${contact.id}')" class="flex flex-col items-center gap-1 text-emerald-600">
                        <div class="w-12 h-12 rounded-full bg-emerald-50 flex items-center justify-center shadow-sm"><i class="fas fa-address-book text-base"></i></div>
                        <span class="text-xs">Save</span>
                    </button>
                </div>

                <!-- Contact Info -->
                <div class="p-4 space-y-4">
                    <div class="bg-white rounded-xl p-4 shadow-sm space-y-3">
                        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Contact Information</h3>
                        ${contact.email && contact.email !== 'N/A' ? `
                        <div class="flex items-center gap-3">
                            <i class="fas fa-envelope text-gray-400 w-5 text-center"></i>
                            <div>
                                <p class="text-sm text-gray-900">${contact.email}</p>
                                <p class="text-xs text-gray-400">Email</p>
                            </div>
                        </div>` : ''}
                        ${contact.phone && contact.phone !== 'N/A' ? `
                        <div class="flex items-center gap-3">
                            <i class="fas fa-phone text-gray-400 w-5 text-center"></i>
                            <div>
                                <p class="text-sm text-gray-900">${contact.phone}</p>
                                <p class="text-xs text-gray-400">Phone</p>
                            </div>
                        </div>` : ''}
                        ${linkedin ? `
                        <div class="flex items-center gap-3">
                            <i class="fab fa-linkedin text-gray-400 w-5 text-center"></i>
                            <div>
                                <p class="text-sm text-blue-600 truncate">${linkedin}</p>
                                <p class="text-xs text-gray-400">LinkedIn ${contact.linkedin_source === 'ai_detected' ? '<span class="bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded text-[10px] ml-1">AI found</span>' : ''}</p>
                            </div>
                        </div>` : `
                        <div class="flex items-center gap-3">
                            <i class="fab fa-linkedin text-gray-400 w-5 text-center"></i>
                            <div class="flex-1">
                                <button onclick="findLinkedIn('${escapedName}', '${(company || '').replace(/'/g, "\\'")}')" class="text-sm text-blue-600">
                                    <i class="fas fa-search text-xs mr-1"></i>Find on LinkedIn
                                </button>
                                <p class="text-xs text-gray-400">Opens LinkedIn search</p>
                            </div>
                        </div>`}
                        ${company ? `
                        <div class="flex items-center gap-3">
                            <i class="fas fa-building text-gray-400 w-5 text-center"></i>
                            <div>
                                <p class="text-sm text-gray-900">${company}</p>
                                <p class="text-xs text-gray-400">Company</p>
                            </div>
                        </div>` : ''}
                    </div>

                    <!-- Notes -->
                    <div class="bg-white rounded-xl p-4 shadow-sm">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Notes</h3>
                            <button onclick="editContact('${contact.id}')" class="text-xs text-blue-600">Edit</button>
                        </div>
                        ${hasNotes
                            ? `<p class="text-sm text-gray-700 whitespace-pre-wrap">${contact.notes}</p>`
                            : `<p class="text-sm text-gray-400 italic">No notes yet. Tap Edit to add notes about this contact.</p>`
                        }
                    </div>

                    <!-- Links -->
                    ${hasLinks ? `
                    <div class="bg-white rounded-xl p-4 shadow-sm">
                        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">Links & Attachments</h3>
                        <div class="space-y-2">
                            ${contact.links.map(link => `
                                <a href="${link.url}" target="_blank" class="link-chip ${link.added_by === 'n8n' ? 'auto' : ''}">
                                    <i class="fas fa-external-link-alt text-xs"></i>
                                    ${link.label || 'Link'}
                                    ${link.added_by === 'n8n' ? '<span class="text-xs opacity-60">auto</span>' : ''}
                                </a>
                            `).join('')}
                        </div>
                    </div>` : ''}

                    <!-- Intel from HQ (admin notes) -->
                    ${contact.admin_notes ? `
                    <div class="bg-purple-50 rounded-xl p-4 shadow-sm border border-purple-200">
                        <h3 class="text-xs font-semibold text-purple-600 uppercase tracking-wide mb-2"><i class="fas fa-shield-alt mr-1"></i>Intel from HQ</h3>
                        <p class="text-sm text-gray-700 whitespace-pre-wrap">${contact.admin_notes}</p>
                    </div>` : ''}

                    <!-- Documents from HQ -->
                    <div id="contactDocsSection" class="hidden">
                        <div class="bg-blue-50 rounded-xl p-4 shadow-sm border border-blue-200">
                            <h3 class="text-xs font-semibold text-blue-600 uppercase tracking-wide mb-2"><i class="fas fa-folder-open mr-1"></i>Documents from HQ</h3>
                            <div id="userContactFiles" class="space-y-2"></div>
                        </div>
                    </div>

                    <!-- AI Pipeline Status -->
                    <div id="pipelineStatusCard" class="hidden">
                        <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-4 shadow-sm border border-indigo-200">
                            <h3 class="text-xs font-semibold text-indigo-600 uppercase tracking-wide mb-3"><i class="fas fa-robot mr-1"></i>AI Pipeline</h3>
                            <div id="pipelineSteps" class="flex flex-wrap gap-2 mb-3"></div>
                            <p id="pipelineCurrentStep" class="text-xs text-gray-500 italic mb-3"></p>
                            <div id="pipelineResearchSection" class="hidden mb-3">
                                <button onclick="togglePipelineSection('pipelineResearchContent')" class="text-xs font-medium text-indigo-600 flex items-center gap-1">
                                    <i class="fas fa-chevron-right text-[10px]" id="pipelineResearchToggle"></i> View Research
                                </button>
                                <div id="pipelineResearchContent" class="hidden mt-2 text-xs text-gray-700 bg-white rounded-lg p-3 whitespace-pre-wrap"></div>
                            </div>
                            <div id="pipelinePitchSection" class="hidden mb-3">
                                <button onclick="togglePipelineSection('pipelinePitchContent')" class="text-xs font-medium text-purple-600 flex items-center gap-1">
                                    <i class="fas fa-chevron-right text-[10px]" id="pipelinePitchToggle"></i> View Pitch & Email
                                </button>
                                <div id="pipelinePitchContent" class="hidden mt-2 text-xs text-gray-700 bg-white rounded-lg p-3 space-y-2"></div>
                            </div>
                            <div id="pipelineActions" class="flex gap-2">
                                <button onclick="runContactPipeline('${contact.id}')" id="pipelineRunBtn" class="flex-1 py-2 bg-indigo-600 text-white rounded-lg text-xs font-medium active:bg-indigo-700">
                                    <i class="fas fa-play mr-1"></i>Run Pipeline
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Intelligence Actions -->
                    <div class="flex gap-2 mb-3">
                        <button onclick="getPitchAngle('${contact.id}', '${escapedName}', '${(company || '').replace(/'/g, "\\'")}')"
                                class="flex-1 py-3 bg-purple-600 text-white rounded-lg font-semibold text-sm active:bg-purple-700">
                            <i class="fas fa-lightbulb mr-1"></i>Pitch Angle
                        </button>
                        <button onclick="getBriefing('${contact.id}', '${escapedName}', '${(company || '').replace(/'/g, "\\'")}')"
                                class="flex-1 py-3 bg-indigo-600 text-white rounded-lg font-semibold text-sm active:bg-indigo-700">
                            <i class="fas fa-file-alt mr-1"></i>Brief Me
                        </button>
                    </div>

                    <!-- Inline AI Response (shown when Pitch Angle / Brief Me is tapped) -->
                    <div id="inlineAIResponse" class="hidden mb-3">
                        <div class="bg-gradient-to-br from-purple-50 to-indigo-50 rounded-xl p-4 shadow-sm border border-purple-200">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-xs font-semibold text-purple-600 uppercase tracking-wide">
                                    <i class="fas fa-robot mr-1"></i><span id="inlineAITitle">AI Insight</span>
                                </h3>
                                <button onclick="document.getElementById('inlineAIResponse').classList.add('hidden')" class="text-gray-400 active:text-gray-600 p-1">
                                    <i class="fas fa-times text-xs"></i>
                                </button>
                            </div>
                            <div id="inlineAIContent" class="text-sm text-gray-800 leading-relaxed"></div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-3 pt-2 pb-24">
                        <button onclick="editContact('${contact.id}')" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-semibold active:bg-blue-700 transition">
                            <i class="fas fa-pen mr-2"></i>Edit
                        </button>
                        <button onclick="deleteContact('${contact.id}', '${escapedName}')" class="bg-red-50 text-red-600 px-6 py-3 rounded-xl font-semibold active:bg-red-100 transition">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;

            detailView.classList.remove('hidden');
            detailContent.className = 'h-full overflow-y-auto slide-in-right';
            // Load contact documents from HQ
            loadContactFiles(contactId, 'userContactFiles', false);
            // Load AI pipeline status
            loadPipelineStatus(contactId);
        }

        function closeContactDetail() {
            const detailView = document.getElementById('contactDetailView');
            if (detailView.classList.contains('hidden')) return;

            // Show FAB again
            const fab = document.getElementById('contactsFab');
            if (fab) fab.style.display = '';

            const detailContent = document.getElementById('contactDetailContent');
            detailContent.className = 'h-full overflow-y-auto slide-out-right';
            setTimeout(() => {
                detailView.classList.add('hidden');
            }, 250);
        }

        async function getPitchAngle(contactId, name, company) {
            const responseDiv = document.getElementById('inlineAIResponse');
            const contentDiv = document.getElementById('inlineAIContent');
            const titleSpan = document.getElementById('inlineAITitle');

            titleSpan.textContent = 'Pitch Angle';
            contentDiv.innerHTML = '<div class="flex items-center gap-2 text-purple-500"><i class="fas fa-spinner fa-spin"></i> Generating pitch angle...</div>';
            responseDiv.classList.remove('hidden');
            responseDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            const query = `Generate a specific pitch angle for ${name} at ${company}. Consider their role, my products/services, and how my value propositions align with their potential needs. Give me 2-3 talking points I can use.`;

            try {
                const response = await resilientFetch(`${CONFIG.API_BASE_URL}/converse/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-API-Key': CONFIG.API_KEY },
                    body: JSON.stringify({ user_id: AppState.currentUser.user_id, query, conversation_history: [] })
                });
                const data = await response.json();
                if (response.ok) {
                    contentDiv.innerHTML = formatAIResponse(data.response || 'No response generated.');
                } else {
                    contentDiv.innerHTML = '<p class="text-red-500 text-sm">Failed to generate pitch angle. Try again.</p>';
                }
            } catch (err) {
                contentDiv.innerHTML = '<p class="text-red-500 text-sm">Network error. Check your connection.</p>';
            }
        }

        async function getBriefing(contactId, name, company) {
            const responseDiv = document.getElementById('inlineAIResponse');
            const contentDiv = document.getElementById('inlineAIContent');
            const titleSpan = document.getElementById('inlineAITitle');

            titleSpan.textContent = 'Quick Briefing';
            contentDiv.innerHTML = '<div class="flex items-center gap-2 text-indigo-500"><i class="fas fa-spinner fa-spin"></i> Preparing briefing...</div>';
            responseDiv.classList.remove('hidden');
            responseDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            const query = `Quick briefing on ${name} at ${company} before my meeting: Who are they? Why do they matter to me? Suggested talking points? What should I pitch? Keep it concise and actionable.`;

            try {
                const response = await resilientFetch(`${CONFIG.API_BASE_URL}/converse/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-API-Key': CONFIG.API_KEY },
                    body: JSON.stringify({ user_id: AppState.currentUser.user_id, query, conversation_history: [] })
                });
                const data = await response.json();
                if (response.ok) {
                    contentDiv.innerHTML = formatAIResponse(data.response || 'No response generated.');
                } else {
                    contentDiv.innerHTML = '<p class="text-red-500 text-sm">Failed to generate briefing. Try again.</p>';
                }
            } catch (err) {
                contentDiv.innerHTML = '<p class="text-red-500 text-sm">Network error. Check your connection.</p>';
            }
        }

        // ==================== EXPORT FUNCTIONS ====================
        async function exportContacts(format) {
            if (!AppState.currentUser) return;

            try {
                if (format === 'json') {
                    // Client-side JSON export
                    const data = AppState.contacts.map(c => ({
                        name: c.name, email: c.email, phone: c.phone,
                        linkedin: c.linkedin, company_name: c.company_name,
                        notes: c.notes || '', source: c.source || 'manual'
                    }));
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'event_scout_contacts.json';
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast(`Exported ${data.length} contacts as JSON`, 'success');
                } else {
                    // CSV export via backend
                    const url = `${CONFIG.API_BASE_URL}/export_contacts/?user_id=${encodeURIComponent(AppState.currentUser.user_id)}&format=csv`;
                    const response = await resilientFetch(url, {
                        headers: { 'X-API-Key': CONFIG.API_KEY }
                    });

                    if (!response.ok) throw new Error('Export failed');

                    const blob = await response.blob();
                    const downloadUrl = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = 'event_scout_contacts.csv';
                    a.click();
                    URL.revokeObjectURL(downloadUrl);
                    showToast(`Exported ${AppState.contacts.length} contacts as CSV`, 'success');
                }
            } catch (error) {
                console.error('Export error:', error);
                showToast('Export failed. Please try again.', 'error');
            }
        }

        // ==================== DIGITAL BUSINESS CARD FUNCTIONS ====================
        let cardPhotoBase64 = '';

        function handleCardPhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 2 * 1024 * 1024) {
                showToast('Photo must be under 2MB', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                // Resize to 200x200 max
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const size = Math.min(img.width, img.height, 400);
                    canvas.width = size;
                    canvas.height = size;
                    const ctx = canvas.getContext('2d');
                    // Center crop
                    const sx = (img.width - size) / 2;
                    const sy = (img.height - size) / 2;
                    ctx.drawImage(img, sx, sy, size, size, 0, 0, size, size);
                    cardPhotoBase64 = canvas.toDataURL('image/jpeg', 0.8);
                    // Update preview
                    document.getElementById('cardPhotoPreview').innerHTML = `<img src="${cardPhotoBase64}" class="w-full h-full object-cover">`;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function loadDigitalCard() {
            if (!AppState.currentUser) return;

            try {
                const response = await resilientFetch(`${CONFIG.API_BASE_URL}/user/card/?user_id=${encodeURIComponent(AppState.currentUser.user_id)}`, {
                    headers: { 'X-API-Key': CONFIG.API_KEY }
                });

                if (!response.ok) throw new Error('Failed to load card');

                const data = await response.json();
                const card = data.card || {};

                // Populate form fields
                document.getElementById('cardFullName').value = card.full_name || '';
                document.getElementById('cardJobTitle').value = card.job_title || '';
                document.getElementById('cardCompanyName').value = card.company_name || '';
                document.getElementById('cardEmail').value = card.email || '';
                document.getElementById('cardPhone').value = card.phone || '';
                document.getElementById('cardLinkedIn').value = card.linkedin_url || '';
                document.getElementById('cardZoom').value = card.zoom_number || '';
                document.getElementById('cardWebsite').value = card.website || '';

                // Load photo if exists
                if (card.photo_base64) {
                    cardPhotoBase64 = card.photo_base64;
                    document.getElementById('cardPhotoPreview').innerHTML = `<img src="${cardPhotoBase64}" class="w-full h-full object-cover">`;
                }

                // Show QR if exists
                if (data.shareable_url) {
                    document.getElementById('cardShareableURL').textContent = data.shareable_url;
                }
            } catch (error) {
                console.error('Load card error:', error);
            }
        }

        async function saveDigitalCard() {
            if (!AppState.currentUser) return;

            const btn = document.getElementById('saveCardBtn');
            const originalText = btn.innerHTML;

            // Convert empty strings to null for optional fields
            const cardData = {
                full_name: document.getElementById('cardFullName').value.trim(),
                email: document.getElementById('cardEmail').value.trim(),
                job_title: document.getElementById('cardJobTitle').value.trim() || null,
                company_name: document.getElementById('cardCompanyName').value.trim() || null,
                phone: document.getElementById('cardPhone').value.trim() || null,
                linkedin_url: document.getElementById('cardLinkedIn').value.trim() || null,
                zoom_number: document.getElementById('cardZoom').value.trim() || null,
                website: document.getElementById('cardWebsite').value.trim() || null,
                photo_base64: cardPhotoBase64 || null,
            };

            // Validation - mandatory fields
            if (!cardData.full_name || !cardData.email) {
                showToast('Please enter at least your name and email', 'error');
                return;
            }

            // Email format validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(cardData.email)) {
                showToast('Please enter a valid email address', 'error');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i><span>Saving...</span>';

            try {
                const response = await resilientFetch(`${CONFIG.API_BASE_URL}/user/card/?user_id=${encodeURIComponent(AppState.currentUser.user_id)}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': CONFIG.API_KEY
                    },
                    body: JSON.stringify(cardData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Save card error details:', errorData);
                    showToast(errorData.detail || 'Failed to save card. Please try again.', 'error');
                    return;
                }

                const data = await response.json();
                showToast('Digital card saved successfully!', 'success');

                if (data.shareable_url) {
                    document.getElementById('cardShareableURL').textContent = data.shareable_url;
                }
            } catch (error) {
                console.error('Save card error:', error);
                showToast('Failed to save card. Please try again.', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function generateCardQR() {
            if (!AppState.currentUser) return;

            const btn = document.getElementById('generateQRBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i><span>Generating...</span>';

            try {
                const response = await resilientFetch(`${CONFIG.API_BASE_URL}/user/card/generate_token/?user_id=${encodeURIComponent(AppState.currentUser.user_id)}`, {
                    method: 'POST',
                    headers: { 'X-API-Key': CONFIG.API_KEY }
                });

                if (!response.ok) throw new Error('Failed to generate QR');

                const data = await response.json();

                // Display QR code
                const qrContainer = document.getElementById('cardQRContainer');
                const qrImage = document.getElementById('cardQRImage');
                const urlDisplay = document.getElementById('cardShareableURL');

                qrImage.src = `data:image/png;base64,${data.qr_code_base64}`;
                urlDisplay.textContent = data.shareable_url;
                qrContainer.classList.remove('hidden');

                showToast('QR code generated! Share it with people you meet.', 'success');
            } catch (error) {
                console.error('Generate QR error:', error);
                showToast('Failed to generate QR code. Please try again.', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function saveMyCardToPhone() {
            const name = document.getElementById('cardFullName')?.value || AppState.currentUser?.name || '';
            const email = document.getElementById('cardEmail')?.value || '';
            const phone = document.getElementById('cardPhone')?.value || '';
            const company = document.getElementById('cardCompanyName')?.value || '';
            const title = document.getElementById('cardJobTitle')?.value || '';
            const linkedin = document.getElementById('cardLinkedIn')?.value || '';
            const website = document.getElementById('cardWebsite')?.value || '';

            if (!name) { showToast('Please fill in your card details first', 'warning'); return; }

            const lines = ['BEGIN:VCARD', 'VERSION:3.0'];
            const nameParts = name.split(' ');
            const firstName = nameParts[0] || '';
            const lastName = nameParts.slice(1).join(' ') || '';
            lines.push('N:' + lastName + ';' + firstName + ';;;');
            lines.push('FN:' + name);
            if (title) lines.push('TITLE:' + title);
            if (company) lines.push('ORG:' + company);
            if (email) lines.push('EMAIL;TYPE=INTERNET:' + email);
            if (phone) lines.push('TEL;TYPE=CELL:' + phone);
            if (linkedin) lines.push('URL:' + linkedin);
            if (website) lines.push('URL:' + website);
            lines.push('END:VCARD');

            const vcard = lines.join('\r\n');
            const blob = new Blob([vcard], { type: 'text/vcard' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = name.replace(/\s+/g, '_') + '.vcf';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Opening contact save dialog...', 'info');
        }

        async function triggerCardAcceptedWebhook(contactId, contactName) {
            /**
             * Triggered when user accepts/scans a card.
             * Sends webhook to n8n to trigger automated CookieMail.
             */
            if (!AppState.currentUser || !contactId) return;

            try {
                const response = await resilientFetch(`${CONFIG.API_BASE_URL}/contact/${contactId}/accepted?user_id=${encodeURIComponent(AppState.currentUser.user_id)}`, {
                    method: 'POST',
                    headers: { 'X-API-Key': CONFIG.API_KEY }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.webhook_sent) {
                        console.log(`[WEBHOOK] CookieMail triggered for ${contactName}`);
                    } else {
                        console.warn(`[WEBHOOK] ${data.webhook_message}`);
                    }
                }
            } catch (error) {
                // Silent failure - don't interrupt user flow
                console.error('[WEBHOOK] Error triggering card acceptance:', error);
            }
        }

        // ==================== UTILITY FUNCTIONS ====================
        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            const bgColor = type === 'success' ? 'bg-green-50 text-green-800 border-green-200' : 'bg-red-50 text-red-800 border-red-200';
            container.innerHTML = `<div class="border rounded-lg p-3 text-sm ${bgColor}">${message}</div>`;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : type === 'warning' ? 'bg-amber-500' : 'bg-blue-500';
            toast.className = `fixed top-4 left-4 right-4 px-5 py-3.5 rounded-xl shadow-xl transform transition-all duration-300 z-50 ${bgColor} text-white`;
            toast.style.transform = 'translateY(-100%)';
            toast.style.opacity = '0';

            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'} text-lg"></i>
                    <p class="flex-1 text-sm font-medium">${message}</p>
                    <button onclick="this.parentElement.parentElement.style.opacity='0';this.parentElement.parentElement.style.transform='translateY(-100%)';setTimeout(()=>this.parentElement.parentElement.remove(),300)" class="text-white/70 active:text-white ml-2">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            document.body.appendChild(toast);

            // Slide in
            requestAnimationFrame(() => {
                toast.style.transform = 'translateY(0)';
                toast.style.opacity = '1';
            });

            // Auto-dismiss: longer for long messages
            const dismissTime = message.length > 60 ? 5000 : 3000;
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-100%)';
                setTimeout(() => toast.remove(), 300);
            }, dismissTime);
        }

        /**
         * Centralized API request handler with better error categorization.
         * Usage: const data = await apiRequest('/endpoint/', { method: 'POST', body: {...} });
         */
        async function apiRequest(endpoint, options = {}) {
            try {
                // Build full URL
                const url = endpoint.startsWith('http') ? endpoint : `${CONFIG.API_BASE_URL}${endpoint}`;

                // Add default headers
                const headers = {
                    'X-API-Key': CONFIG.API_KEY,
                    ...options.headers
                };

                const response = await resilientFetch(url, { ...options, headers });

                // Try to parse JSON response
                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    data = {};
                }

                // Handle HTTP errors with specific messages
                if (!response.ok) {
                    let errorMessage;

                    switch (response.status) {
                        case 401:
                            errorMessage = 'Session expired. Please log in again.';
                            break;
                        case 403:
                            errorMessage = 'Permission denied. You do not have access to this resource.';
                            break;
                        case 404:
                            errorMessage = data.detail || 'Item not found. It may have been deleted.';
                            break;
                        case 500:
                            errorMessage = `Server error: ${data.detail || 'Please try again in a moment.'}`;
                            break;
                        case 503:
                            errorMessage = 'Service temporarily unavailable. Please try again.';
                            break;
                        default:
                            errorMessage = data.detail || `Request failed (${response.status})`;
                    }

                    throw new Error(errorMessage);
                }

                return data;
            } catch (error) {
                // Distinguish network errors from HTTP errors
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    throw new Error('Network error. Check your internet connection and try again.');
                }
                throw error;
            }
        }

        // ==================== USER PROFILE FUNCTIONS ====================
        async function loadUserProfile() {
            try {
                const response = await resilientFetch(
                    `${CONFIG.API_BASE_URL}/user/profile/?user_id=${AppState.currentUser.user_id}`,
                    { headers: { 'X-API-Key': CONFIG.API_KEY } }
                );
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    AppState.userProfile = data.profile || {};
                    // Set AI model selector
                    const aiModelSelect = document.getElementById('aiModelSelect');
                    if (aiModelSelect && AppState.userProfile.preferred_ai_model) {
                        aiModelSelect.value = AppState.userProfile.preferred_ai_model;
                    }
                    updateChatModelLabel();
                }
            } catch (error) {
                console.error('Load profile error:', error);
            }
        }

        async function saveAIModel() {
            const model = document.getElementById('aiModelSelect').value;
            try {
                await resilientFetch(`${CONFIG.API_BASE_URL}/user/profile/?user_id=${AppState.currentUser.user_id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': CONFIG.API_KEY
                    },
                    body: JSON.stringify({ preferred_ai_model: model })
                });
                AppState.userProfile.preferred_ai_model = model;
                updateChatModelLabel();
                showToast('AI model updated', 'success');
            } catch (error) {
                showToast('Failed to save model preference', 'error');
            }
        }

        function updateChatModelLabel() {
            const modelNames = {
                'claude-opus': 'Claude Opus 4.6',
                'gpt-5': 'GPT-5.2',
                'gemini-pro': 'Gemini 2.5 Pro'
            };
            const model = (AppState.userProfile || {}).preferred_ai_model || 'claude-opus';
            const label = modelNames[model] || 'Claude Opus 4.6';
            document.getElementById('chatModelLabel').textContent = `Powered by ${label}`;
        }

        async function saveUserProfile(updates) {
            try {
                const response = await resilientFetch(
                    `${CONFIG.API_BASE_URL}/user/profile/?user_id=${AppState.currentUser.user_id}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': CONFIG.API_KEY
                        },
                        body: JSON.stringify(updates)
                    }
                );
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    AppState.userProfile = data.profile;
                    showToast('Settings saved', 'success');
                    return true;
                } else {
                    showToast('Failed to save settings', 'error');
                    return false;
                }
            } catch (error) {
                showToast('Network error', 'error');
                console.error('Save profile error:', error);
                return false;
            }
        }

        // ==================== SETTINGS SHEET FUNCTIONS ====================
        function openSettingsSheet(section) {
            const sheet = document.getElementById('settingsSheet');
            const title = document.getElementById('settingsSheetTitle');
            const body = document.getElementById('settingsSheetBody');
            const p = AppState.userProfile;

            if (section === 'products') {
                title.textContent = 'Products & Services';
                const products = p.products || [{ name: '', description: '', ideal_customer: '' }];
                body.innerHTML = `
                    <p class="text-sm text-gray-500 mb-4">What do you sell? This helps AI suggest relevant pitch angles.</p>
                    <div id="productsContainer">
                        ${products.map((prod, i) => `
                        <div class="product-entry bg-gray-50 rounded-xl p-4 mb-3 space-y-3">
                            <input type="text" placeholder="Product/Service name" value="${escapeHtml(prod.name || '')}"
                                class="product-name w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none">
                            <textarea placeholder="Brief description" rows="2"
                                class="product-desc w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none resize-none">${escapeHtml(prod.description || '')}</textarea>
                            <input type="text" placeholder="Ideal customer (e.g., VP Marketing at mid-market SaaS)" value="${escapeHtml(prod.ideal_customer || '')}"
                                class="product-customer w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none">
                        </div>`).join('')}
                    </div>
                    <button onclick="addProductEntry()" class="text-sm text-purple-600 font-medium mb-4"><i class="fas fa-plus mr-1"></i>Add another product</button>
                    <div class="space-y-3 mt-2">
                        <label class="block text-sm font-medium text-gray-700">Your Company</label>
                        <input type="text" id="settCompanyName" value="${escapeHtml(p.company_name || '')}" placeholder="Company name"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none">
                        <input type="text" id="settJobTitle" value="${escapeHtml(p.job_title || '')}" placeholder="Your job title"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none">
                    </div>
                    <button onclick="saveProductsSettings()" class="w-full mt-6 bg-purple-600 text-white py-3 rounded-lg font-semibold active:bg-purple-700">Save</button>
                `;
            } else if (section === 'targeting') {
                title.textContent = 'Target Market';
                body.innerHTML = `
                    <p class="text-sm text-gray-500 mb-4">Who are you trying to reach? This helps AI score leads.</p>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Target Industries</label>
                            <textarea id="settIndustries" rows="3" placeholder="One per line: Healthcare, FinTech, Manufacturing..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none resize-none">${(p.target_industries || []).join('\n')}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Target Roles</label>
                            <textarea id="settRoles" rows="3" placeholder="One per line: CTO, VP Marketing, Head of Data..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none resize-none">${(p.target_roles || []).join('\n')}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Target Company Sizes</label>
                            <textarea id="settSizes" rows="2" placeholder="One per line: startup, mid-market, enterprise..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none resize-none">${(p.target_company_sizes || []).join('\n')}</textarea>
                        </div>
                    </div>
                    <button onclick="saveTargetingSettings()" class="w-full mt-6 bg-blue-600 text-white py-3 rounded-lg font-semibold active:bg-blue-700">Save</button>
                `;
            } else if (section === 'pitch') {
                title.textContent = 'Pitch & Value Props';
                body.innerHTML = `
                    <p class="text-sm text-gray-500 mb-4">How do you sell? This shapes AI-generated pitch angles.</p>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Pitch Style</label>
                            <select id="settPitchStyle" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 outline-none">
                                <option value="consultative" ${p.pitch_style === 'consultative' ? 'selected' : ''}>Consultative (discover needs first)</option>
                                <option value="direct" ${p.pitch_style === 'direct' ? 'selected' : ''}>Direct (lead with solution)</option>
                                <option value="challenger" ${p.pitch_style === 'challenger' ? 'selected' : ''}>Challenger (reframe their thinking)</option>
                                <option value="relationship" ${p.pitch_style === 'relationship' ? 'selected' : ''}>Relationship (build trust first)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Value Propositions</label>
                            <textarea id="settValueProps" rows="4" placeholder="One per line: your key selling points in your own words..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 outline-none resize-none">${(p.value_propositions || []).join('\n')}</textarea>
                        </div>
                    </div>
                    <button onclick="savePitchSettings()" class="w-full mt-6 bg-green-600 text-white py-3 rounded-lg font-semibold active:bg-green-700">Save</button>
                `;
            } else if (section === 'event') {
                title.textContent = 'Current Event';
                body.innerHTML = `
                    <p class="text-sm text-gray-500 mb-4">
                        <i class="fas fa-calendar-check text-orange-500 mr-1"></i>
                        Tell AI about the event you're attending.
                    </p>
                    <div class="space-y-4">
                        <div class="relative">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Event Name</label>
                            <input type="text" id="settEventName" value="${escapeHtml(p.current_event_name || '')}" placeholder="Start typing: WHX, CES, GITEX..."
                                oninput="handleEventNameInput()"
                                onfocus="handleEventNameInput()"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 outline-none">
                            <div id="eventSuggestionsDropdown" class="hidden absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Event Description</label>
                            <textarea id="settEventDesc" rows="3" placeholder="Auto-filled when you select an event above"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 outline-none resize-none">${escapeHtml(p.current_event_description || '')}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Your Goals</label>
                            <textarea id="settEventGoals" rows="3" placeholder="One per line: Find healthcare partners, Meet CTOs..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 outline-none resize-none">${(p.event_goals || []).join('\n')}</textarea>
                        </div>
                    </div>
                    <button onclick="saveEventSettings()" class="w-full mt-6 bg-orange-500 text-white py-3 rounded-lg font-semibold active:bg-orange-600">Save</button>
                `;
            }

            sheet.classList.remove('hidden');
            setTimeout(() => {
                sheet.querySelector('.sheet-content').style.transform = 'translateY(0)';
            }, 10);
        }

        function closeSettingsSheet() {
            const sheet = document.getElementById('settingsSheet');
            const content = sheet.querySelector('.sheet-content');
            content.style.transform = 'translateY(100%)';
            setTimeout(() => sheet.classList.add('hidden'), 300);
        }

        function addProductEntry() {
            const container = document.getElementById('productsContainer');
            const entry = document.createElement('div');
            entry.className = 'product-entry bg-gray-50 rounded-xl p-4 mb-3 space-y-3';
            entry.innerHTML = `
                <input type="text" placeholder="Product/Service name" class="product-name w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none">
                <textarea placeholder="Brief description" rows="2" class="product-desc w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none resize-none"></textarea>
                <input type="text" placeholder="Ideal customer" class="product-customer w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none">
            `;
            container.appendChild(entry);
        }

        async function saveProductsSettings() {
            const entries = document.querySelectorAll('.product-entry');
            const products = [];
            entries.forEach(entry => {
                const name = entry.querySelector('.product-name').value.trim();
                if (name) {
                    products.push({
                        name: name,
                        description: entry.querySelector('.product-desc').value.trim(),
                        ideal_customer: entry.querySelector('.product-customer').value.trim()
                    });
                }
            });
            const saved = await saveUserProfile({
                products: products,
                company_name: document.getElementById('settCompanyName').value.trim() || undefined,
                job_title: document.getElementById('settJobTitle').value.trim() || undefined
            });
            if (saved) closeSettingsSheet();
        }

        async function saveTargetingSettings() {
            const toList = (id) => document.getElementById(id).value.split('\n').map(s => s.trim()).filter(Boolean);
            const saved = await saveUserProfile({
                target_industries: toList('settIndustries'),
                target_roles: toList('settRoles'),
                target_company_sizes: toList('settSizes')
            });
            if (saved) closeSettingsSheet();
        }

        async function savePitchSettings() {
            const saved = await saveUserProfile({
                pitch_style: document.getElementById('settPitchStyle').value,
                value_propositions: document.getElementById('settValueProps').value.split('\n').map(s => s.trim()).filter(Boolean)
            });
            if (saved) closeSettingsSheet();
        }

        async function saveEventSettings() {
            const eventName = document.getElementById('settEventName').value.trim();
            const eventDesc = document.getElementById('settEventDesc').value.trim();

            // Smart event detection - auto-fill description if empty
            if (eventName && !eventDesc) {
                const eventLower = eventName.toLowerCase();
                let autoDescription = '';

                if (eventLower.includes('whx') || eventLower.includes('world health expo') ||
                    eventLower.includes('arab health')) {
                    autoDescription = 'Largest healthcare exhibition in Middle East. Medical devices, pharma, health IT, diagnostics. 4,300+ exhibitors from 180+ countries.';
                } else if (eventLower.includes('ces') && eventLower.includes('20')) {
                    autoDescription = 'Consumer Electronics Show. Technology, innovation, gadgets, AI, automotive tech, smart home, and emerging technologies.';
                } else if (eventLower.includes('gitex')) {
                    autoDescription = 'Gulf Information Technology Exhibition. Tech, AI, cybersecurity, cloud, startups, fintech, and digital transformation.';
                } else if (eventLower.includes('medica')) {
                    autoDescription = 'International trade fair for medical technology. Laboratory equipment, diagnostics, physiotherapy, IT systems.';
                } else if (eventLower.includes('himss')) {
                    autoDescription = 'Healthcare Information and Management Systems Society. Health IT, interoperability, digital health innovation.';
                } else if (eventLower.includes('dmexco')) {
                    autoDescription = 'Digital Marketing Expo & Conference. MarTech, AdTech, digital advertising, e-commerce.';
                }

                if (autoDescription) {
                    // Show user the auto-filled description and ask to confirm
                    const confirmMsg = `Auto-detected event type! Suggested description:\n\n"${autoDescription}"\n\nClick OK to use this, or Cancel to write your own.`;
                    if (confirm(confirmMsg)) {
                        document.getElementById('settEventDesc').value = autoDescription;
                        showToast('Event description auto-filled! Review and edit if needed.', 'success');
                        return; // Don't save yet, let user review
                    }
                }
            }

            const saved = await saveUserProfile({
                current_event_name: eventName,
                current_event_description: eventDesc || undefined,
                event_goals: document.getElementById('settEventGoals').value.split('\n').map(s => s.trim()).filter(Boolean)
            });
            if (saved) {
                showToast('Event settings saved!', 'success');
                closeSettingsSheet();
            }
        }

        // Event autocomplete suggestions
        const EVENT_TEMPLATES = [
            {
                names: ['WHX', 'WHX Dubai', 'World Health Expo', 'Arab Health'],
                fullName: 'WHX Dubai 2026',
                description: 'Largest healthcare exhibition in Middle East. Medical devices, pharma, health IT, diagnostics. 4,300+ exhibitors from 180+ countries.',
                icon: 'fa-heartbeat'
            },
            {
                names: ['CES', 'CES 2026', 'Consumer Electronics Show'],
                fullName: 'CES 2026',
                description: 'Consumer Electronics Show. Technology, innovation, gadgets, AI, automotive tech, smart home, and emerging technologies.',
                icon: 'fa-microchip'
            },
            {
                names: ['GITEX', 'GITEX Dubai', 'GITEX Global'],
                fullName: 'GITEX Dubai 2026',
                description: 'Gulf Information Technology Exhibition. Tech, AI, cybersecurity, cloud, startups, fintech, and digital transformation.',
                icon: 'fa-globe'
            },
            {
                names: ['MEDICA', 'MEDICA Düsseldorf'],
                fullName: 'MEDICA 2026',
                description: 'International trade fair for medical technology. Laboratory equipment, diagnostics, physiotherapy, IT systems.',
                icon: 'fa-hospital'
            },
            {
                names: ['HIMSS', 'HIMSS Global'],
                fullName: 'HIMSS 2026',
                description: 'Healthcare Information and Management Systems Society. Health IT, interoperability, digital health innovation.',
                icon: 'fa-laptop-medical'
            },
            {
                names: ['DMEXCO', 'DMEXCO Cologne'],
                fullName: 'DMEXCO 2026',
                description: 'Digital Marketing Expo & Conference. MarTech, AdTech, digital advertising, e-commerce.',
                icon: 'fa-chart-line'
            }
        ];

        function handleEventNameInput() {
            const input = document.getElementById('settEventName');
            const dropdown = document.getElementById('eventSuggestionsDropdown');
            if (!input || !dropdown) return;

            const query = input.value.trim().toLowerCase();

            if (query.length === 0) {
                dropdown.classList.add('hidden');
                return;
            }

            // Filter matching events
            const matches = EVENT_TEMPLATES.filter(event =>
                event.names.some(name => name.toLowerCase().includes(query))
            );

            if (matches.length === 0) {
                dropdown.classList.add('hidden');
                return;
            }

            // Render suggestions
            dropdown.innerHTML = matches.map(event => `
                <div onclick="selectEventSuggestion('${event.fullName.replace(/'/g, "\\'")}', '${event.description.replace(/'/g, "\\'")}')"
                     class="px-4 py-3 hover:bg-orange-50 cursor-pointer border-b border-gray-100 last:border-b-0">
                    <div class="flex items-start gap-3">
                        <i class="fas ${event.icon} text-orange-500 text-lg mt-0.5"></i>
                        <div class="flex-1">
                            <div class="font-semibold text-gray-900 text-sm">${event.fullName}</div>
                            <div class="text-xs text-gray-600 mt-0.5">${event.description.substring(0, 80)}...</div>
                        </div>
                    </div>
                </div>
            `).join('');

            dropdown.classList.remove('hidden');
        }

        function selectEventSuggestion(fullName, description) {
            document.getElementById('settEventName').value = fullName;
            document.getElementById('settEventDesc').value = description;
            document.getElementById('eventSuggestionsDropdown').classList.add('hidden');
            showToast('Event auto-filled! Review and click Save.', 'success');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('eventSuggestionsDropdown');
            const input = document.getElementById('settEventName');
            if (dropdown && input && !dropdown.contains(e.target) && !input.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // ==================== EXPO / EXHIBITOR FUNCTIONS ====================
        let exhibitorCache = [];
        let exhibitorCategories = [];

        async function loadExhibitors() {
            // Use user's event or ALWAYS default to WHX Dubai 2026 (works for all users, not just admin)
            let eventName = 'WHX Dubai 2026';
            let eventDesc = 'World Health Expo - Dubai 2026';
            try {
                if (AppState.userProfile && AppState.userProfile.current_event_name) {
                    eventName = AppState.userProfile.current_event_name;
                }
                if (AppState.userProfile && AppState.userProfile.current_event_description) {
                    eventDesc = AppState.userProfile.current_event_description;
                }
            } catch (e) { console.warn('[EXPO] Error reading profile event:', e); }

            // Update header with event name and description
            document.getElementById('expoEventName').textContent = eventName;
            document.getElementById('expoEventDetails').textContent = eventDesc || 'Loading exhibitors...';

            // Show loading state
            const exhibitorList = document.getElementById('exhibitorList');
            if (exhibitorList) {
                exhibitorList.innerHTML = '<div class="p-8 text-center text-gray-400"><i class="fas fa-spinner fa-spin text-3xl mb-3"></i><p>Loading exhibitors...</p></div>';
            }

            try {
                const response = await resilientFetch(`${CONFIG.API_BASE_URL}/exhibitors/?event=${encodeURIComponent(eventName)}&limit=200`, {
                    headers: { 'X-API-Key': CONFIG.API_KEY }
                });
                const data = await response.json();
                if (data.status === 'success') {
                    exhibitorCache = data.exhibitors || [];
                    renderExhibitors(exhibitorCache);
                    loadExhibitorCategories();
                } else if (data.status === 'error') {
                    document.getElementById('exhibitorList').innerHTML = `<p class="text-center text-gray-500 py-8">${data.detail || 'Failed to load exhibitors'}</p>`;
                }
            } catch (error) {
                console.error('Failed to load exhibitors:', error, 'Event:', eventName, 'Profile:', JSON.stringify(AppState.userProfile));
                document.getElementById('exhibitorList').innerHTML = '<p class="text-center text-gray-500 py-8">No exhibitor data available for this event.</p>';
            }
        }

        async function loadExhibitorCategories() {
            const eventName = AppState.userProfile?.current_event_name || 'WHX Dubai 2026';

            try {
                const response = await resilientFetch(`${CONFIG.API_BASE_URL}/exhibitors/categories/?event=${encodeURIComponent(eventName)}`, {
                    headers: { 'X-API-Key': CONFIG.API_KEY }
                });
                const data = await response.json();
                if (data.status === 'success') {
                    exhibitorCategories = data.categories || [];
                    renderCategoryFilters();
                }
            } catch (error) {
                console.error('Failed to load categories:', error);
            }
        }

        function renderCategoryFilters() {
            const container = document.getElementById('categoryFilter');
            let html = '<button onclick="filterByCategory(\'\')" class="category-btn active px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full whitespace-nowrap text-xs font-medium">All</button>';
            exhibitorCategories.forEach(cat => {
                html += `<button onclick="filterByCategory('${cat.replace(/'/g, "\\'")}')" class="category-btn px-3 py-1 bg-gray-100 text-gray-600 rounded-full whitespace-nowrap text-xs font-medium">${cat}</button>`;
            });
            container.innerHTML = html;
        }

        function filterByCategory(category) {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('bg-emerald-100', 'text-emerald-700', 'active');
                btn.classList.add('bg-gray-100', 'text-gray-600');
            });
            event.target.classList.add('bg-emerald-100', 'text-emerald-700', 'active');
            event.target.classList.remove('bg-gray-100', 'text-gray-600');

            const filtered = category ? exhibitorCache.filter(e => e.category.includes(category)) : exhibitorCache;
            renderExhibitors(filtered);
        }

        function filterExhibitors() {
            const search = document.getElementById('expoSearchInput').value.toLowerCase();
            const filtered = exhibitorCache.filter(e =>
                e.name.toLowerCase().includes(search) ||
                (e.category || '').toLowerCase().includes(search) ||
                (e.country || '').toLowerCase().includes(search)
            );
            renderExhibitors(filtered);
        }

        function renderExhibitors(exhibitors) {
            const container = document.getElementById('exhibitorList');
            if (!exhibitors || exhibitors.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">No exhibitors found. Check back after data is imported.</p>';
                return;
            }

            let html = `<p class="text-sm text-gray-500 mb-2">${exhibitors.length} exhibitors</p>`;
            exhibitors.forEach(ex => {
                // Verification badge
                let verificationBadge = '';
                if (ex.verification === 'verified') {
                    verificationBadge = '<span class="text-xs px-2 py-0.5 bg-green-100 text-green-700 rounded-full font-medium"><i class="fas fa-check-circle mr-1"></i>Verified Booth</span>';
                } else if (ex.verification === 'confirmed') {
                    verificationBadge = '<span class="text-xs px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full font-medium"><i class="fas fa-info-circle mr-1"></i>Confirmed</span>';
                } else {
                    verificationBadge = '<span class="text-xs px-2 py-0.5 bg-gray-100 text-gray-600 rounded-full font-medium"><i class="fas fa-tilde mr-1"></i>Estimated</span>';
                }

                html += `
                <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100" onclick="showExhibitorDetail('${ex.name.replace(/'/g, "\\'")}')">
                    <div class="flex items-start justify-between">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <h4 class="font-semibold text-gray-900 truncate">${ex.name}</h4>
                                ${verificationBadge}
                            </div>
                            ${ex.category ? `<p class="text-xs text-emerald-600 mt-0.5">${ex.category}</p>` : ''}
                            <div class="flex items-center gap-3 mt-1 text-xs text-gray-500">
                                ${ex.booth ? `<span><i class="fas fa-map-pin mr-1"></i>${ex.booth}${ex.hall ? `, ${ex.hall}` : ''}</span>` : ''}
                                ${ex.country ? `<span><i class="fas fa-globe mr-1"></i>${ex.country}</span>` : ''}
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); askAIAboutExhibitor('${ex.name.replace(/'/g, "\\'")}')"
                                class="ml-2 px-3 py-1.5 bg-purple-50 text-purple-600 rounded-lg text-xs font-medium active:bg-purple-100">
                            <i class="fas fa-robot mr-1"></i>Ask AI
                        </button>
                    </div>
                    ${ex.description ? `<p class="text-xs text-gray-500 mt-2 line-clamp-2">${ex.description}</p>` : ''}
                </div>`;
            });
            container.innerHTML = html;
        }

        function showExhibitorDetail(name) {
            const ex = exhibitorCache.find(e => e.name === name);
            if (!ex) return;

            // Use the AI chat to get info
            switchScreen('chat');
            const query = `Tell me about the exhibitor "${ex.name}"${ex.booth ? ` at booth ${ex.booth}` : ''}. What do they do and why might they be relevant to my goals?`;
            document.getElementById('chatInput').value = query;
            document.getElementById('chatInput').focus();
        }

        function askAIAboutExhibitor(name) {
            switchScreen('chat');
            const query = `Should I visit "${name}" at the expo? What's their relevance to my business and what should I pitch?`;
            document.getElementById('chatInput').value = query;
            document.getElementById('chatInput').focus();
        }

        // ==================== LEAD SCORING FUNCTIONS ====================
        async function scoreContact(contactId) {
            showToast('Scoring contact...', 'info');
            try {
                const response = await resilientFetch(
                    `${CONFIG.API_BASE_URL}/contact/${contactId}/score?user_id=${AppState.currentUser.user_id}`,
                    {
                        method: 'POST',
                        headers: { 'X-API-Key': CONFIG.API_KEY }
                    }
                );
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    showToast(`Score: ${data.score}/100 (${data.temperature})`, 'success');
                    // Update local state
                    const contact = AppState.contacts.find(c => c.id === contactId);
                    if (contact) {
                        contact.lead_score = data.score;
                        contact.lead_temperature = data.temperature;
                        contact.lead_score_reasoning = data.reasoning;
                    }
                    renderContacts(AppState.contacts);
                    return data;
                } else {
                    showToast('Scoring failed', 'error');
                    return null;
                }
            } catch (error) {
                showToast('Network error', 'error');
                console.error('Score error:', error);
                return null;
            }
        }

        async function scoreAllContacts() {
            const btn = document.getElementById('scoreAllBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Scoring...';
            btn.disabled = true;

            try {
                const response = await resilientFetch(
                    `${CONFIG.API_BASE_URL}/contacts/score_all?user_id=${AppState.currentUser.user_id}`,
                    {
                        method: 'POST',
                        headers: { 'X-API-Key': CONFIG.API_KEY }
                    }
                );
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    showToast(`Scored ${data.scored} contacts (${data.skipped} already scored)`, 'success');
                    loadContacts();
                    loadDashboardStats();
                } else {
                    showToast('Scoring failed', 'error');
                }
            } catch (error) {
                showToast('Network error', 'error');
                console.error('Score all error:', error);
            }

            btn.innerHTML = '<i class="fas fa-bolt mr-2"></i>Score All Contacts';
            btn.disabled = false;
        }

        async function loadDashboardStats() {
            try {
                const response = await resilientFetch(
                    `${CONFIG.API_BASE_URL}/dashboard?user_id=${AppState.currentUser.user_id}`,
                    { headers: { 'X-API-Key': CONFIG.API_KEY } }
                );
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    document.getElementById('statHot').textContent = data.by_temperature.hot || 0;
                    document.getElementById('statWarm').textContent = data.by_temperature.warm || 0;
                    document.getElementById('statCold').textContent = data.by_temperature.cold || 0;
                }
            } catch (error) {
                console.error('Dashboard stats error:', error);
            }
        }

        // ==================== ENHANCED CONTACT DETAIL ====================
        // Override openContactDetail to include lead score section
        const _originalOpenContactDetail = openContactDetail;
        openContactDetail = function(contactId) {
            const contact = AppState.contacts.find(c => c.id === contactId);
            if (!contact) return;

            // Call original to set up the base view
            _originalOpenContactDetail(contactId);

            // Hide FAB so it doesn't overlap delete button
            const fab = document.getElementById('contactsFab');
            if (fab) fab.style.display = 'none';

            // Now inject lead score section if score exists
            const detailContent = document.getElementById('contactDetailContent');
            const actionsSection = detailContent.querySelector('.flex.gap-3.pt-2.pb-24');
            if (!actionsSection) return;

            const score = contact.lead_score;
            const temp = contact.lead_temperature;
            const reasoning = contact.lead_score_reasoning || '';
            const scoreColor = temp === 'hot' ? 'border-red-500 text-red-600' : temp === 'warm' ? 'border-orange-400 text-orange-500' : temp === 'cold' ? 'border-gray-400 text-gray-500' : 'border-gray-300 text-gray-400';
            const scoreBg = temp === 'hot' ? 'bg-red-50' : temp === 'warm' ? 'bg-orange-50' : temp === 'cold' ? 'bg-gray-50' : 'bg-gray-50';
            const tempLabel = temp ? temp.charAt(0).toUpperCase() + temp.slice(1) + ' Lead' : 'Not Scored';

            const scoreSection = document.createElement('div');
            scoreSection.className = 'bg-white rounded-xl p-4 shadow-sm';
            scoreSection.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Lead Score</h3>
                    <button onclick="scoreContactAndRefresh('${contactId}')" class="text-xs text-blue-600 font-medium">
                        <i class="fas fa-sync-alt mr-1"></i>${score != null ? 'Rescore' : 'Score Now'}
                    </button>
                </div>
                ${score != null ? `
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 rounded-full border-4 ${scoreColor} flex items-center justify-center ${scoreBg}">
                        <span class="text-2xl font-bold">${score}</span>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-semibold ${scoreColor}">${tempLabel}</p>
                        <p class="text-xs text-gray-500 mt-1">${escapeHtml(reasoning)}</p>
                    </div>
                </div>
                ` : `
                <div class="text-center py-4">
                    <p class="text-sm text-gray-400 italic">Not scored yet. Tap "Score Now" to analyze this lead.</p>
                </div>
                `}
            `;

            actionsSection.parentElement.insertBefore(scoreSection, actionsSection);
        };

        async function scoreContactAndRefresh(contactId) {
            const result = await scoreContact(contactId);
            if (result) { openContactDetail(contactId); }
        }

        // ==================== ADMIN DASHBOARD ====================
        async function loadAdminDashboard() {
            try {
                const resp = await resilientFetch(`${CONFIG.API_BASE_URL}/admin/dashboard?user_id=${AppState.currentUser.user_id}`, { headers: { 'X-API-Key': CONFIG.API_KEY } });
                const data = await resp.json();
                if (!resp.ok || data.status !== 'success') { showToast(data.detail || 'Admin access denied', 'error'); return; }
                document.getElementById('adminStatUsers').textContent = data.total_users;
                document.getElementById('adminStatContacts').textContent = data.total_contacts;
                document.getElementById('adminStatHot').textContent = data.by_temperature.hot;
                document.getElementById('adminStatWarm').textContent = data.by_temperature.warm;
                window._adminUsers = data.per_user; // Cache for merge picker
                document.getElementById('adminTeamList').innerHTML = data.per_user.map(u => {
                    // Activity status based on last scan time
                    const lastScan = u.last_scan_at ? new Date(u.last_scan_at) : null;
                    const minsSinceLastScan = lastScan ? Math.floor((Date.now() - lastScan) / 60000) : 9999;
                    const activityDot = minsSinceLastScan < 30 ? 'bg-green-500' : minsSinceLastScan < 120 ? 'bg-yellow-400' : 'bg-gray-300';
                    const activityLabel = minsSinceLastScan < 30 ? 'Active' : minsSinceLastScan < 120 ? 'Recent' : lastScan ? formatTimestamp(u.last_scan_at) : 'No scans';
                    // Temperature bar
                    const total = (u.hot_count || 0) + (u.warm_count || 0) + (u.cold_count || 0);
                    const hotPct = total ? Math.round((u.hot_count || 0) / total * 100) : 0;
                    const warmPct = total ? Math.round((u.warm_count || 0) / total * 100) : 0;
                    const coldPct = total ? 100 - hotPct - warmPct : 0;
                    return `<div onclick="openUserDrilldown('${u.user_id}', '${escapeHtml(u.name)}', '${escapeHtml(u.email)}')" class="py-3 border-b border-gray-50 last:border-0 cursor-pointer hover:bg-gray-50 rounded-lg px-2 -mx-2 transition">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="relative">
                                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-400 to-blue-400 flex items-center justify-center text-white font-bold text-sm">${u.name.charAt(0).toUpperCase()}</div>
                                    <div class="absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 ${activityDot} rounded-full border-2 border-white"></div>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">${escapeHtml(u.name)}${u.is_admin ? ' <span class="text-[10px] bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded ml-1">Admin</span>' : ''}</p>
                                    <p class="text-xs text-gray-400">${activityLabel}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-semibold text-gray-700">${u.today_count || 0} <span class="text-xs text-gray-400 font-normal">today</span> / ${u.contact_count} <span class="text-xs text-gray-400 font-normal">total</span></p>
                                <div class="flex gap-1 text-[10px] mt-0.5 justify-end">
                                    <span class="text-red-500">${u.hot_count || 0}H</span>
                                    <span class="text-orange-500">${u.warm_count || 0}W</span>
                                    <span class="text-gray-400">${u.cold_count || 0}C</span>
                                </div>
                            </div>
                        </div>
                        ${total > 0 ? `<div class="flex h-1.5 rounded-full overflow-hidden mt-2 bg-gray-100"><div class="bg-red-500" style="width:${hotPct}%"></div><div class="bg-orange-400" style="width:${warmPct}%"></div><div class="bg-gray-300" style="width:${coldPct}%"></div></div>` : ''}
                        ${!u.is_admin ? `<div class="flex gap-3 mt-2">
                            <button onclick="event.stopPropagation(); startUserMerge('${u.user_id}', '${escapeHtml(u.name)}')" class="text-xs text-purple-400 hover:text-purple-600"><i class="fas fa-code-branch mr-1"></i>Merge into...</button>
                            <button onclick="event.stopPropagation(); adminDeleteUser('${u.user_id}', '${escapeHtml(u.name)}')" class="text-xs text-red-400 hover:text-red-600"><i class="fas fa-trash mr-1"></i>Remove user</button>
                        </div>` : ''}
                    </div>`;
                }).join('');

                // Update webhook status
                const webhookConfigured = data.webhook_configured;
                const webhookStatus = document.getElementById('webhookStatus');
                const webhookIndicator = document.getElementById('webhookIndicator');

                if (webhookConfigured) {
                    webhookStatus.textContent = 'Configured and active' + (data.webhook_url_preview ? ' (' + data.webhook_url_preview + ')' : '');
                    webhookIndicator.className = 'w-3 h-3 rounded-full bg-green-500';
                } else {
                    webhookStatus.textContent = 'Not configured';
                    webhookIndicator.className = 'w-3 h-3 rounded-full bg-red-500';
                }

                // Load saved webhook URL into input
                const savedUrl = localStorage.getItem('event_scout_webhook_url');
                const webhookInput = document.getElementById('webhookUrlInput');
                if (webhookInput && savedUrl) webhookInput.value = savedUrl;
                else if (webhookInput && data.webhook_url_preview) webhookInput.placeholder = data.webhook_url_preview + '...';

                // Load activity feed and pipeline monitor
                loadAdminActivity();
                loadPipelineMonitor();
            } catch (err) { console.error('Admin dashboard error:', err); showToast('Failed to load admin data', 'error'); }
        }

        async function testWebhook(customPayload) {
            const btn = event?.target?.closest('button') || document.querySelector('[onclick="testWebhook()"]');
            const originalHTML = btn?.innerHTML || '';
            const customUrl = document.getElementById('webhookUrlInput')?.value?.trim();

            try {
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Testing...';
                }

                showToast('Testing webhook connection...', 'info');

                let url = `${CONFIG.API_BASE_URL}/admin/webhook/test?user_id=${AppState.currentUser.user_id}`;
                if (customUrl) url += `&webhook_url=${encodeURIComponent(customUrl)}`;

                const fetchOpts = {
                    method: 'POST',
                    headers: { 'X-API-Key': CONFIG.API_KEY }
                };
                if (customPayload) {
                    fetchOpts.headers['Content-Type'] = 'application/json';
                    fetchOpts.body = JSON.stringify(customPayload);
                }

                const response = await resilientFetch(url, fetchOpts);
                const data = await response.json();

                const webhookStatus = document.getElementById('webhookStatus');
                const webhookIndicator = document.getElementById('webhookIndicator');

                if (data.status === 'success') {
                    webhookStatus.textContent = 'Connected - ' + data.message;
                    webhookIndicator.className = 'w-3 h-3 rounded-full bg-green-500';
                    showToast(data.message, 'success');
                    return true;
                } else {
                    webhookStatus.textContent = 'Error - ' + data.message;
                    webhookIndicator.className = 'w-3 h-3 rounded-full bg-red-500';
                    showToast(data.message, 'error');
                    return false;
                }
            } catch (error) {
                console.error('Test webhook error:', error);
                showToast('Failed to test webhook - check network connection', 'error');
                return false;
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalHTML || '<i class="fas fa-paper-plane"></i> Test';
                }
            }
        }

        async function saveAndTestWebhook() {
            const customUrl = document.getElementById('webhookUrlInput')?.value?.trim();
            if (!customUrl) { showToast('Enter a webhook URL first', 'error'); return; }
            localStorage.setItem('event_scout_webhook_url', customUrl);

            const btn = event?.target?.closest('button');
            const originalHTML = btn?.innerHTML || '';
            if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...'; }

            try {
                let url = `${CONFIG.API_BASE_URL}/admin/webhook/test?user_id=${AppState.currentUser.user_id}&webhook_url=${encodeURIComponent(customUrl)}&save=true`;
                const response = await resilientFetch(url, { method: 'POST', headers: { 'X-API-Key': CONFIG.API_KEY } });
                const data = await response.json();
                if (data.status === 'success') {
                    showToast('Webhook URL saved and tested!', 'success');
                    document.getElementById('webhookStatus').textContent = 'Connected - Saved';
                    document.getElementById('webhookIndicator').className = 'w-3 h-3 rounded-full bg-green-500';
                } else {
                    showToast('Saved locally, but test failed: ' + data.message, 'warning');
                    document.getElementById('webhookStatus').textContent = 'Saved - Test failed';
                    document.getElementById('webhookIndicator').className = 'w-3 h-3 rounded-full bg-yellow-500';
                }
            } catch (err) {
                localStorage.setItem('event_scout_webhook_url', customUrl);
                showToast('Saved locally (backend unreachable)', 'warning');
            } finally {
                if (btn) { btn.disabled = false; btn.innerHTML = originalHTML || '<i class="fas fa-save"></i> Save & Test'; }
            }
        }

        // Real-time admin activity feed
        async function loadAdminActivity() {
            try {
                const response = await resilientFetch(
                    `${CONFIG.API_BASE_URL}/admin/activity?user_id=${AppState.currentUser.user_id}&limit=20`,
                    { headers: { 'X-API-Key': CONFIG.API_KEY } }
                );
                const data = await response.json();

                const feedContainer = document.getElementById('adminActivityFeed');

                if (!response.ok || !data.activities || data.activities.length === 0) {
                    feedContainer.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">No recent activity</p>';
                    return;
                }

                feedContainer.innerHTML = data.activities.map(act => {
                    const tempClass = act.lead_temperature === 'hot' ? 'bg-red-100 text-red-600' :
                                     act.lead_temperature === 'warm' ? 'bg-orange-100 text-orange-600' : 'bg-gray-100 text-gray-600';
                    const tempIcon = act.lead_temperature === 'hot' ? 'text-red-600' :
                                    act.lead_temperature === 'warm' ? 'text-orange-600' : 'text-gray-600';

                    const sourceIcon = act.source === 'scan' ? '<i class="fas fa-camera text-blue-500"></i>' : '<i class="fas fa-user-plus text-gray-500"></i>';
                    const timeAgo = formatTimestamp(act.timestamp);

                    return `
                        <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg border border-gray-100 hover:bg-gray-100 transition cursor-pointer" onclick="openAdminContactDetail('${act.contact_id}', '${act.user_id}')">
                            <div class="w-10 h-10 rounded-full ${tempClass} flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-user text-sm ${tempIcon}"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900 truncate">${escapeHtml(act.contact_name)}</p>
                                <p class="text-xs text-gray-500">${escapeHtml(act.company)} • by ${escapeHtml(act.user_name)}</p>
                                <p class="text-xs text-gray-400">${timeAgo}</p>
                            </div>
                            <div class="flex flex-col items-end gap-1 flex-shrink-0">
                                ${sourceIcon}
                                ${act.lead_score != null ? `<span class="text-xs font-bold ${tempIcon}">${act.lead_score}</span>` : '<span class="text-xs text-gray-300">--</span>'}
                            </div>
                            <button onclick="event.stopPropagation(); adminDeleteContact('${act.contact_id}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition flex-shrink-0" title="Delete contact">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Load admin activity error:', error);
                document.getElementById('adminActivityFeed').innerHTML = '<p class="text-sm text-red-500 text-center py-4">Failed to load activity feed</p>';
            }
        }

        // Admin delete contact
        async function adminDeleteContact(contactId) {
            if (!confirm('Delete this contact? This cannot be undone.')) return;

            try {
                const response = await resilientFetch(
                    `${CONFIG.API_BASE_URL}/admin/contact/${contactId}?user_id=${AppState.currentUser.user_id}`,
                    {
                        method: 'DELETE',
                        headers: { 'X-API-Key': CONFIG.API_KEY }
                    }
                );

                const data = await response.json();

                if (response.ok && data.status === 'success') {
                    showToast('Contact deleted', 'success');
                    loadAdminActivity(); // Reload feed
                    loadAdminDashboard(); // Reload stats
                } else {
                    showToast(data.detail || 'Failed to delete contact', 'error');
                }
            } catch (error) {
                console.error('Admin delete contact error:', error);
                showToast('Failed to delete contact', 'error');
            }
        }

        // Helper function to format timestamps
        function formatTimestamp(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours}h ago`;
            const diffDays = Math.floor(diffHours / 24);
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }

        // Auto-refresh admin dashboard every 30 seconds
        let adminAutoRefreshInterval = null;

        function startAdminAutoRefresh() {
            if (adminAutoRefreshInterval) clearInterval(adminAutoRefreshInterval);

            adminAutoRefreshInterval = setInterval(() => {
                if (AppState.activeScreen === 'admin') {
                    loadAdminDashboard();
                    loadAdminActivity();
                }
            }, 30000); // 30 seconds
        }

        function stopAdminAutoRefresh() {
            if (adminAutoRefreshInterval) {
                clearInterval(adminAutoRefreshInterval);
                adminAutoRefreshInterval = null;
            }
        }

        // ==================== ADMIN COMMAND CENTER FUNCTIONS ====================

        // --- Admin Search ---
        let adminSearchTimeout = null;
        function debounceAdminSearch() {
            clearTimeout(adminSearchTimeout);
            const term = document.getElementById('adminSearchInput').value.trim();
            const resultsDiv = document.getElementById('adminSearchResults');
            if (!term) { resultsDiv.classList.add('hidden'); resultsDiv.innerHTML = ''; return; }
            adminSearchTimeout = setTimeout(() => adminSearch(term), 300);
        }

        async function adminSearch(term) {
            const resultsDiv = document.getElementById('adminSearchResults');
            resultsDiv.classList.remove('hidden');
            resultsDiv.innerHTML = '<p class="text-sm text-gray-400 text-center py-3"><i class="fas fa-spinner fa-spin mr-1"></i>Searching...</p>';
            try {
                const resp = await resilientFetch(`${CONFIG.API_BASE_URL}/admin/search?q=${encodeURIComponent(term)}&user_id=${AppState.currentUser.user_id}`, { headers: { 'X-API-Key': CONFIG.API_KEY } });
                const data = await resp.json();
                if (!resp.ok || !data.contacts || data.contacts.length === 0) {
                    resultsDiv.innerHTML = '<p class="text-sm text-gray-400 text-center py-3">No results found</p>';
                    return;
                }
                resultsDiv.innerHTML = `<p class="text-xs text-gray-400 mb-2">${data.total} result${data.total !== 1 ? 's' : ''}</p>` + data.contacts.map(c => {
                    const tempBadge = c.lead_temperature === 'hot' ? '<span class="text-[10px] bg-red-100 text-red-600 px-1.5 py-0.5 rounded">Hot</span>' :
                                      c.lead_temperature === 'warm' ? '<span class="text-[10px] bg-orange-100 text-orange-600 px-1.5 py-0.5 rounded">Warm</span>' :
                                      c.lead_temperature === 'cold' ? '<span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">Cold</span>' : '';
                    return `<div onclick="openAdminContactDetail('${c.id}', '${c.user_id}')" class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition">
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">${escapeHtml(c.name)} ${tempBadge}</p>
                            <p class="text-xs text-gray-500 truncate">${escapeHtml(c.company_name)} &middot; ${escapeHtml(c.user_name)}</p>
                        </div>
                        <div class="text-right flex-shrink-0">
                            ${c.lead_score != null ? `<span class="text-sm font-bold text-gray-700">${c.lead_score}</span>` : ''}
                            <i class="fas fa-chevron-right text-gray-300 ml-2"></i>
                        </div>
                    </div>`;
                }).join('');
            } catch (err) { console.error('Admin search error:', err); resultsDiv.innerHTML = '<p class="text-sm text-red-500 text-center py-3">Search failed</p>'; }
        }

        // --- Broadcast ---
        async function sendBroadcast() {
            const msg = document.getElementById('broadcastMessage').value.trim();
            const priority = document.getElementById('broadcastPriority').value;
            if (!msg) { showToast('Enter a message', 'error'); return; }
            try {
                const resp = await resilientFetch(`${CONFIG.API_BASE_URL}/admin/broadcast?user_id=${AppState.currentUser.user_id}&message=${encodeURIComponent(msg)}&priority=${priority}`, {
                    method: 'POST', headers: { 'X-API-Key': CONFIG.API_KEY }
                });
                const data = await resp.json();
                if (resp.ok && data.status === 'success') {
                    showToast('Broadcast sent!', 'success');
                    document.getElementById('broadcastMessage').value = '';
                    loadBroadcastHistory();
                } else { showToast(data.detail || 'Failed to send', 'error'); }
            } catch (err) { console.error('Broadcast error:', err); showToast('Failed to send broadcast', 'error'); }
        }

        async function loadBroadcastHistory() {
            try {
                const resp = await resilientFetch(`${CONFIG.API_BASE_URL}/broadcasts/active?user_id=${AppState.currentUser.user_id}`, { headers: { 'X-API-Key': CONFIG.API_KEY } });
                const data = await resp.json();
                const container = document.getElementById('broadcastHistory');
                if (!container) return;
                if (data.broadcasts && data.broadcasts.length > 0) {
                    container.classList.remove('hidden');
                    container.innerHTML = '<p class="text-xs text-gray-400 mb-1">Active broadcasts:</p>' + data.broadcasts.map(b =>
                        `<div class="flex items-center justify-between p-2 ${b.priority === 'urgent' ? 'bg-red-50 border border-red-200' : 'bg-blue-50 border border-blue-200'} rounded-lg text-xs">
                            <div class="flex-1 min-w-0">
                                <span class="${b.priority === 'urgent' ? 'text-red-700' : 'text-blue-700'}">${escapeHtml(b.message)}</span>
                                <span class="text-gray-400 ml-1">${formatTimestamp(b.created_at)}</span>
                            </div>
                            <button onclick="dismissBroadcast('${b.id}')" class="ml-2 p-1 text-gray-400 hover:text-red-500" title="Dismiss"><i class="fas fa-times"></i></button>
                        </div>`
                    ).join('');
                } else { container.classList.add('hidden'); }
            } catch (err) { console.error('Load broadcasts error:', err); }
        }

        async function dismissBroadcast(broadcastId) {
            try {
                await resilientFetch(`${CONFIG.API_BASE_URL}/broadcasts/${broadcastId}/dismiss?user_id=${AppState.currentUser.user_id}`, {
                    method: 'POST', headers: { 'X-API-Key': CONFIG.API_KEY }
                });
                loadBroadcastHistory();
                checkBroadcasts();
            } catch (err) { console.error('Dismiss error:', err); }
        }

        // Check and display broadcasts for all users (banner at top)
        async function checkBroadcasts() {
            try {
                const resp = await resilientFetch(`${CONFIG.API_BASE_URL}/broadcasts/active?user_id=${AppState.currentUser.user_id}`, { headers: { 'X-API-Key': CONFIG.API_KEY } });
                const data = await resp.json();
                const banner = document.getElementById('broadcastBanner');
                if (!banner) return;
                if (data.broadcasts && data.broadcasts.length > 0) {
                    banner.classList.remove('hidden');
                    banner.innerHTML = data.broadcasts.map(b =>
                        `<div class="px-4 py-3 ${b.priority === 'urgent' ? 'bg-red-600' : 'bg-blue-600'} text-white text-sm flex items-center gap-2">
                            <i class="fas ${b.priority === 'urgent' ? 'fa-exclamation-triangle' : 'fa-bullhorn'} flex-shrink-0"></i>
                            <span class="flex-1">${escapeHtml(b.message)}</span>
                            <span class="text-xs opacity-70 flex-shrink-0">${b.admin_name}</span>
                        </div>`
                    ).join('');
                } else { banner.classList.add('hidden'); banner.innerHTML = ''; }
            } catch (err) { console.error('Check broadcasts error:', err); }
        }

        // --- User Drill-Down ---
        async function openUserDrilldown(userId, userName, userEmail) {
            currentDrilldownUserId = userId;
            drilldownSelectMode = false;
            drilldownSelectedIds.clear();
            const overlay = document.getElementById('adminUserDrilldown');
            overlay.classList.remove('hidden');
            document.getElementById('drilldownUserName').textContent = userName;
            document.getElementById('drilldownUserEmail').textContent = userEmail;
            document.getElementById('drilldownContactList').innerHTML = '<p class="text-sm text-gray-400 text-center py-8"><i class="fas fa-spinner fa-spin mr-2"></i>Loading contacts...</p>';
            document.getElementById('drilldownStats').innerHTML = '';
            document.getElementById('drilldownBulkActions').classList.add('hidden');
            const selectBtn = document.getElementById('drilldownSelectBtn');
            if (selectBtn) { selectBtn.classList.replace('bg-blue-500', 'bg-gray-100'); selectBtn.classList.replace('text-white', 'text-gray-600'); }

            try {
                const resp = await resilientFetch(`${CONFIG.API_BASE_URL}/admin/contacts?user_id=${AppState.currentUser.user_id}&filter_user=${userId}&limit=500`, { headers: { 'X-API-Key': CONFIG.API_KEY } });
                const data = await resp.json();
                if (!resp.ok || !data.contacts) { document.getElementById('drilldownContactList').innerHTML = '<p class="text-sm text-red-500 text-center py-4">Failed to load</p>'; return; }

                // Stats
                const contacts = data.contacts;
                const hot = contacts.filter(c => c.lead_temperature === 'hot').length;
                const warm = contacts.filter(c => c.lead_temperature === 'warm').length;
                const cold = contacts.filter(c => c.lead_temperature === 'cold').length;
                const unscored = contacts.length - hot - warm - cold;
                document.getElementById('drilldownStats').innerHTML = `
                    <div class="bg-gray-50 rounded-lg p-3 text-center"><p class="text-xl font-bold text-gray-700">${contacts.length}</p><p class="text-[10px] text-gray-400">Total</p></div>
                    <div class="bg-red-50 rounded-lg p-3 text-center"><p class="text-xl font-bold text-red-600">${hot}</p><p class="text-[10px] text-gray-400">Hot</p></div>
                    <div class="bg-orange-50 rounded-lg p-3 text-center"><p class="text-xl font-bold text-orange-500">${warm}</p><p class="text-[10px] text-gray-400">Warm</p></div>
                    <div class="bg-gray-50 rounded-lg p-3 text-center"><p class="text-xl font-bold text-gray-500">${cold + unscored}</p><p class="text-[10px] text-gray-400">Other</p></div>
                `;

                // Contact list
                if (contacts.length === 0) {
                    document.getElementById('drilldownContactList').innerHTML = '<p class="text-sm text-gray-400 text-center py-8">No contacts yet</p>';
                    return;
                }
                document.getElementById('drilldownContactList').innerHTML = contacts.map(c => {
                    const tempClass = c.lead_temperature === 'hot' ? 'bg-red-100 text-red-600' : c.lead_temperature === 'warm' ? 'bg-orange-100 text-orange-600' : 'bg-gray-100 text-gray-500';
                    const sourceIcon = c.source === 'scan' ? 'fa-camera text-blue-500' : 'fa-user-plus text-gray-400';
                    return `<div class="drilldown-contact-card flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition" onclick="if(drilldownSelectMode){this.querySelector('.drilldown-cb').click();event.stopPropagation();}else{openAdminContactDetail('${c.id}', '${c.user_id}')}">
                        <input type="checkbox" class="drilldown-cb hidden w-4 h-4 accent-blue-500 flex-shrink-0" onchange="toggleDrilldownContact('${c.id}', this)" onclick="event.stopPropagation()">
                        <div class="w-9 h-9 rounded-full ${tempClass} flex items-center justify-center flex-shrink-0"><i class="fas fa-user text-sm"></i></div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">${escapeHtml(c.name)}</p>
                            <p class="text-xs text-gray-500 truncate">${escapeHtml(c.company_name)} &middot; <i class="fas ${sourceIcon} text-[10px]"></i> ${formatTimestamp(c.created_at)}</p>
                        </div>
                        <div class="text-right flex-shrink-0">
                            ${c.lead_score != null ? `<p class="text-sm font-bold text-gray-700">${c.lead_score}</p>` : '<p class="text-xs text-gray-300">--</p>'}
                            <i class="fas fa-chevron-right text-gray-300"></i>
                        </div>
                    </div>`;
                }).join('');
            } catch (err) { console.error('Drilldown error:', err); document.getElementById('drilldownContactList').innerHTML = '<p class="text-sm text-red-500 text-center py-4">Failed to load contacts</p>'; }
        }

        function closeUserDrilldown() {
            document.getElementById('adminUserDrilldown').classList.add('hidden');
        }

        // --- Admin Contact Detail ---
        async function openAdminContactDetail(contactId, contactUserId) {
            const overlay = document.getElementById('adminContactDetail');
            const content = document.getElementById('adminContactDetailContent');
            overlay.classList.remove('hidden');
            content.innerHTML = '<p class="text-sm text-gray-400 text-center py-8"><i class="fas fa-spinner fa-spin mr-2"></i>Loading...</p>';

            try {
                const resp = await resilientFetch(`${CONFIG.API_BASE_URL}/admin/contacts?user_id=${AppState.currentUser.user_id}&filter_user=${contactUserId}&limit=500`, { headers: { 'X-API-Key': CONFIG.API_KEY } });
                const data = await resp.json();
                const contact = data.contacts?.find(c => c.id === contactId);
                if (!contact) { content.innerHTML = '<p class="text-sm text-red-500 text-center py-4">Contact not found</p>'; return; }

                const tempBadge = contact.lead_temperature === 'hot' ? '<span class="px-2 py-1 bg-red-100 text-red-600 rounded-full text-xs font-semibold">Hot</span>' :
                                  contact.lead_temperature === 'warm' ? '<span class="px-2 py-1 bg-orange-100 text-orange-600 rounded-full text-xs font-semibold">Warm</span>' :
                                  contact.lead_temperature === 'cold' ? '<span class="px-2 py-1 bg-gray-100 text-gray-500 rounded-full text-xs font-semibold">Cold</span>' :
                                  '<span class="px-2 py-1 bg-gray-100 text-gray-400 rounded-full text-xs">Unscored</span>';

                const linkedinLink = contact.linkedin && contact.linkedin !== 'N/A' ? `<a href="${contact.linkedin.startsWith('http') ? contact.linkedin : 'https://linkedin.com/in/' + contact.linkedin}" target="_blank" class="text-blue-600 hover:underline text-sm"><i class="fab fa-linkedin mr-1"></i>${escapeHtml(contact.linkedin)}</a>` : '';

                content.innerHTML = `
                    <!-- Header -->
                    <div class="text-center">
                        <div class="w-16 h-16 rounded-full bg-gradient-to-br from-purple-400 to-blue-400 flex items-center justify-center text-white font-bold text-2xl mx-auto mb-2">${contact.name.charAt(0).toUpperCase()}</div>
                        <h3 class="text-xl font-bold text-gray-900">${escapeHtml(contact.name)}</h3>
                        <p class="text-sm text-gray-500">${escapeHtml(contact.company_name)}</p>
                        <div class="flex items-center justify-center gap-2 mt-2">
                            ${tempBadge}
                            ${contact.lead_score != null ? `<span class="text-lg font-bold text-gray-700">${contact.lead_score}/100</span>` : ''}
                        </div>
                        <p class="text-xs text-gray-400 mt-1">Scanned by ${escapeHtml(contact.user_name)} &middot; ${formatTimestamp(contact.created_at)}</p>
                    </div>

                    <!-- Contact Info -->
                    <div class="bg-gray-50 rounded-xl p-4 space-y-2">
                        <h4 class="text-xs font-semibold text-gray-400 uppercase">Contact Info</h4>
                        ${contact.email && contact.email !== 'N/A' ? `<p class="text-sm"><i class="fas fa-envelope text-gray-400 w-5"></i> <a href="mailto:${contact.email}" class="text-blue-600">${escapeHtml(contact.email)}</a></p>` : ''}
                        ${contact.phone && contact.phone !== 'N/A' ? `<p class="text-sm"><i class="fas fa-phone text-gray-400 w-5"></i> <a href="tel:${contact.phone}" class="text-blue-600">${escapeHtml(contact.phone)}</a></p>` : ''}
                        ${linkedinLink ? `<p class="text-sm"><i class="fab fa-linkedin text-gray-400 w-5"></i> ${linkedinLink}</p>` : ''}
                        <p class="text-sm"><i class="fas ${contact.source === 'scan' ? 'fa-camera' : 'fa-user-plus'} text-gray-400 w-5"></i> Source: ${contact.source}</p>
                    </div>

                    <!-- Lead Intelligence -->
                    ${contact.lead_score_reasoning ? `<div class="bg-yellow-50 rounded-xl p-4 space-y-2 border border-yellow-200">
                        <h4 class="text-xs font-semibold text-yellow-700 uppercase"><i class="fas fa-brain mr-1"></i>Lead Intelligence</h4>
                        <p class="text-sm text-gray-700">${escapeHtml(contact.lead_score_reasoning)}</p>
                        ${contact.lead_recommended_actions?.length ? `<div class="mt-2"><p class="text-xs font-semibold text-gray-500 mb-1">Recommended Actions:</p>${contact.lead_recommended_actions.map(a => `<p class="text-xs text-gray-600 flex items-start gap-1"><i class="fas fa-check text-green-500 mt-0.5 flex-shrink-0"></i>${escapeHtml(a)}</p>`).join('')}</div>` : ''}
                    </div>` : ''}

                    <!-- User Notes -->
                    ${contact.notes ? `<div class="bg-gray-50 rounded-xl p-4">
                        <h4 class="text-xs font-semibold text-gray-400 uppercase mb-2">User Notes</h4>
                        <p class="text-sm text-gray-700 whitespace-pre-wrap">${escapeHtml(contact.notes)}</p>
                    </div>` : ''}

                    <!-- Admin Notes (editable) -->
                    <div class="bg-purple-50 rounded-xl p-4 border border-purple-200">
                        <h4 class="text-xs font-semibold text-purple-600 uppercase mb-2"><i class="fas fa-shield-alt mr-1"></i>Admin Intel</h4>
                        <textarea id="adminNoteTextarea" rows="3" class="w-full px-3 py-2 border border-purple-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-purple-300" placeholder="Add intel for the team..."
                                  onblur="saveAdminNote('${contact.id}')">${escapeHtml(contact.admin_notes || '')}</textarea>
                        <p class="text-[10px] text-purple-400 mt-1">Auto-saves when you click away. Visible to team as "Intel from HQ".</p>
                    </div>

                    <!-- Contact Documents -->
                    <div class="bg-blue-50 rounded-xl p-4 border border-blue-200">
                        <h4 class="text-xs font-semibold text-blue-600 uppercase mb-3"><i class="fas fa-folder-open mr-1"></i>Documents</h4>
                        <div class="space-y-2 mb-3">
                            <input type="file" id="contactFileInput" accept=".pdf,.ppt,.pptx,.doc,.docx,.png,.jpg,.jpeg" class="w-full text-xs file:mr-2 file:py-1.5 file:px-3 file:rounded-lg file:border-0 file:text-xs file:font-medium file:bg-blue-600 file:text-white">
                            <div class="flex gap-2">
                                <select id="contactFileCategory" class="flex-1 px-2 py-1.5 border border-blue-200 rounded-lg text-xs bg-white">
                                    <option value="research">Research</option>
                                    <option value="pitch">Pitch Deck</option>
                                    <option value="brief">Brief</option>
                                    <option value="other">Other</option>
                                </select>
                                <input type="text" id="contactFileDesc" placeholder="Description (optional)" class="flex-1 px-2 py-1.5 border border-blue-200 rounded-lg text-xs bg-white">
                            </div>
                            <button onclick="uploadContactFile('${contact.id}')" class="w-full py-2 bg-blue-600 text-white rounded-lg text-xs font-medium active:bg-blue-700">
                                <i class="fas fa-upload mr-1"></i>Upload Document
                            </button>
                        </div>
                        <div id="adminContactFiles" class="space-y-2">
                            <p class="text-xs text-blue-400 text-center py-2"><i class="fas fa-spinner fa-spin mr-1"></i>Loading files...</p>
                        </div>
                    </div>

                    <!-- AI Pipeline (Admin) -->
                    <div id="adminPipelineCard" class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-4 border border-indigo-200">
                        <h4 class="text-xs font-semibold text-indigo-600 uppercase mb-3"><i class="fas fa-robot mr-1"></i>AI Pipeline</h4>
                        <div id="adminPipelineSteps" class="flex flex-wrap gap-2 mb-2"></div>
                        <p id="adminPipelineStep" class="text-xs text-gray-500 italic mb-2"></p>
                        <div id="adminPipelineResearch" class="hidden mb-2">
                            <button onclick="togglePipelineSection('adminPipelineResearchText')" class="text-xs font-medium text-indigo-600"><i class="fas fa-chevron-right text-[10px]"></i> Research</button>
                            <div id="adminPipelineResearchText" class="hidden mt-1 text-xs text-gray-700 bg-white rounded-lg p-2 whitespace-pre-wrap max-h-32 overflow-y-auto"></div>
                        </div>
                        <div id="adminPipelinePitch" class="hidden mb-2">
                            <button onclick="togglePipelineSection('adminPipelinePitchText')" class="text-xs font-medium text-purple-600"><i class="fas fa-chevron-right text-[10px]"></i> Pitch & Email</button>
                            <div id="adminPipelinePitchText" class="hidden mt-1 text-xs text-gray-700 bg-white rounded-lg p-2 space-y-1 max-h-40 overflow-y-auto"></div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="runContactPipeline('${contact.id}')" class="flex-1 py-1.5 bg-indigo-600 text-white rounded-lg text-xs font-medium active:bg-indigo-700">
                                <i class="fas fa-play mr-1"></i>Run Pipeline
                            </button>
                            <button onclick="retryContactPipeline('${contact.id}')" class="py-1.5 px-3 bg-orange-100 text-orange-600 rounded-lg text-xs font-medium active:bg-orange-200">
                                <i class="fas fa-redo mr-1"></i>Retry
                            </button>
                        </div>
                    </div>

                    <!-- Links -->
                    ${contact.links?.length ? `<div class="bg-gray-50 rounded-xl p-4">
                        <h4 class="text-xs font-semibold text-gray-400 uppercase mb-2">Enrichment Links</h4>
                        ${contact.links.map(l => `<a href="${l.url}" target="_blank" class="block text-sm text-blue-600 hover:underline truncate mb-1"><i class="fas fa-external-link-alt text-xs mr-1"></i>${escapeHtml(l.label || l.url)}</a>`).join('')}
                    </div>` : ''}

                    <!-- Actions -->
                    <div class="space-y-2">
                        <div class="flex gap-2">
                            <button onclick="exportSingleContact('${contact.id}')" class="flex-1 px-4 py-2.5 bg-blue-50 text-blue-600 rounded-lg text-sm font-medium flex items-center justify-center gap-2">
                                <i class="fas fa-file-export"></i> Export CSV
                            </button>
                            <button onclick="triggerContactWebhook('${contact.id}')" class="flex-1 px-4 py-2.5 bg-purple-50 text-purple-600 rounded-lg text-sm font-medium flex items-center justify-center gap-2">
                                <i class="fas fa-paper-plane"></i> Send to n8n
                            </button>
                        </div>
                        <button onclick="adminDeleteContact('${contact.id}'); closeAdminContactDetail();" class="w-full px-4 py-2.5 bg-red-50 text-red-600 rounded-lg text-sm font-medium flex items-center justify-center gap-2">
                            <i class="fas fa-trash"></i> Delete Contact
                        </button>
                    </div>
                `;
                // Load contact documents
                loadContactFiles(contact.id, 'adminContactFiles', true);
                loadPipelineStatus(contact.id, true);
            } catch (err) { console.error('Contact detail error:', err); content.innerHTML = '<p class="text-sm text-red-500 text-center py-4">Failed to load contact</p>'; }
        }

        function closeAdminContactDetail() {
            document.getElementById('adminContactDetail').classList.add('hidden');
        }

        async function saveAdminNote(contactId) {
            const note = document.getElementById('adminNoteTextarea')?.value || '';
            try {
                const resp = await resilientFetch(`${CONFIG.API_BASE_URL}/admin/contact/${contactId}/note?user_id=${AppState.currentUser.user_id}&note=${encodeURIComponent(note)}`, {
                    method: 'PUT', headers: { 'X-API-Key': CONFIG.API_KEY }
                });
                if (resp.ok) { showToast('Admin note saved', 'success'); }
            } catch (err) { console.error('Save admin note error:', err); }
        }

        // --- Contact Document Functions ---
        async function uploadContactFile(contactId) {
            const fileInput = document.getElementById('contactFileInput');
            const categorySelect = document.getElementById('contactFileCategory');
            const descInput = document.getElementById('contactFileDesc');
            if (!fileInput.files.length) { showToast('Please select a file', 'error'); return; }
            const file = fileInput.files[0];
            if (file.size > 20 * 1024 * 1024) { showToast('File too large (max 20MB)', 'error'); return; }
            const formData = new FormData();
            formData.append('file', file);
            formData.append('description', descInput.value.trim());
            formData.append('category', categorySelect.value);
            try {
                showToast('Uploading...', 'info');
                const resp = await resilientFetch(`${CONFIG.API_BASE_URL}/admin/contact/${contactId}/files?user_id=${AppState.currentUser.user_id}`, {
                    method: 'POST', headers: { 'X-API-Key': CONFIG.API_KEY }, body: formData
                });
                const data = await resp.json();
                if (resp.ok) {
                    showToast('Document uploaded!', 'success');
                    fileInput.value = '';
                    descInput.value = '';
                    loadContactFiles(contactId, 'adminContactFiles', true);
                } else {
                    showToast(data.detail || 'Upload failed', 'error');
                }
            } catch (err) { console.error('Upload error:', err); showToast('Upload failed', 'error'); }
        }

        async function loadContactFiles(contactId, containerId, isAdmin) {
            const container = document.getElementById(containerId);
            if (!container) return;
            try {
                const resp = await resilientFetch(`${CONFIG.API_BASE_URL}/contact/${contactId}/files?user_id=${AppState.currentUser.user_id}`, {
                    headers: { 'X-API-Key': CONFIG.API_KEY }
                });
                const data = await resp.json();
                if (!resp.ok || !data.files?.length) {
                    container.innerHTML = '<p class="text-xs text-gray-400 text-center py-1">No documents yet</p>';
                    if (!isAdmin) { const s = document.getElementById('contactDocsSection'); if (s) s.classList.add('hidden'); }
                    return;
                }
                if (!isAdmin) { const s = document.getElementById('contactDocsSection'); if (s) s.classList.remove('hidden'); }
                container.innerHTML = data.files.map(f => `
                    <div class="flex items-center gap-2 bg-white rounded-lg p-2 border border-gray-100">
                        <div class="w-8 h-8 rounded-lg ${getCategoryColor(f.category)} flex items-center justify-center flex-shrink-0">
                            <i class="fas ${getFileIcon(f.file_type)} text-xs"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs font-medium text-gray-800 truncate">${escapeHtml(f.original_filename)}</p>
                            <p class="text-[10px] text-gray-400">${formatFileSize(f.file_size)} &middot; ${f.category}${f.description ? ' &middot; ' + escapeHtml(f.description) : ''}</p>
                        </div>
                        <button onclick="downloadContactFile('${f.id}', '${escapeHtml(f.original_filename).replace(/'/g, "\\'")}')" class="w-8 h-8 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center flex-shrink-0 active:bg-blue-100">
                            <i class="fas fa-download text-xs"></i>
                        </button>
                        ${isAdmin ? `<button onclick="deleteContactFile('${f.id}', '${contactId}', '${containerId}')" class="w-8 h-8 rounded-lg bg-red-50 text-red-600 flex items-center justify-center flex-shrink-0 active:bg-red-100">
                            <i class="fas fa-trash text-xs"></i>
                        </button>` : ''}
                    </div>
                `).join('');
            } catch (err) {
                console.error('Load files error:', err);
                container.innerHTML = '<p class="text-xs text-red-400 text-center py-1">Failed to load files</p>';
            }
        }

        async function downloadContactFile(fileId, filename) {
            try {
                showToast('Downloading...', 'info');
                const resp = await resilientFetch(`${CONFIG.API_BASE_URL}/contact/files/download/${fileId}?user_id=${AppState.currentUser.user_id}`, {
                    headers: { 'X-API-Key': CONFIG.API_KEY }
                });
                if (!resp.ok) throw new Error('Download failed');
                const blob = await resp.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = filename; a.click();
                URL.revokeObjectURL(url);
                showToast('Downloaded!', 'success');
            } catch (err) { console.error('Download error:', err); showToast('Download failed', 'error'); }
        }

        async function deleteContactFile(fileId, contactId, containerId) {
            if (!confirm('Delete this document?')) return;
            try {
                const resp = await resilientFetch(`${CONFIG.API_BASE_URL}/admin/contact/files/${fileId}?user_id=${AppState.currentUser.user_id}`, {
                    method: 'DELETE', headers: { 'X-API-Key': CONFIG.API_KEY }
                });
                if (resp.ok) { showToast('Document deleted', 'success'); loadContactFiles(contactId, containerId, true); }
                else { showToast('Delete failed', 'error'); }
            } catch (err) { console.error('Delete error:', err); showToast('Delete failed', 'error'); }
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function getFileIcon(fileType) {
            const icons = { pdf: 'fa-file-pdf', ppt: 'fa-file-powerpoint', pptx: 'fa-file-powerpoint', doc: 'fa-file-word', docx: 'fa-file-word', png: 'fa-file-image', jpg: 'fa-file-image', jpeg: 'fa-file-image' };
            return icons[fileType?.toLowerCase()] || 'fa-file';
        }

        function getCategoryColor(category) {
            const colors = { research: 'bg-green-100 text-green-600', pitch: 'bg-purple-100 text-purple-600', brief: 'bg-orange-100 text-orange-600', other: 'bg-gray-100 text-gray-600' };
            return colors[category] || 'bg-gray-100 text-gray-600';
        }

        // --- AI Pipeline Functions ---
        const PIPELINE_STEPS = ['research', 'score', 'pitch', 'deck', 'attach'];
        const PIPELINE_STEP_LABELS = { research: 'Research', score: 'Score', pitch: 'Pitch', deck: 'Deck', attach: 'Attach' };
        const PIPELINE_STATUS_MAP = {
            'pending': { done: [] },
            'researching': { done: [], active: 'research' },
            'scoring': { done: ['research'], active: 'score' },
            'pitching': { done: ['research', 'score'], active: 'pitch' },
            'generating_deck': { done: ['research', 'score', 'pitch'], active: 'deck' },
            'attaching': { done: ['research', 'score', 'pitch', 'deck'], active: 'attach' },
            'complete': { done: ['research', 'score', 'pitch', 'deck', 'attach'] },
            'complete_no_deck': { done: ['research', 'score', 'pitch'], skipped: ['deck', 'attach'] },
            'failed': { done: [] },
        };

        function renderPipelineSteps(status, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const info = PIPELINE_STATUS_MAP[status] || { done: [] };
            container.innerHTML = PIPELINE_STEPS.map(step => {
                let cls = 'bg-gray-100 text-gray-400';
                let icon = 'fa-circle';
                if (info.done?.includes(step)) { cls = 'bg-green-100 text-green-600'; icon = 'fa-check-circle'; }
                else if (info.active === step) { cls = 'bg-indigo-100 text-indigo-600'; icon = 'fa-spinner fa-spin'; }
                else if (info.skipped?.includes(step)) { cls = 'bg-yellow-100 text-yellow-500'; icon = 'fa-minus-circle'; }
                else if (status === 'failed') { cls = 'bg-red-100 text-red-500'; icon = 'fa-times-circle'; }
                return `<span class="px-2 py-1 rounded-full text-[10px] font-medium ${cls}"><i class="fas ${icon} mr-0.5"></i>${PIPELINE_STEP_LABELS[step]}</span>`;
            }).join('');
        }

        async function loadPipelineStatus(contactId, isAdmin = false) {
            const card = document.getElementById(isAdmin ? 'adminPipelineCard' : 'pipelineStatusCard');
            const stepsId = isAdmin ? 'adminPipelineSteps' : 'pipelineSteps';
            const stepTextId = isAdmin ? 'adminPipelineStep' : 'pipelineCurrentStep';
            try {
                const resp = await resilientFetch(`${CONFIG.API_BASE_URL}/contact/${contactId}/pipeline?user_id=${AppState.currentUser.user_id}`, {
                    headers: { 'X-API-Key': CONFIG.API_KEY }
                });
                const data = await resp.json();
                if (data.status === 'none') {
                    if (card && !isAdmin) card.classList.remove('hidden');
                    renderPipelineSteps('pending', stepsId);
                    const stepEl = document.getElementById(stepTextId);
                    if (stepEl) stepEl.textContent = 'Pipeline has not run yet. Tap "Run Pipeline" to start.';
                    return;
                }
                if (card) card.classList.remove('hidden');
                renderPipelineSteps(data.status, stepsId);
                const stepEl = document.getElementById(stepTextId);
                if (stepEl) stepEl.textContent = data.current_step || data.status;

                // Show research section if available
                const researchSection = document.getElementById(isAdmin ? 'adminPipelineResearch' : 'pipelineResearchSection');
                const researchContent = document.getElementById(isAdmin ? 'adminPipelineResearchText' : 'pipelineResearchContent');
                if (data.research_summary && researchSection && researchContent) {
                    researchSection.classList.remove('hidden');
                    researchContent.textContent = data.research_summary;
                }

                // Show pitch section if available
                const pitchSection = document.getElementById(isAdmin ? 'adminPipelinePitch' : 'pipelinePitchSection');
                const pitchContent = document.getElementById(isAdmin ? 'adminPipelinePitchText' : 'pipelinePitchContent');
                if (data.pitch_email_subject && pitchSection && pitchContent) {
                    pitchSection.classList.remove('hidden');
                    pitchContent.innerHTML = `<p class="font-medium">Subject: ${escapeHtml(data.pitch_email_subject)}</p><p class="mt-1 whitespace-pre-wrap">${escapeHtml(data.pitch_email_body || '')}</p>`;
                }

                // Update run button based on status
                const runBtn = document.getElementById('pipelineRunBtn');
                if (runBtn) {
                    if (['pending', 'failed', 'complete', 'complete_no_deck', 'none'].includes(data.status)) {
                        runBtn.disabled = false;
                        runBtn.innerHTML = data.status === 'failed'
                            ? '<i class="fas fa-redo mr-1"></i>Retry Pipeline'
                            : data.status.startsWith('complete')
                            ? '<i class="fas fa-redo mr-1"></i>Re-run Pipeline'
                            : '<i class="fas fa-play mr-1"></i>Run Pipeline';
                    } else {
                        runBtn.disabled = true;
                        runBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Running...';
                    }
                }

                // Auto-refresh if still running
                if (!['complete', 'complete_no_deck', 'failed', 'none'].includes(data.status)) {
                    setTimeout(() => loadPipelineStatus(contactId, isAdmin), 5000);
                }
            } catch (err) { console.error('Pipeline status error:', err); }
        }

        async function runContactPipeline(contactId) {
            try {
                showToast('Starting AI pipeline...', 'info');
                const resp = await resilientFetch(`${CONFIG.API_BASE_URL}/contact/${contactId}/pipeline/run?user_id=${AppState.currentUser.user_id}`, {
                    method: 'POST', headers: { 'X-API-Key': CONFIG.API_KEY }
                });
                const data = await resp.json();
                if (data.status === 'already_running') { showToast('Pipeline already running', 'warning'); return; }
                showToast('Pipeline started! Research in progress...', 'success');
                setTimeout(() => loadPipelineStatus(contactId, false), 3000);
            } catch (err) { console.error('Run pipeline error:', err); showToast('Failed to start pipeline', 'error'); }
        }

        async function retryContactPipeline(contactId) {
            try {
                const resp = await resilientFetch(`${CONFIG.API_BASE_URL}/contact/${contactId}/pipeline/retry?user_id=${AppState.currentUser.user_id}`, {
                    method: 'POST', headers: { 'X-API-Key': CONFIG.API_KEY }
                });
                if (resp.ok) { showToast('Pipeline restarted', 'success'); setTimeout(() => loadPipelineStatus(contactId, true), 3000); }
            } catch (err) { showToast('Retry failed', 'error'); }
        }

        function togglePipelineSection(contentId) {
            const el = document.getElementById(contentId);
            if (el) el.classList.toggle('hidden');
        }

        function exportSingleContact(contactId) {
            const contact = AppState.contacts.find(c => c.id === contactId);
            if (!contact) { showToast('Contact not found', 'error'); return; }
            const csvContent = [
                ['Name', 'Email', 'Phone', 'LinkedIn', 'Company', 'Notes', 'Lead Score', 'Lead Temperature', 'Source', 'Scanned By'],
                [contact.name || '', contact.email || '', contact.phone || '', contact.linkedin || '',
                 contact.company_name || '', (contact.notes || '').replace(/\n/g, ' '),
                 contact.lead_score || '', contact.lead_temperature || '',
                 contact.source || 'manual', contact.user_name || '']
            ].map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `contact_${(contact.name || 'unknown').replace(/[^a-zA-Z0-9]/g, '_')}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Contact exported as CSV', 'success');
        }

        async function triggerContactWebhook(contactId) {
            const contact = AppState.contacts.find(c => c.id === contactId);
            if (!contact) { showToast('Contact not found', 'error'); return; }
            const webhookUrl = document.getElementById('webhookUrlInput')?.value?.trim()
                            || localStorage.getItem('event_scout_webhook_url') || '';
            if (!webhookUrl) {
                showToast('No webhook URL configured. Set it in Admin > Webhook Configuration.', 'error');
                return;
            }
            try {
                const payload = {
                    event: 'manual_webhook_trigger',
                    contact_id: contactId,
                    contact: {
                        name: contact.name, email: contact.email, phone: contact.phone,
                        linkedin: contact.linkedin, company_name: contact.company_name,
                        notes: contact.notes || '', lead_score: contact.lead_score,
                        lead_temperature: contact.lead_temperature
                    },
                    triggered_by: AppState.currentUser.name,
                    timestamp: new Date().toISOString()
                };
                const url = `${CONFIG.API_BASE_URL}/admin/webhook/test?user_id=${AppState.currentUser.user_id}&webhook_url=${encodeURIComponent(webhookUrl)}`;
                const resp = await resilientFetch(url, {
                    method: 'POST',
                    headers: { 'X-API-Key': CONFIG.API_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await resp.json();
                if (data.status === 'success') { showToast('Contact sent to webhook!', 'success'); }
                else { showToast('Webhook failed: ' + data.message, 'error'); }
            } catch (err) {
                console.error('Trigger webhook error:', err);
                showToast('Failed to trigger webhook', 'error');
            }
        }

        // --- Admin Export ---
        function adminExportAll() {
            const url = `${CONFIG.API_BASE_URL}/admin/export?user_id=${AppState.currentUser.user_id}&format=csv`;
            // Create a hidden link with API key header - use fetch + blob for auth
            resilientFetch(url, { headers: { 'X-API-Key': CONFIG.API_KEY } })
                .then(resp => resp.blob())
                .then(blob => {
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `event_scout_contacts_${new Date().toISOString().slice(0,10)}.csv`;
                    a.click();
                    URL.revokeObjectURL(a.href);
                    showToast('Contacts exported!', 'success');
                })
                .catch(err => { console.error('Export error:', err); showToast('Export failed', 'error'); });
        }

        // --- Admin Delete User ---
        async function adminDeleteUser(userId, userName) {
            if (!confirm(`DELETE user "${userName}" and ALL their contacts? This cannot be undone!`)) return;
            if (!confirm(`Are you absolutely sure? This will permanently delete ${userName} and all their data.`)) return;
            try {
                const resp = await resilientFetch(`${CONFIG.API_BASE_URL}/admin/users?user_id=${AppState.currentUser.user_id}&action=delete&target_user_id=${userId}`, {
                    headers: { 'X-API-Key': CONFIG.API_KEY }
                });
                const data = await resp.json();
                if (resp.ok && data.status === 'success') {
                    showToast(`User ${userName} deleted`, 'success');
                    loadAdminDashboard();
                    loadAdminActivity();
                } else { showToast(data.detail || 'Failed to delete user', 'error'); }
            } catch (err) { console.error('Delete user error:', err); showToast('Failed to delete user', 'error'); }
        }

        // ==================== ADMIN MERGE & DEDUP ====================
        let currentDrilldownUserId = null;
        let drilldownSelectMode = false;
        let drilldownSelectedIds = new Set();

        async function startUserMerge(secondaryId, secondaryName) {
            const users = (window._adminUsers || []).filter(u => u.user_id !== secondaryId && !u.is_admin);
            if (!users.length) { showToast('No other users to merge into', 'error'); return; }

            const options = users.map(u => `${u.name} (${u.contact_count} contacts)`).join('\n');
            const picked = prompt(`Merge "${secondaryName}" INTO which user?\n\n${users.map((u, i) => `${i + 1}. ${u.name} (${u.contact_count} contacts)`).join('\n')}\n\nEnter number:`);
            if (!picked) return;

            const idx = parseInt(picked) - 1;
            if (isNaN(idx) || idx < 0 || idx >= users.length) { showToast('Invalid selection', 'error'); return; }

            const primary = users[idx];
            if (!confirm(`Move ALL contacts from "${secondaryName}" into "${primary.name}"?\n\n"${secondaryName}" account will be deleted.\nThis cannot be undone!`)) return;

            try {
                const resp = await resilientFetch(`${CONFIG.API_BASE_URL}/admin/users/merge?user_id=${AppState.currentUser.user_id}`, {
                    method: 'POST',
                    headers: { 'X-API-Key': CONFIG.API_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ primary_user_id: primary.user_id, secondary_user_id: secondaryId })
                });
                const data = await resp.json();
                if (resp.ok && data.status === 'success') {
                    showToast(data.message, 'success');
                    loadAdminDashboard();
                    loadAdminActivity();
                } else { showToast(data.detail || 'Merge failed', 'error'); }
            } catch (err) { console.error('User merge error:', err); showToast('Failed to merge users', 'error'); }
        }

        async function findDuplicatesInDrilldown() {
            if (!currentDrilldownUserId) return;
            const list = document.getElementById('drilldownContactList');
            list.innerHTML = '<p class="text-sm text-gray-400 text-center py-8"><i class="fas fa-spinner fa-spin mr-2"></i>Scanning for duplicates...</p>';

            try {
                const resp = await resilientFetch(`${CONFIG.API_BASE_URL}/admin/contacts/duplicates?target_user_id=${currentDrilldownUserId}&user_id=${AppState.currentUser.user_id}`, {
                    headers: { 'X-API-Key': CONFIG.API_KEY }
                });
                const data = await resp.json();
                if (!resp.ok) { showToast(data.detail || 'Failed to find duplicates', 'error'); return; }

                if (!data.duplicate_groups.length) {
                    list.innerHTML = '<div class="text-center py-8"><i class="fas fa-check-circle text-green-500 text-3xl mb-3"></i><p class="text-sm text-gray-500">No duplicates found!</p></div>';
                    return;
                }

                list.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <p class="text-sm font-semibold text-orange-600"><i class="fas fa-clone mr-1"></i>${data.total_groups} duplicate group${data.total_groups > 1 ? 's' : ''} (${data.total_duplicate_contacts} contacts)</p>
                        <button onclick="openUserDrilldown(currentDrilldownUserId, document.getElementById('drilldownUserName').textContent, document.getElementById('drilldownUserEmail').textContent)" class="text-xs text-blue-500">Back to All</button>
                    </div>
                    ${data.duplicate_groups.map(g => `
                        <div class="bg-orange-50 rounded-xl p-3 border border-orange-200 mb-3">
                            <p class="text-[10px] text-orange-500 font-medium mb-2"><i class="fas fa-link mr-1"></i>${g.match_reasons.join(', ')}</p>
                            <div class="space-y-2">
                                ${g.contacts.map((c, i) => `
                                    <div class="flex items-center justify-between bg-white rounded-lg p-2 ${i === 0 ? 'ring-2 ring-orange-300' : ''}">
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-medium text-gray-900 truncate">${escapeHtml(c.name)}${i === 0 ? ' <span class="text-[9px] bg-orange-100 text-orange-600 px-1 rounded">PRIMARY</span>' : ''}</p>
                                            <p class="text-[10px] text-gray-400 truncate">${c.email !== 'n/a' ? c.email : ''} ${c.phone || ''}</p>
                                            <p class="text-[10px] text-gray-400">${c.company_name !== 'n/a' ? c.company_name : ''} · ${c.source} · ${c.lead_temperature || 'unscored'}</p>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            ${g.contacts.length === 2 ? `
                                <button onclick="mergeDuplicateGroup('${g.contacts[0].id}', '${g.contacts[1].id}')" class="mt-2 w-full py-2 bg-orange-500 text-white rounded-lg text-xs font-medium active:bg-orange-600">
                                    <i class="fas fa-code-branch mr-1"></i>Merge (keep first)
                                </button>
                            ` : `
                                <button onclick="mergeAllInGroup([${g.contacts.map(c => `'${c.id}'`).join(',')}])" class="mt-2 w-full py-2 bg-orange-500 text-white rounded-lg text-xs font-medium active:bg-orange-600">
                                    <i class="fas fa-code-branch mr-1"></i>Merge all into first
                                </button>
                            `}
                        </div>
                    `).join('')}
                `;
            } catch (err) { console.error('Find dupes error:', err); showToast('Failed to scan for duplicates', 'error'); }
        }

        async function mergeDuplicateGroup(primaryId, secondaryId) {
            if (!confirm('Merge these contacts? The duplicate will be absorbed into the primary.')) return;
            try {
                const resp = await resilientFetch(`${CONFIG.API_BASE_URL}/admin/contacts/merge?user_id=${AppState.currentUser.user_id}`, {
                    method: 'POST',
                    headers: { 'X-API-Key': CONFIG.API_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ primary_id: primaryId, secondary_id: secondaryId })
                });
                const data = await resp.json();
                if (resp.ok && data.status === 'success') {
                    showToast(data.message, 'success');
                    findDuplicatesInDrilldown(); // Refresh
                } else { showToast(data.detail || 'Merge failed', 'error'); }
            } catch (err) { console.error('Contact merge error:', err); showToast('Failed to merge contacts', 'error'); }
        }

        async function mergeAllInGroup(ids) {
            if (!confirm(`Merge ${ids.length} contacts into one? All duplicates will be absorbed.`)) return;
            const primaryId = ids[0];
            for (let i = 1; i < ids.length; i++) {
                try {
                    const resp = await resilientFetch(`${CONFIG.API_BASE_URL}/admin/contacts/merge?user_id=${AppState.currentUser.user_id}`, {
                        method: 'POST',
                        headers: { 'X-API-Key': CONFIG.API_KEY, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ primary_id: primaryId, secondary_id: ids[i] })
                    });
                    const data = await resp.json();
                    if (!resp.ok) { showToast(data.detail || `Failed to merge contact ${i}`, 'error'); }
                } catch (err) { console.error('Merge error:', err); }
            }
            showToast('All duplicates merged', 'success');
            findDuplicatesInDrilldown();
        }

        function toggleDrilldownSelectMode() {
            drilldownSelectMode = !drilldownSelectMode;
            drilldownSelectedIds.clear();
            const btn = document.getElementById('drilldownSelectBtn');
            const bulkBar = document.getElementById('drilldownBulkActions');
            if (drilldownSelectMode) {
                btn.classList.replace('bg-gray-100', 'bg-blue-500');
                btn.classList.replace('text-gray-600', 'text-white');
                bulkBar.classList.remove('hidden');
            } else {
                btn.classList.replace('bg-blue-500', 'bg-gray-100');
                btn.classList.replace('text-white', 'text-gray-600');
                bulkBar.classList.add('hidden');
            }
            // Re-render with checkboxes
            document.querySelectorAll('.drilldown-contact-card').forEach(card => {
                const cb = card.querySelector('.drilldown-cb');
                if (drilldownSelectMode) {
                    cb?.classList.remove('hidden');
                } else {
                    cb?.classList.add('hidden');
                    cb && (cb.checked = false);
                }
            });
            updateDrilldownSelectionCount();
        }

        function toggleDrilldownContact(contactId, checkbox) {
            if (checkbox.checked) drilldownSelectedIds.add(contactId);
            else drilldownSelectedIds.delete(contactId);
            updateDrilldownSelectionCount();
        }

        function updateDrilldownSelectionCount() {
            const el = document.getElementById('drilldownSelectedCount');
            if (el) el.textContent = drilldownSelectedIds.size;
        }

        async function deleteSelectedDrilldown() {
            if (!drilldownSelectedIds.size) { showToast('No contacts selected', 'error'); return; }
            if (!confirm(`Delete ${drilldownSelectedIds.size} contacts? This cannot be undone!`)) return;

            try {
                const resp = await resilientFetch(`${CONFIG.API_BASE_URL}/admin/contacts/batch_delete?user_id=${AppState.currentUser.user_id}`, {
                    method: 'POST',
                    headers: { 'X-API-Key': CONFIG.API_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contact_ids: [...drilldownSelectedIds] })
                });
                const data = await resp.json();
                if (resp.ok && data.status === 'success') {
                    showToast(data.message, 'success');
                    drilldownSelectedIds.clear();
                    drilldownSelectMode = false;
                    // Refresh drilldown
                    openUserDrilldown(currentDrilldownUserId, document.getElementById('drilldownUserName').textContent, document.getElementById('drilldownUserEmail').textContent);
                } else { showToast(data.detail || 'Delete failed', 'error'); }
            } catch (err) { console.error('Batch delete error:', err); showToast('Failed to delete contacts', 'error'); }
        }

        // ==================== EVENT FILES (Admin Upload + User Download) ====================
        let currentFileCategory = '';

        async function uploadAdminFile() {
            const fileInput = document.getElementById('adminFileInput');
            const description = document.getElementById('adminFileDescription').value.trim();
            const category = document.getElementById('adminFileCategory').value;

            if (!fileInput.files.length) { showToast('Please select a file', 'error'); return; }

            const file = fileInput.files[0];
            if (file.size > 20 * 1024 * 1024) {
                showToast('File too large. Max 20MB.', 'error'); return;
            }

            const allowed = ['application/pdf', 'application/vnd.ms-powerpoint', 'application/vnd.openxmlformats-officedocument.presentationml.presentation'];
            if (!allowed.includes(file.type)) {
                showToast('Only PDF and PPT files allowed', 'error'); return;
            }

            const formData = new FormData();
            formData.append('file', file);

            showToast('Uploading...', 'info');
            try {
                const resp = await resilientFetch(
                    `${CONFIG.API_BASE_URL}/admin/files/upload?user_id=${AppState.currentUser.user_id}&description=${encodeURIComponent(description)}&category=${encodeURIComponent(category)}`,
                    { method: 'POST', headers: { 'X-API-Key': CONFIG.API_KEY }, body: formData }
                );
                const data = await resp.json();
                if (resp.ok) {
                    showToast('File uploaded!', 'success');
                    fileInput.value = '';
                    document.getElementById('adminFileDescription').value = '';
                    refreshAdminFiles();
                } else {
                    showToast(data.detail || 'Upload failed', 'error');
                }
            } catch (err) { console.error('Upload error:', err); showToast('Upload failed', 'error'); }
        }

        async function refreshAdminFiles() {
            const container = document.getElementById('adminFilesList');
            if (!container) return;
            container.innerHTML = '<p class="text-sm text-gray-400 text-center py-2">Loading...</p>';
            try {
                const resp = await resilientFetch(
                    `${CONFIG.API_BASE_URL}/files/list?user_id=${AppState.currentUser.user_id}`,
                    { headers: { 'X-API-Key': CONFIG.API_KEY } }
                );
                const data = await resp.json();
                if (resp.ok && data.files && data.files.length > 0) {
                    container.innerHTML = data.files.map(f => {
                        const icon = f.file_type === 'pdf' ? 'fa-file-pdf text-red-500' : 'fa-file-powerpoint text-orange-500';
                        return `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center gap-3 flex-1 min-w-0">
                                <i class="fas ${icon} text-xl"></i>
                                <div class="min-w-0">
                                    <p class="text-sm font-medium text-gray-900 truncate">${f.filename}</p>
                                    <p class="text-xs text-gray-500">${f.file_size_mb}MB &middot; ${f.category} &middot; ${f.download_count} downloads</p>
                                </div>
                            </div>
                            <button onclick="deleteAdminFile('${f.id}', '${f.filename.replace(/'/g, "\\'")}')" class="ml-2 p-2 text-red-500 hover:bg-red-50 rounded-lg">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                        </div>`;
                    }).join('');
                } else {
                    container.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">No files uploaded yet</p>';
                }
            } catch (err) { console.error('Load admin files error:', err); container.innerHTML = '<p class="text-sm text-red-500 text-center py-4">Failed to load files</p>'; }
        }

        async function deleteAdminFile(fileId, filename) {
            if (!confirm(`Delete "${filename}"?`)) return;
            try {
                const resp = await resilientFetch(
                    `${CONFIG.API_BASE_URL}/admin/files/${fileId}?user_id=${AppState.currentUser.user_id}`,
                    { method: 'DELETE', headers: { 'X-API-Key': CONFIG.API_KEY } }
                );
                if (resp.ok) { showToast('File deleted', 'success'); refreshAdminFiles(); refreshEventFiles(); }
                else { const d = await resp.json(); showToast(d.detail || 'Delete failed', 'error'); }
            } catch (err) { console.error('Delete error:', err); showToast('Delete failed', 'error'); }
        }

        // ==================== DATABASE BACKUP ====================
        // --- Pipeline Monitor (Admin) ---
        async function loadPipelineMonitor() {
            try {
                const resp = await resilientFetch(`${CONFIG.API_BASE_URL}/admin/pipelines?user_id=${AppState.currentUser.user_id}&limit=20`, {
                    headers: { 'X-API-Key': CONFIG.API_KEY }
                });
                const data = await resp.json();
                const counts = data.status_counts || {};
                const activeStatuses = ['pending', 'researching', 'scoring', 'pitching', 'generating_deck', 'attaching'];
                const activeCount = activeStatuses.reduce((sum, s) => sum + (counts[s] || 0), 0);
                const doneCount = (counts['complete'] || 0) + (counts['complete_no_deck'] || 0);
                const failedCount = counts['failed'] || 0;

                const el = id => document.getElementById(id);
                if (el('pipelineActiveCount')) el('pipelineActiveCount').textContent = activeCount;
                if (el('pipelineDoneCount')) el('pipelineDoneCount').textContent = doneCount;
                if (el('pipelineFailedCount')) el('pipelineFailedCount').textContent = failedCount;

                const listEl = el('pipelineMonitorList');
                if (!listEl) return;

                if (!data.pipelines?.length) {
                    listEl.innerHTML = '<p class="text-xs text-gray-400 text-center py-2">No pipelines yet. Pipelines auto-run when cards are scanned.</p>';
                    return;
                }

                listEl.innerHTML = data.pipelines.map(p => {
                    const statusColors = {
                        complete: 'text-green-600', complete_no_deck: 'text-green-500', failed: 'text-red-600',
                        researching: 'text-blue-600', scoring: 'text-blue-600', pitching: 'text-purple-600',
                        generating_deck: 'text-indigo-600', pending: 'text-gray-400'
                    };
                    const statusIcons = {
                        complete: 'fa-check-circle', complete_no_deck: 'fa-check-circle', failed: 'fa-times-circle',
                        researching: 'fa-spinner fa-spin', scoring: 'fa-spinner fa-spin', pitching: 'fa-spinner fa-spin',
                        generating_deck: 'fa-spinner fa-spin', pending: 'fa-clock'
                    };
                    const color = statusColors[p.status] || 'text-gray-500';
                    const icon = statusIcons[p.status] || 'fa-circle';
                    return `<div class="flex items-center gap-2 text-xs">
                        <i class="fas ${icon} ${color} w-4 text-center"></i>
                        <span class="font-medium text-gray-800 truncate flex-1">${escapeHtml(p.contact_name)}</span>
                        <span class="text-gray-400 truncate">${escapeHtml(p.user_name)}</span>
                        <span class="${color} text-[10px]">${p.current_step || p.status}</span>
                    </div>`;
                }).join('');

                // Update toggle button
                const toggleBtn = el('autoPipelineToggle');
                if (toggleBtn) {
                    const enabled = data.auto_pipeline_enabled;
                    toggleBtn.textContent = enabled ? 'ON' : 'OFF';
                    toggleBtn.className = `px-3 py-1 rounded-full text-xs font-medium ${enabled ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-600'}`;
                }
            } catch (err) { console.error('Pipeline monitor error:', err); }
        }

        async function toggleAutoPipeline() {
            const btn = document.getElementById('autoPipelineToggle');
            const currentlyOn = btn?.textContent?.trim() === 'ON';
            try {
                const resp = await resilientFetch(`${CONFIG.API_BASE_URL}/admin/pipeline/settings?user_id=${AppState.currentUser.user_id}&auto_enabled=${!currentlyOn}`, {
                    method: 'POST', headers: { 'X-API-Key': CONFIG.API_KEY }
                });
                const data = await resp.json();
                const enabled = data.current_settings?.auto_pipeline_enabled;
                if (btn) {
                    btn.textContent = enabled ? 'ON' : 'OFF';
                    btn.className = `px-3 py-1 rounded-full text-xs font-medium ${enabled ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-600'}`;
                }
                showToast(`Auto-pipeline ${enabled ? 'enabled' : 'disabled'}`, 'success');
            } catch (err) { showToast('Failed to update setting', 'error'); }
        }

        async function triggerBackup() {
            const btn = document.getElementById('backupBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Backing up...';

            try {
                const resp = await resilientFetch(`${CONFIG.API_BASE_URL}/admin/backup?user_id=${AppState.currentUser.user_id}`, {
                    method: 'POST',
                    headers: { 'X-API-Key': CONFIG.API_KEY }
                });
                const data = await resp.json();

                if (data.status === 'success') {
                    showToast(`Backup complete: ${data.total_rows} rows in ${data.duration_seconds}s`, 'success');
                    updateBackupUI(data);
                } else {
                    showToast(data.message || data.detail || 'Backup failed', 'error');
                }
            } catch (err) {
                console.error('Backup error:', err);
                showToast('Backup failed: ' + err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-shield-alt"></i> Backup Now';
            }
        }

        async function checkBackupStatus() {
            try {
                const resp = await resilientFetch(`${CONFIG.API_BASE_URL}/admin/backup/status?user_id=${AppState.currentUser.user_id}`, {
                    headers: { 'X-API-Key': CONFIG.API_KEY }
                });
                const data = await resp.json();

                if (!data.backup_configured) {
                    showToast('Backup not configured. Set BACKUP_DATABASE_URL on Railway.', 'warning');
                    return;
                }

                const details = document.getElementById('backupDetails');
                details.classList.remove('hidden');

                let html = '';
                if (data.last_backup && data.last_backup.timestamp) {
                    const ago = timeAgo(new Date(data.last_backup.timestamp));
                    html += `<p><strong>Last backup:</strong> ${ago}</p>`;
                    html += `<p><strong>Status:</strong> ${data.last_backup.status}</p>`;
                } else {
                    html += '<p><strong>Last backup:</strong> Never</p>';
                }

                html += '<p class="mt-2 font-semibold">Row Counts:</p>';
                html += '<table class="w-full"><thead><tr><th class="text-left">Table</th><th class="text-right">Primary</th><th class="text-right">Backup</th></tr></thead><tbody>';
                for (const table of Object.keys(data.primary_counts || {})) {
                    const p = data.primary_counts[table];
                    const b = (data.backup_counts || {})[table] || 0;
                    const match = p === b ? '✓' : '✗';
                    html += `<tr><td>${table}</td><td class="text-right">${p}</td><td class="text-right">${b} ${match}</td></tr>`;
                }
                html += '</tbody></table>';
                html += `<p class="mt-2"><strong>In sync:</strong> ${data.in_sync ? '✓ Yes' : '✗ No — run backup'}</p>`;

                details.innerHTML = html;

                // Update status dot
                const dot = document.getElementById('backupStatusDot');
                dot.className = `w-2.5 h-2.5 rounded-full ${data.in_sync ? 'bg-green-500' : 'bg-amber-500'}`;

            } catch (err) {
                console.error('Backup status error:', err);
                showToast('Could not fetch backup status', 'error');
            }
        }

        function updateBackupUI(data) {
            const dot = document.getElementById('backupStatusDot');
            dot.className = 'w-2.5 h-2.5 rounded-full bg-green-500';
            dot.title = `Last backup: ${new Date(data.timestamp).toLocaleTimeString()}`;

            const info = document.getElementById('backupStatusInfo');
            info.innerHTML = `<p>Last backup: ${new Date(data.timestamp).toLocaleTimeString()} (${data.total_rows} rows, ${data.duration_seconds}s)</p>`;

            // Hide details if open
            document.getElementById('backupDetails').classList.add('hidden');
        }

        function timeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' min ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
            return Math.floor(seconds / 86400) + ' days ago';
        }

        async function refreshEventFiles() {
            const container = document.getElementById('eventFilesList');
            if (!container) return;
            container.innerHTML = '<p class="text-sm text-gray-400 text-center py-2">Loading...</p>';
            try {
                let url = `${CONFIG.API_BASE_URL}/files/list?user_id=${AppState.currentUser.user_id}`;
                if (currentFileCategory) url += `&category=${encodeURIComponent(currentFileCategory)}`;
                const resp = await resilientFetch(url, { headers: { 'X-API-Key': CONFIG.API_KEY } });
                const data = await resp.json();
                if (resp.ok && data.files && data.files.length > 0) {
                    container.innerHTML = data.files.map(f => {
                        const icon = f.file_type === 'pdf' ? 'fa-file-pdf text-red-500' : 'fa-file-powerpoint text-orange-500';
                        return `<div class="bg-white rounded-lg p-3 shadow-sm active:bg-gray-50 transition cursor-pointer" onclick="downloadEventFile('${f.id}', '${f.filename.replace(/'/g, "\\'")}')">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i class="fas ${icon} text-xl"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900 truncate">${f.filename}</p>
                                    <p class="text-xs text-gray-500">${f.file_size_mb}MB${f.description ? ' &middot; ' + f.description : ''}</p>
                                </div>
                                <i class="fas fa-download text-gray-400 flex-shrink-0"></i>
                            </div>
                        </div>`;
                    }).join('');
                } else {
                    container.innerHTML = '<p class="text-sm text-gray-400 text-center py-2">No files available</p>';
                }
            } catch (err) { console.error('Load event files error:', err); container.innerHTML = '<p class="text-sm text-red-500 text-center py-2">Failed to load files</p>'; }
        }

        function filterFilesByCategory(cat) {
            currentFileCategory = cat;
            document.querySelectorAll('.file-cat-btn').forEach(btn => {
                const isActive = (cat === '' && btn.textContent.trim() === 'All') ||
                                 (cat && btn.getAttribute('onclick').includes("'" + cat + "'"));
                btn.className = 'file-cat-btn px-3 py-1 rounded-full whitespace-nowrap text-xs font-medium ' +
                    (isActive ? 'bg-blue-600 text-white' : 'bg-white text-gray-700');
            });
            refreshEventFiles();
        }

        async function downloadEventFile(fileId, filename) {
            showToast('Downloading...', 'info');
            try {
                const resp = await resilientFetch(
                    `${CONFIG.API_BASE_URL}/files/download/${fileId}?user_id=${AppState.currentUser.user_id}`,
                    { headers: { 'X-API-Key': CONFIG.API_KEY } }
                );
                if (!resp.ok) throw new Error('Download failed');
                const blob = await resp.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = filename;
                document.body.appendChild(a); a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                showToast('Downloaded!', 'success');
            } catch (err) { console.error('Download error:', err); showToast('Download failed', 'error'); }
        }

        // ==================== VOICE RECORDING (Swipe Right) ====================
        let voiceRecognition = null, voiceMediaRecorder = null, voiceAudioChunks = [], voiceTimerInterval = null, voiceSeconds = 0, voiceIsRecording = false;

        function initSwipeHandlers() {
            const cl = document.getElementById('contactsList');
            let sx = 0, sy = 0, sc = null;
            cl.addEventListener('touchstart', e => {
                const c = e.target.closest('.contact-card');
                if (!c) return;
                sx = e.touches[0].clientX; sy = e.touches[0].clientY; sc = c;
                // Reset any previously revealed delete buttons
                document.querySelectorAll('.swipe-delete-btn').forEach(b => b.remove());
                document.querySelectorAll('.contact-card').forEach(card => { card.style.transform = ''; card.style.background = ''; });
            }, { passive: true });
            cl.addEventListener('touchmove', e => {
                if (!sc) return;
                const dx = e.touches[0].clientX - sx, dy = Math.abs(e.touches[0].clientY - sy);
                if (dy > 30) { sc.style.transform = ''; sc.style.background = ''; sc = null; return; }
                // Right swipe → voice recording indicator
                if (dx > 20 && dx < 120) {
                    sc.style.transform = 'translateX(' + Math.min(dx * 0.3, 30) + 'px)';
                    sc.style.background = 'linear-gradient(90deg, rgba(124,58,237,' + (dx/300) + ') 0%, transparent 40%)';
                }
                // Left swipe → delete indicator (red from right)
                if (dx < -20 && dx > -120) {
                    sc.style.transform = 'translateX(' + Math.max(dx * 0.3, -30) + 'px)';
                    sc.style.background = 'linear-gradient(270deg, rgba(239,68,68,' + (Math.abs(dx)/300) + ') 0%, transparent 40%)';
                }
            }, { passive: true });
            cl.addEventListener('touchend', e => {
                if (!sc) return;
                const dx = e.changedTouches[0].clientX - sx, dy = Math.abs(e.changedTouches[0].clientY - sy);
                sc.style.transform = ''; sc.style.background = '';
                // Right swipe → voice recording
                if (dx > 50 && dy < 40) {
                    _swipeVoiceTriggered = Date.now();
                    const cid = sc.dataset.id;
                    const ct = AppState.contacts.find(c => c.id === cid);
                    if (ct) openVoiceRecordingOverlay(cid, ct.name);
                }
                // Left swipe → reveal delete button
                if (dx < -50 && dy < 40) {
                    _swipeVoiceTriggered = Date.now();
                    const cid = sc.dataset.id;
                    const ct = AppState.contacts.find(c => c.id === cid);
                    if (ct) showSwipeDeleteButton(sc, cid, ct.name);
                }
                sc = null;
            }, { passive: true });
        }

        function showSwipeDeleteButton(cardEl, contactId, contactName) {
            // Remove any existing delete buttons
            document.querySelectorAll('.swipe-delete-btn').forEach(b => b.remove());
            const btn = document.createElement('button');
            btn.className = 'swipe-delete-btn absolute right-0 top-0 bottom-0 bg-red-500 text-white px-6 flex items-center justify-center font-semibold text-sm z-10';
            btn.innerHTML = '<i class="fas fa-trash mr-2"></i>Delete';
            btn.onclick = async (e) => {
                e.stopPropagation();
                if (!confirm('Delete ' + contactName + '? This cannot be undone.')) { btn.remove(); return; }
                try {
                    const resp = await resilientFetch(
                        CONFIG.API_BASE_URL + '/contact/' + contactId + '?user_id=' + AppState.currentUser.user_id,
                        { method: 'DELETE', headers: { 'X-API-Key': CONFIG.API_KEY } }
                    );
                    if (resp.ok) {
                        showToast(contactName + ' deleted', 'success');
                        AppState.contacts = AppState.contacts.filter(c => c.id !== contactId);
                        renderContacts(AppState.contacts);
                    } else { showToast('Failed to delete contact', 'error'); }
                } catch (err) { showToast('Delete failed: ' + err.message, 'error'); }
            };
            cardEl.style.position = 'relative';
            cardEl.style.overflow = 'hidden';
            cardEl.appendChild(btn);
            // Auto-hide after 5 seconds
            setTimeout(() => { if (btn.parentNode) btn.remove(); }, 5000);
        }

        const _origRender = renderContacts;
        renderContacts = function(contacts) { _origRender(contacts); setTimeout(initSwipeHandlers, 100); };

        function openVoiceRecordingOverlay(contactId, contactName) {
            AppState._voiceContactId = contactId; AppState._voiceTranscript = ''; AppState._voiceAudioBlob = null;
            document.getElementById('voiceContactName').textContent = 'Voice note for ' + contactName;
            document.getElementById('voiceTimer').textContent = '0:00';
            document.getElementById('voiceStatus').textContent = 'Starting...';
            document.getElementById('voiceTranscript').classList.add('hidden');
            document.getElementById('voiceSaveBtn').classList.add('hidden');
            var btn = document.getElementById('voiceRecordBtn'); btn.innerHTML = '<i class="fas fa-microphone"></i>'; btn.classList.remove('bg-gray-500'); btn.classList.add('bg-red-500', 'recording-pulse');
            document.getElementById('voiceRecordingOverlay').classList.remove('hidden');
            setTimeout(function() { toggleVoiceRecording(); }, 300);
        }

        function toggleVoiceRecording() { voiceIsRecording ? stopVoiceRecording() : startVoiceRecording(); }

        async function startVoiceRecording() {
            voiceIsRecording = true; voiceSeconds = 0; voiceAudioChunks = []; AppState._voiceTranscript = '';
            var btn = document.getElementById('voiceRecordBtn'); btn.innerHTML = '<i class="fas fa-stop"></i>'; btn.classList.remove('bg-red-500'); btn.classList.add('bg-gray-500');
            document.getElementById('voiceStatus').textContent = 'Recording...';
            document.getElementById('voiceTranscript').classList.remove('hidden');
            document.getElementById('voiceTranscript').innerHTML = '<span class="text-gray-400 italic">Listening...</span>';
            voiceTimerInterval = setInterval(function() { voiceSeconds++; var m = Math.floor(voiceSeconds/60), s = voiceSeconds%60; document.getElementById('voiceTimer').textContent = m + ':' + s.toString().padStart(2,'0'); if (voiceSeconds >= 60) stopVoiceRecording(); }, 1000);
            try { var stream = await navigator.mediaDevices.getUserMedia({audio:true}); voiceMediaRecorder = new MediaRecorder(stream, {mimeType:'audio/webm;codecs=opus'}); voiceMediaRecorder.ondataavailable = function(e) { if (e.data.size > 0) voiceAudioChunks.push(e.data); }; voiceMediaRecorder.onstop = function() { stream.getTracks().forEach(function(t){t.stop();}); if (voiceAudioChunks.length > 0) AppState._voiceAudioBlob = new Blob(voiceAudioChunks, {type:'audio/webm'}); }; voiceMediaRecorder.start(1000); } catch(err) { console.warn('[Voice] MediaRecorder unavailable:', err); }
            var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SR) { voiceRecognition = new SR(); voiceRecognition.continuous = true; voiceRecognition.interimResults = true; voiceRecognition.lang = 'en-US'; var finalT = ''; voiceRecognition.onresult = function(evt) { var interim = ''; for (var i = evt.resultIndex; i < evt.results.length; i++) { if (evt.results[i].isFinal) finalT += evt.results[i][0].transcript + ' '; else interim += evt.results[i][0].transcript; } AppState._voiceTranscript = finalT.trim(); document.getElementById('voiceTranscript').innerHTML = finalT + '<span class="text-gray-400">' + interim + '</span>'; }; voiceRecognition.onerror = function(e) { console.warn('[Voice] Recognition error:', e.error); }; voiceRecognition.onend = function() { if (voiceIsRecording) try { voiceRecognition.start(); } catch(e) {} }; voiceRecognition.start(); }
            else { document.getElementById('voiceTranscript').innerHTML = '<span class="text-gray-400 italic">Live transcription unavailable. Audio sent for AI transcription on save.</span>'; }
        }

        function stopVoiceRecording() {
            voiceIsRecording = false; clearInterval(voiceTimerInterval);
            // Capture displayed transcript (includes interim text) before stopping recognition
            var transcriptEl = document.getElementById('voiceTranscript');
            var displayedText = transcriptEl ? transcriptEl.textContent.trim() : '';
            if (displayedText && displayedText !== 'Listening...' && displayedText !== 'Live transcription unavailable. Audio sent for AI transcription on save.') {
                if (!AppState._voiceTranscript || AppState._voiceTranscript.length < displayedText.length) {
                    AppState._voiceTranscript = displayedText;
                }
            }
            if (voiceRecognition) { voiceRecognition.onend = null; try { voiceRecognition.stop(); } catch(e) {} voiceRecognition = null; }
            if (voiceMediaRecorder && voiceMediaRecorder.state !== 'inactive') voiceMediaRecorder.stop();
            var btn = document.getElementById('voiceRecordBtn'); btn.innerHTML = '<i class="fas fa-microphone"></i>'; btn.classList.remove('bg-gray-500'); btn.classList.add('bg-red-500');
            document.getElementById('voiceStatus').textContent = 'Recording complete';
            document.getElementById('voiceSaveBtn').classList.remove('hidden');
            if (!AppState._voiceTranscript) document.getElementById('voiceTranscript').innerHTML = '<span class="text-gray-400 italic">No live transcript. Audio will be transcribed by AI on save.</span>';
        }

        function cancelVoiceRecording() { stopVoiceRecording(); AppState._voiceContactId = null; AppState._voiceTranscript = ''; AppState._voiceAudioBlob = null; document.getElementById('voiceRecordingOverlay').classList.add('hidden'); }

        async function saveVoiceNote() {
            var contactId = AppState._voiceContactId, transcript = AppState._voiceTranscript, audioBlob = AppState._voiceAudioBlob;
            if (!contactId) return;
            document.getElementById('voiceStatus').textContent = 'Saving...'; document.getElementById('voiceSaveBtn').disabled = true;
            if (!transcript && audioBlob) { try { var fd = new FormData(); fd.append('file', audioBlob, 'voice_note.webm'); var r = await resilientFetch(CONFIG.API_BASE_URL + '/transcribe_audio/?user_id=' + AppState.currentUser.user_id, {method:'POST', headers:{'X-API-Key':CONFIG.API_KEY}, body:fd}); var d = await r.json(); if (r.ok && d.transcript) transcript = d.transcript; } catch(err) { console.error('[Voice] Gemini transcription failed:', err); } }
            var audioBase64 = '';
            if (audioBlob) { try { var buf = await audioBlob.arrayBuffer(); var bytes = new Uint8Array(buf); var bin = ''; bytes.forEach(function(b){ bin += String.fromCharCode(b); }); audioBase64 = btoa(bin); } catch(err) { console.warn('[Voice] Audio encode failed:', err); } }
            try { var response = await resilientFetch(CONFIG.API_BASE_URL + '/contact/' + contactId + '/audio_note?user_id=' + AppState.currentUser.user_id, { method:'POST', headers:{'Content-Type':'application/json','X-API-Key':CONFIG.API_KEY}, body:JSON.stringify({contact_id:contactId, transcript:transcript||'(no transcription)', audio_base64:audioBase64}) }); if (response.ok) { showToast('Voice note saved!', 'success'); loadContacts(); } else showToast('Failed to save voice note', 'error'); } catch(err) { showToast('Network error saving voice note', 'error'); }
            AppState._voiceContactId = null; AppState._voiceTranscript = ''; AppState._voiceAudioBlob = null;
            document.getElementById('voiceRecordingOverlay').classList.add('hidden'); document.getElementById('voiceSaveBtn').disabled = false;
        }

        // ==================== CHAT VOICE INPUT ====================
        let chatVoiceRecognition = null, chatVoiceActive = false;
        function toggleChatVoice() { chatVoiceActive ? stopChatVoice() : startChatVoice(); }
        function startChatVoice() {
            var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) { showToast('Voice input not supported', 'error'); return; }
            chatVoiceActive = true;
            var btn = document.getElementById('chatMicBtn');
            btn.classList.remove('bg-gray-100','text-gray-500');
            btn.classList.add('bg-red-500','text-white','recording-pulse');
            var chatInput = document.getElementById('chatInput');
            chatInput.placeholder = 'Listening... speak now';
            chatVoiceRecognition = new SR();
            chatVoiceRecognition.continuous = false;
            chatVoiceRecognition.interimResults = true;
            chatVoiceRecognition.lang = 'en-US';
            var finalText = chatInput.value ? chatInput.value + ' ' : '';
            chatVoiceRecognition.onresult = function(evt) {
                var interim = '';
                for (var i = evt.resultIndex; i < evt.results.length; i++) {
                    if (evt.results[i].isFinal) finalText += evt.results[i][0].transcript + ' ';
                    else interim = evt.results[i][0].transcript;
                }
                chatInput.value = (finalText + interim).trim();
            };
            chatVoiceRecognition.onerror = function(e) {
                console.warn('[Chat Voice] Error:', e.error);
                if (e.error !== 'no-speech') stopChatVoice();
            };
            chatVoiceRecognition.onend = function() {
                if (chatVoiceActive) {
                    try { finalText = chatInput.value ? chatInput.value + ' ' : ''; chatVoiceRecognition.start(); }
                    catch(e) { stopChatVoice(); }
                }
            };
            chatVoiceRecognition.start();
        }
        function stopChatVoice() {
            chatVoiceActive = false;
            var btn = document.getElementById('chatMicBtn');
            btn.classList.remove('bg-red-500','text-white','recording-pulse');
            btn.classList.add('bg-gray-100','text-gray-500');
            if (chatVoiceRecognition) { chatVoiceRecognition.onend = null; try { chatVoiceRecognition.stop(); } catch(e) {} chatVoiceRecognition = null; }
            document.getElementById('chatInput').placeholder = 'Ask about your contacts...';
        }
    </script>
</body>
</html>
