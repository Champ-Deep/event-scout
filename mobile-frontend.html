<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Event Scout - Mobile</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        // Tailwind configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        'primary-dark': '#1e40af',
                        secondary: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b'
                    }
                }
            }
        }
    </script>

    <style>
        /* CSS Custom Properties (kept from original) */
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        /* Utility classes */
        .hidden {
            display: none !important;
        }

        /* Mobile-specific animations */
        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .slide-up {
            animation: slideUp 0.3s ease-out;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        /* Safe area insets for notched devices */
        .safe-area-inset-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }

        .safe-area-inset-top {
            padding-top: env(safe-area-inset-top);
        }

        /* Touch feedback */
        .touch-feedback:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        /* Voice recording pulse */
        @keyframes recordingPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 12px rgba(239, 68, 68, 0); }
        }
        .recording-pulse {
            animation: recordingPulse 1.5s ease-in-out infinite;
        }

        /* Swipe voice indicator */
        .swipe-voice-indicator {
            position: absolute;
            right: -60px;
            top: 0;
            bottom: 0;
            width: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(90deg, transparent, #7c3aed);
            border-radius: 0 8px 8px 0;
            color: white;
            font-size: 20px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .contact-card {
            position: relative;
            overflow: hidden;
        }
        .contact-card-inner {
            transition: transform 0.2s ease;
        }

        /* Swipe gesture indicator */
        .swipeable {
            position: relative;
            overflow: hidden;
        }

        .swipe-actions {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            display: flex;
            transform: translateX(100%);
        }

        /* Loading spinner */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        /* Contact detail view slide-in */
        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); }
            to { transform: translateX(100%); }
        }
        .slide-in-right {
            animation: slideInRight 0.25s ease-out forwards;
        }
        .slide-out-right {
            animation: slideOutRight 0.25s ease-in forwards;
        }

        /* Avatar color generation */
        .avatar-gradient-0 { background: linear-gradient(135deg, #667eea, #764ba2); }
        .avatar-gradient-1 { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .avatar-gradient-2 { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .avatar-gradient-3 { background: linear-gradient(135deg, #43e97b, #38f9d7); }
        .avatar-gradient-4 { background: linear-gradient(135deg, #fa709a, #fee140); }
        .avatar-gradient-5 { background: linear-gradient(135deg, #a18cd1, #fbc2eb); }
        .avatar-gradient-6 { background: linear-gradient(135deg, #fccb90, #d57eeb); }
        .avatar-gradient-7 { background: linear-gradient(135deg, #e0c3fc, #8ec5fc); }

        /* Link chip */
        .link-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            background: #eff6ff;
            color: #2563eb;
            border: 1px solid #bfdbfe;
            text-decoration: none;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .link-chip.auto {
            background: #f0fdf4;
            color: #16a34a;
            border-color: #bbf7d0;
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- ========================================
         AUTH SCREEN (Login/Register)
    ======================================== -->
    <div id="authScreen" class="screen min-h-screen bg-gradient-to-br from-purple-600 to-blue-500 flex items-center justify-center p-4">
        <div class="w-full max-w-md">
            <!-- Logo/Header -->
            <div class="text-center mb-8">
                <div class="mb-4 flex justify-center">
                    <svg width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="logoGrad" x1="0" y1="0" x2="80" y2="80" gradientUnits="userSpaceOnUse">
                                <stop offset="0%" stop-color="#a78bfa"/>
                                <stop offset="100%" stop-color="#60a5fa"/>
                            </linearGradient>
                        </defs>
                        <!-- Outer ring -->
                        <circle cx="40" cy="40" r="38" stroke="url(#logoGrad)" stroke-width="2" fill="none" opacity="0.3"/>
                        <!-- Middle ring -->
                        <circle cx="40" cy="40" r="28" stroke="url(#logoGrad)" stroke-width="2" fill="none" opacity="0.5"/>
                        <!-- Inner ring -->
                        <circle cx="40" cy="40" r="18" stroke="url(#logoGrad)" stroke-width="2" fill="none" opacity="0.7"/>
                        <!-- Center dot -->
                        <circle cx="40" cy="40" r="4" fill="url(#logoGrad)"/>
                        <!-- Radar sweep -->
                        <path d="M40 40 L40 2 A38 38 0 0 1 72 22 Z" fill="url(#logoGrad)" opacity="0.15"/>
                        <!-- Contact nodes -->
                        <circle cx="58" cy="18" r="4" fill="#a78bfa" opacity="0.9"/>
                        <circle cx="65" cy="38" r="3" fill="#818cf8" opacity="0.7"/>
                        <circle cx="22" cy="56" r="3.5" fill="#60a5fa" opacity="0.8"/>
                        <circle cx="50" cy="60" r="3" fill="#93c5fd" opacity="0.6"/>
                        <!-- Crosshair lines -->
                        <line x1="40" y1="8" x2="40" y2="16" stroke="white" stroke-width="1" opacity="0.4"/>
                        <line x1="40" y1="64" x2="40" y2="72" stroke="white" stroke-width="1" opacity="0.4"/>
                        <line x1="8" y1="40" x2="16" y2="40" stroke="white" stroke-width="1" opacity="0.4"/>
                        <line x1="64" y1="40" x2="72" y2="40" stroke="white" stroke-width="1" opacity="0.4"/>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-white">Event Scout</h1>
                <p class="text-purple-100 mt-2">Smart Contact Management</p>
            </div>

            <!-- Auth Card -->
            <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
                <!-- Tabs -->
                <div class="flex border-b border-gray-200">
                    <button onclick="switchAuthTab('login')" class="auth-tab active flex-1 py-4 text-center font-semibold text-gray-600 border-b-2 border-transparent transition-all">
                        Login
                    </button>
                    <button onclick="switchAuthTab('register')" class="auth-tab flex-1 py-4 text-center font-semibold text-gray-600 border-b-2 border-transparent transition-all">
                        Register
                    </button>
                </div>

                <!-- Alert Container -->
                <div id="authAlert" class="px-6 pt-4"></div>

                <!-- Login Form -->
                <form id="loginForm" class="p-6 space-y-4" onsubmit="handleLogin(event)">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input id="loginEmail"
                               type="email"
                               autocomplete="email"
                               inputmode="email"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                               placeholder="you@example.com"
                               required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <div class="relative">
                            <input id="loginPassword"
                                   type="password"
                                   autocomplete="current-password"
                                   class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                                   placeholder="••••••••"
                                   required>
                            <button type="button"
                                    onclick="togglePassword('loginPassword')"
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold active:bg-blue-700 transition touch-feedback">
                        Sign In
                    </button>
                </form>

                <!-- Register Form -->
                <form id="registerForm" class="p-6 space-y-4 hidden" onsubmit="handleRegister(event)">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                        <input id="registerName"
                               type="text"
                               autocomplete="name"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                               placeholder="John Doe"
                               required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input id="registerEmail"
                               type="email"
                               autocomplete="email"
                               inputmode="email"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                               placeholder="you@example.com"
                               required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <div class="relative">
                            <input id="registerPassword"
                                   type="password"
                                   autocomplete="new-password"
                                   class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                                   placeholder="••••••••"
                                   minlength="6"
                                   required>
                            <button type="button"
                                    onclick="togglePassword('registerPassword')"
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold active:bg-blue-700 transition touch-feedback">
                        Create Account
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- ========================================
         MAIN APP (Dashboard with Bottom Nav)
    ======================================== -->
    <div id="mainApp" class="screen hidden flex flex-col h-screen bg-gray-50">
        <!-- Content Area (swappable screens) -->
        <div id="contentArea" class="flex-1 overflow-y-auto pb-20">

            <!-- CONTACTS SCREEN -->
            <div id="contactsScreen" class="content-screen">
                <!-- Sticky Header with Search -->
                <div class="sticky top-0 bg-white border-b border-gray-200 safe-area-inset-top z-30">
                    <div class="p-4 pb-3">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <svg width="28" height="28" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <defs><linearGradient id="logoGradSm" x1="0" y1="0" x2="80" y2="80" gradientUnits="userSpaceOnUse"><stop offset="0%" stop-color="#7c3aed"/><stop offset="100%" stop-color="#2563eb"/></linearGradient></defs>
                                    <circle cx="40" cy="40" r="38" stroke="url(#logoGradSm)" stroke-width="3" fill="none" opacity="0.3"/>
                                    <circle cx="40" cy="40" r="28" stroke="url(#logoGradSm)" stroke-width="3" fill="none" opacity="0.5"/>
                                    <circle cx="40" cy="40" r="18" stroke="url(#logoGradSm)" stroke-width="3" fill="none" opacity="0.7"/>
                                    <circle cx="40" cy="40" r="5" fill="url(#logoGradSm)"/>
                                    <path d="M40 40 L40 2 A38 38 0 0 1 72 22 Z" fill="url(#logoGradSm)" opacity="0.15"/>
                                    <circle cx="58" cy="18" r="5" fill="#7c3aed" opacity="0.9"/>
                                    <circle cx="22" cy="56" r="4" fill="#2563eb" opacity="0.8"/>
                                </svg>
                                <div>
                                    <h2 class="text-xl font-bold text-gray-900">Contacts</h2>
                                    <p class="text-sm text-gray-500">Hi, <span id="userName"></span>!</p>
                                </div>
                            </div>
                        </div>
                        <div class="relative">
                            <input type="search"
                                   id="searchInput"
                                   placeholder="Search contacts..."
                                   class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                                   oninput="handleSearch()">
                            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        </div>
                    </div>
                </div>

                <!-- Hot Leads Spotlight -->
                <div id="hotLeadsBanner" class="hidden px-4 pt-3">
                    <div class="bg-gradient-to-r from-red-500 to-orange-500 rounded-xl p-4 shadow-sm">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-white font-bold text-sm"><i class="fas fa-fire mr-1"></i>Your Hottest Leads</h3>
                        </div>
                        <div id="hotLeadsScroll" class="flex gap-3 overflow-x-auto pb-1">
                            <!-- Hot leads cards injected here -->
                        </div>
                    </div>
                </div>

                <!-- Contact List -->
                <div id="contactsList" class="divide-y divide-gray-200">
                    <!-- Contacts will be rendered here -->
                </div>

                <!-- Floating Action Button -->
                <button onclick="openAddContactSheet()"
                        class="fixed bottom-24 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-lg active:scale-95 transition z-30 touch-feedback">
                    <i class="fas fa-plus text-xl"></i>
                </button>
            </div>

            <!-- SCAN SCREEN -->
            <div id="scanScreen" class="content-screen hidden">
                <div class="fixed inset-0 flex flex-col bg-black" style="top:0;bottom:0;z-index:40;">
                    <!-- Camera View - fills available space -->
                    <div id="cameraView" class="flex-1 relative overflow-hidden" style="min-height:0;">
                        <!-- Video Stream -->
                        <video id="cameraStream" class="absolute inset-0 w-full h-full object-cover" autoplay playsinline></video>

                        <!-- Overlay Guide -->
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <div class="border-4 border-white/80 rounded-2xl shadow-2xl relative" style="width:85%;max-width:340px;aspect-ratio:1.7/1;">
                                <div class="absolute -top-10 left-0 right-0 text-center">
                                    <p class="text-white text-xs font-medium bg-black/60 px-3 py-1.5 rounded-full inline-block">
                                        Align card within frame
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Bulk scan counter toast -->
                        <div id="scanCounter" class="hidden absolute top-4 right-4 bg-green-500 text-white px-3 py-1.5 rounded-full text-sm font-semibold shadow-lg z-10">
                            <i class="fas fa-check mr-1"></i><span id="scanCountText">0 scanned</span>
                        </div>

                        <!-- Camera Error State -->
                        <div id="cameraError" class="hidden absolute inset-0 flex items-center justify-center bg-gray-900 p-8 text-center">
                            <div>
                                <i class="fas fa-camera-slash text-6xl text-gray-400 mb-4"></i>
                                <h3 class="text-xl font-semibold text-white mb-2">Camera Not Available</h3>
                                <p class="text-sm text-gray-300 mb-6">
                                    Please allow camera access or upload an image
                                </p>
                                <button onclick="uploadFromGallery()" class="bg-white text-gray-900 px-6 py-3 rounded-lg font-semibold">
                                    Upload from Gallery
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Controls - fixed at bottom, always visible -->
                    <div class="bg-gray-900/95 backdrop-blur-sm px-4 pt-3 pb-20 safe-area-inset-bottom" style="flex-shrink:0;">
                        <div class="flex justify-center gap-5 items-center">
                            <button onclick="uploadFromGallery()" class="w-11 h-11 bg-gray-700 rounded-full text-white flex items-center justify-center active:bg-gray-600">
                                <i class="fas fa-image text-sm"></i>
                            </button>

                            <button id="captureBtn" onclick="captureBusinessCard()" class="w-16 h-16 bg-white rounded-full shadow-lg active:scale-95 transition flex items-center justify-center border-4 border-gray-300">
                                <div class="w-12 h-12 bg-white rounded-full border-2 border-gray-400"></div>
                            </button>

                            <button onclick="switchCamera()" class="w-11 h-11 bg-gray-700 rounded-full text-white flex items-center justify-center active:bg-gray-600">
                                <i class="fas fa-sync-alt text-sm"></i>
                            </button>
                        </div>
                        <!-- Done button for bulk scan mode -->
                        <div id="bulkScanDone" class="hidden mt-2">
                            <button onclick="finishBulkScan()" class="w-full py-2 bg-green-500 text-white rounded-lg font-semibold text-sm active:bg-green-600">
                                <i class="fas fa-check mr-1"></i>Done - View Contacts
                            </button>
                        </div>
                    </div>

                    <!-- Hidden file input (supports multiple) -->
                    <input type="file" id="galleryInput" accept="image/*" multiple class="hidden" onchange="handleGalleryUpload(event)">

                    <!-- Processing Overlay - multi-step -->
                    <div id="processingOverlay" class="hidden absolute inset-0 bg-black/90 flex-col items-center justify-center z-50">
                        <div class="text-center px-8">
                            <div id="processStep1" class="flex items-center gap-3 text-white mb-3">
                                <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center">
                                    <i class="fas fa-upload text-sm"></i>
                                </div>
                                <span class="text-sm">Uploading image...</span>
                            </div>
                            <div id="processStep2" class="flex items-center gap-3 text-gray-500 mb-3">
                                <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center">
                                    <i class="fas fa-brain text-sm"></i>
                                </div>
                                <span class="text-sm">AI analyzing card...</span>
                            </div>
                            <div id="processStep3" class="flex items-center gap-3 text-gray-500 mb-3">
                                <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center">
                                    <i class="fas fa-save text-sm"></i>
                                </div>
                                <span class="text-sm">Saving contact...</span>
                            </div>
                            <div id="processStep4" class="flex items-center gap-3 text-gray-500">
                                <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center">
                                    <i class="fas fa-check text-sm"></i>
                                </div>
                                <span class="text-sm">Done!</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CHAT SCREEN -->
            <div id="chatScreen" class="content-screen hidden flex flex-col h-screen bg-gray-50">
                <!-- Chat Header -->
                <div class="bg-gradient-to-r from-purple-600 to-blue-500 text-white p-4 flex items-center justify-between safe-area-inset-top">
                    <div>
                        <h2 class="font-semibold text-lg">AI Assistant</h2>
                        <p class="text-xs text-purple-100" id="chatModelLabel">Powered by Claude Opus 4.6</p>
                    </div>
                    <button onclick="clearChatHistory()" class="p-2 text-white/80 active:bg-white/20 rounded-lg">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>

                <!-- Suggested Queries (shown when empty) -->
                <div id="chatSuggestions" class="p-4 space-y-2">
                    <p class="text-sm text-gray-600 mb-3">Try asking:</p>
                    <button onclick="askAI('Who are my hottest leads right now?')" class="block w-full text-left px-4 py-3 bg-blue-50 hover:bg-blue-100 rounded-lg text-sm text-gray-700 active:bg-blue-200">
                        "Who are my hottest leads right now?"
                    </button>
                    <button onclick="askAI('Which exhibitors should I visit today?')" class="block w-full text-left px-4 py-3 bg-purple-50 hover:bg-purple-100 rounded-lg text-sm text-gray-700 active:bg-purple-200">
                        "Which exhibitors should I visit today?"
                    </button>
                    <button onclick="askAI('Brief me on my top 3 contacts')" class="block w-full text-left px-4 py-3 bg-green-50 hover:bg-green-100 rounded-lg text-sm text-gray-700 active:bg-green-200">
                        "Brief me on my top 3 contacts"
                    </button>
                    <button onclick="askAI('Suggest pitch angles for my warm leads')" class="block w-full text-left px-4 py-3 bg-orange-50 hover:bg-orange-100 rounded-lg text-sm text-gray-700 active:bg-orange-200">
                        "Suggest pitch angles for my warm leads"
                    </button>
                </div>

                <!-- Messages Container -->
                <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 pb-24">
                    <!-- Messages rendered here -->
                </div>

                <!-- Input Area (fixed at bottom) -->
                <div class="border-t border-gray-200 bg-white p-4 pb-safe-area fixed bottom-16 left-0 right-0">
                    <form onsubmit="sendChatMessage(event)" class="flex gap-2">
                        <input type="text"
                               id="chatInput"
                               placeholder="Ask about your contacts..."
                               class="flex-1 px-4 py-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-blue-500 outline-none"
                               required>
                        <button type="button" onclick="toggleChatVoice()" id="chatMicBtn"
                                class="w-12 h-12 bg-gray-100 text-gray-500 rounded-full flex items-center justify-center active:bg-purple-100 flex-shrink-0 transition">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button type="submit"
                                class="w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center active:bg-blue-700 flex-shrink-0">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>

            <!-- EXPO SCREEN -->
            <div id="expoScreen" class="content-screen hidden">
                <div class="safe-area-inset-top">
                    <!-- Expo Header -->
                    <div class="bg-gradient-to-r from-emerald-600 to-teal-500 text-white p-4">
                        <h2 id="expoEventName" class="font-semibold text-lg">Select Event in Profile</h2>
                        <p id="expoEventDetails" class="text-xs text-emerald-100">Set your current event to see exhibitors</p>
                    </div>

                    <!-- Search & Filter -->
                    <div class="p-4 bg-white border-b border-gray-200">
                        <input type="search" id="expoSearchInput" placeholder="Search exhibitors..."
                               class="w-full px-4 py-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-emerald-500 outline-none mb-2"
                               oninput="filterExhibitors()">
                        <div id="categoryFilter" class="flex gap-2 overflow-x-auto pb-1 text-sm">
                            <button onclick="filterByCategory('')" class="category-btn px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full whitespace-nowrap text-xs font-medium">All</button>
                        </div>
                    </div>

                    <!-- Exhibitor List -->
                    <div id="exhibitorList" class="p-4 space-y-3">
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-spinner fa-spin text-2xl mb-3 block"></i>
                            <p>Loading exhibitors...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PROFILE SCREEN -->
            <div id="profileScreen" class="content-screen hidden">
                <div class="p-6 space-y-6 safe-area-inset-top">
                    <h2 class="text-2xl font-bold text-gray-900">Profile</h2>

                    <div class="bg-white rounded-xl p-6 shadow-sm">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-20 h-20 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-white text-3xl font-bold">
                                <span id="profileInitial"></span>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900" id="profileName"></h3>
                                <p class="text-sm text-gray-500" id="profileEmail"></p>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <div class="flex items-center justify-between py-3 border-t border-gray-100">
                                <span class="text-gray-700">Total Contacts</span>
                                <span class="font-semibold text-gray-900" id="totalContacts">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Personalization Settings -->
                    <div class="bg-white rounded-xl p-6 shadow-sm space-y-3">
                        <h3 class="font-semibold text-gray-900">Personalization</h3>
                        <p class="text-xs text-gray-500">Help AI personalize scoring, pitches, and advice</p>
                        <button onclick="openSettingsSheet('products')" class="w-full flex items-center justify-between py-3 px-4 bg-purple-50 rounded-lg active:bg-purple-100 transition">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-box text-purple-600 text-lg w-6 text-center"></i>
                                <span class="text-gray-700">Products & Services</span>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>
                        <button onclick="openSettingsSheet('targeting')" class="w-full flex items-center justify-between py-3 px-4 bg-blue-50 rounded-lg active:bg-blue-100 transition">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-crosshairs text-blue-600 text-lg w-6 text-center"></i>
                                <span class="text-gray-700">Target Market</span>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>
                        <button onclick="openSettingsSheet('pitch')" class="w-full flex items-center justify-between py-3 px-4 bg-green-50 rounded-lg active:bg-green-100 transition">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-bullseye text-green-600 text-lg w-6 text-center"></i>
                                <span class="text-gray-700">Pitch & Value Props</span>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>
                        <button onclick="openSettingsSheet('event')" class="w-full flex items-center justify-between py-3 px-4 bg-orange-50 rounded-lg active:bg-orange-100 transition">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-calendar-star text-orange-600 text-lg w-6 text-center"></i>
                                <span class="text-gray-700">Current Event</span>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>

                        <!-- AI Model Selection -->
                        <div class="mt-4 pt-4 border-t border-gray-100">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">AI Assistant Model</h4>
                            <select id="aiModelSelect" onchange="saveAIModel()"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white text-gray-700">
                                <option value="claude-opus">Claude Opus 4.6 (Recommended)</option>
                                <option value="gpt-5">GPT-5.2</option>
                                <option value="gemini-pro">Gemini 2.5 Pro</option>
                            </select>
                            <p class="text-xs text-gray-400 mt-1">Controls the AI chat. OCR scanning uses Gemini.</p>
                        </div>
                    </div>

                    <!-- Lead Intelligence -->
                    <div class="bg-white rounded-xl p-6 shadow-sm space-y-3">
                        <h3 class="font-semibold text-gray-900">Lead Intelligence</h3>
                        <div id="dashboardStats" class="grid grid-cols-3 gap-3 text-center">
                            <div class="bg-red-50 rounded-lg p-3">
                                <p class="text-2xl font-bold text-red-600" id="statHot">-</p>
                                <p class="text-xs text-gray-500">Hot</p>
                            </div>
                            <div class="bg-orange-50 rounded-lg p-3">
                                <p class="text-2xl font-bold text-orange-500" id="statWarm">-</p>
                                <p class="text-xs text-gray-500">Warm</p>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3">
                                <p class="text-2xl font-bold text-gray-500" id="statCold">-</p>
                                <p class="text-xs text-gray-500">Cold</p>
                            </div>
                        </div>
                        <button onclick="scoreAllContacts()" id="scoreAllBtn" class="w-full flex items-center justify-center gap-2 py-3 px-4 bg-gradient-to-r from-purple-600 to-blue-500 text-white rounded-lg font-semibold active:opacity-90 transition">
                            <i class="fas fa-bolt"></i>
                            <span>Score All Contacts</span>
                        </button>
                    </div>

                    <!-- Digital Business Card -->
                    <div class="bg-white rounded-xl p-6 shadow-sm space-y-3">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-900">My Digital Card</h3>
                            <i class="fas fa-qrcode text-blue-500 text-lg"></i>
                        </div>
                        <p class="text-xs text-gray-500">Share your contact info via QR code or NFC tap</p>

                        <!-- Card Form -->
                        <div class="space-y-2">
                            <input type="text" id="cardFullName" placeholder="Full Name" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            <input type="text" id="cardJobTitle" placeholder="Job Title" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            <input type="text" id="cardCompanyName" placeholder="Company" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            <input type="email" id="cardEmail" placeholder="Email" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            <input type="tel" id="cardPhone" placeholder="Phone Number" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            <input type="url" id="cardLinkedIn" placeholder="LinkedIn URL" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            <input type="tel" id="cardZoom" placeholder="Zoom Number (optional)" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            <input type="url" id="cardWebsite" placeholder="Website (optional)" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>

                        <!-- Save Card Button -->
                        <button onclick="saveDigitalCard()" class="w-full flex items-center justify-center gap-2 py-3 px-4 bg-gradient-to-r from-blue-600 to-cyan-500 text-white rounded-lg font-semibold active:opacity-90 transition">
                            <i class="fas fa-save"></i>
                            <span>Save Card</span>
                        </button>

                        <!-- Generate QR Button -->
                        <button onclick="generateCardQR()" id="generateQRBtn" class="w-full flex items-center justify-center gap-2 py-3 px-4 bg-gradient-to-r from-purple-600 to-pink-500 text-white rounded-lg font-semibold active:opacity-90 transition">
                            <i class="fas fa-qrcode"></i>
                            <span>Generate QR Code</span>
                        </button>

                        <!-- QR Code Display -->
                        <div id="cardQRContainer" class="hidden mt-3">
                            <div class="bg-gray-50 rounded-lg p-4 text-center">
                                <img id="cardQRImage" src="" alt="QR Code" class="mx-auto max-w-full" style="max-width: 250px;">
                                <p class="text-xs text-gray-600 mt-2">Share this QR code with people you meet!</p>
                                <p id="cardShareableURL" class="text-xs text-blue-600 mt-1 break-all"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Export Section -->
                    <div class="bg-white rounded-xl p-6 shadow-sm space-y-3">
                        <h3 class="font-semibold text-gray-900">Data Export</h3>
                        <button onclick="exportContacts('csv')" class="w-full flex items-center justify-between py-3 px-4 bg-green-50 rounded-lg active:bg-green-100 transition">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-file-csv text-green-600 text-lg"></i>
                                <span class="text-gray-700">Export as CSV</span>
                            </div>
                            <i class="fas fa-download text-gray-400"></i>
                        </button>
                        <button onclick="exportContacts('json')" class="w-full flex items-center justify-between py-3 px-4 bg-blue-50 rounded-lg active:bg-blue-100 transition">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-file-code text-blue-600 text-lg"></i>
                                <span class="text-gray-700">Export as JSON</span>
                            </div>
                            <i class="fas fa-download text-gray-400"></i>
                        </button>
                    </div>

                    <button onclick="handleLogout()" class="w-full bg-red-500 text-white py-3 rounded-lg font-semibold active:bg-red-600 transition touch-feedback">
                        <i class="fas fa-sign-out-alt mr-2"></i>
                        Logout
                    </button>
                </div>
            </div>
        </div>

            <!-- ADMIN SCREEN (hidden by default, shown only for admins) -->
            <div id="adminScreen" class="content-screen hidden">
                <div class="p-4 space-y-4">
                    <div class="flex items-center gap-3 mb-2">
                        <i class="fas fa-shield-alt text-purple-600 text-xl"></i>
                        <h2 class="text-xl font-bold text-gray-900">Admin Dashboard</h2>
                    </div>

                    <!-- Global Stats -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-gradient-to-br from-purple-500 to-blue-500 text-white rounded-xl p-4">
                            <p class="text-3xl font-bold" id="adminStatUsers">-</p>
                            <p class="text-sm opacity-80">Total Users</p>
                        </div>
                        <div class="bg-gradient-to-br from-blue-500 to-cyan-500 text-white rounded-xl p-4">
                            <p class="text-3xl font-bold" id="adminStatContacts">-</p>
                            <p class="text-sm opacity-80">Total Contacts</p>
                        </div>
                        <div class="bg-red-50 rounded-xl p-4">
                            <p class="text-2xl font-bold text-red-600" id="adminStatHot">-</p>
                            <p class="text-xs text-gray-500">Hot Leads</p>
                        </div>
                        <div class="bg-orange-50 rounded-xl p-4">
                            <p class="text-2xl font-bold text-orange-500" id="adminStatWarm">-</p>
                            <p class="text-xs text-gray-500">Warm Leads</p>
                        </div>
                    </div>

                    <!-- Team Members -->
                    <div class="bg-white rounded-xl p-4 shadow-sm">
                        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-3">Team Members</h3>
                        <div id="adminTeamList" class="space-y-3">
                            <p class="text-sm text-gray-400 text-center py-4">Loading...</p>
                        </div>
                    </div>

                    <!-- Recent Contacts Feed -->
                    <div class="bg-white rounded-xl p-4 shadow-sm">
                        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-3">Recent Contacts (All Users)</h3>
                        <div id="adminRecentContacts" class="space-y-2">
                            <p class="text-sm text-gray-400 text-center py-4">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 safe-area-inset-bottom z-40">
            <div class="flex justify-around items-center h-16">
                <button onclick="switchScreen('contacts')" class="nav-btn active flex flex-col items-center justify-center flex-1 h-full text-gray-600 transition">
                    <i class="fas fa-address-book text-2xl mb-1"></i>
                    <span class="text-xs">Contacts</span>
                </button>
                <button onclick="switchScreen('scan')" class="nav-btn flex flex-col items-center justify-center flex-1 h-full text-gray-600 transition">
                    <i class="fas fa-camera text-2xl mb-1"></i>
                    <span class="text-xs">Scan</span>
                </button>
                <button onclick="switchScreen('chat')" class="nav-btn flex flex-col items-center justify-center flex-1 h-full text-gray-600 transition">
                    <i class="fas fa-comments text-2xl mb-1"></i>
                    <span class="text-xs">AI Chat</span>
                </button>
                <button onclick="switchScreen('expo')" class="nav-btn flex flex-col items-center justify-center flex-1 h-full text-gray-600 transition">
                    <i class="fas fa-building text-2xl mb-1"></i>
                    <span class="text-xs">Expo</span>
                </button>
                <button id="adminNavBtn" onclick="switchScreen('admin')" class="nav-btn hidden flex flex-col items-center justify-center flex-1 h-full text-gray-600 transition">
                    <i class="fas fa-shield-alt text-2xl mb-1"></i>
                    <span class="text-xs">Admin</span>
                </button>
                <button onclick="switchScreen('profile')" class="nav-btn flex flex-col items-center justify-center flex-1 h-full text-gray-600 transition">
                    <i class="fas fa-user text-2xl mb-1"></i>
                    <span class="text-xs">Profile</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- ========================================
         VOICE RECORDING OVERLAY
    ======================================== -->
    <div id="voiceRecordingOverlay" class="fixed inset-0 z-60 hidden" style="background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);">
        <div class="flex flex-col items-center justify-center h-full px-6">
            <div class="bg-white rounded-2xl p-6 w-full max-w-sm text-center shadow-2xl">
                <div id="voiceContactName" class="text-sm text-gray-500 mb-2">Recording for...</div>
                <div class="mb-4">
                    <button id="voiceRecordBtn" onclick="toggleVoiceRecording()" class="w-20 h-20 rounded-full bg-red-500 text-white text-3xl flex items-center justify-center mx-auto recording-pulse">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>
                <div id="voiceTimer" class="text-2xl font-mono text-gray-700 mb-2">0:00</div>
                <div id="voiceStatus" class="text-sm text-gray-500 mb-3">Tap to start recording</div>
                <div id="voiceTranscript" class="text-sm text-gray-800 bg-gray-50 rounded-lg p-3 min-h-[60px] max-h-[120px] overflow-y-auto text-left mb-4 hidden">
                    <span class="text-gray-400 italic">Listening...</span>
                </div>
                <div class="flex gap-3">
                    <button onclick="cancelVoiceRecording()" class="flex-1 py-3 rounded-lg bg-gray-100 text-gray-600 font-medium active:bg-gray-200">Cancel</button>
                    <button id="voiceSaveBtn" onclick="saveVoiceNote()" class="flex-1 py-3 rounded-lg bg-purple-600 text-white font-medium active:bg-purple-700 hidden">Save Note</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
         CONTACT DETAIL VIEW (slide-in)
    ======================================== -->
    <div id="contactDetailView" class="fixed inset-0 z-45 bg-white hidden">
        <div id="contactDetailContent" class="h-full overflow-y-auto">
            <!-- Populated by openContactDetail() -->
        </div>
    </div>

    <!-- ========================================
         BOTTOM SHEET - Add/Edit Contact
    ======================================== -->
    <div id="contactSheet" class="fixed inset-0 z-50 hidden">
        <!-- Backdrop -->
        <div class="backdrop absolute inset-0 bg-black/50" onclick="closeContactSheet()"></div>

        <!-- Sheet Content -->
        <div class="sheet-content absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl max-h-[90vh] flex flex-col transform translate-y-full transition-transform duration-300 slide-up">
            <!-- Handle (for visual affordance) -->
            <div class="flex justify-center py-3 border-b border-gray-200">
                <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
            </div>

            <!-- Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                <h2 id="sheetTitle" class="text-xl font-semibold">Add Contact</h2>
                <button onclick="closeContactSheet()" class="p-2 text-gray-400 active:bg-gray-100 rounded-lg transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Alert Container -->
            <div id="modalAlert" class="px-6 pt-2"></div>

            <!-- Scrollable Form -->
            <form id="contactForm" onsubmit="handleContactSubmit(event)" class="flex-1 overflow-y-auto p-6 space-y-5">
                <input type="hidden" id="contactId">

                <!-- Contact Info Section -->
                <div class="space-y-4">
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Contact Info</p>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                        <input type="text" id="contactName" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50 focus:bg-white transition">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                        <input type="email" id="contactEmail" inputmode="email" autocomplete="email" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50 focus:bg-white transition">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone *</label>
                        <input type="tel" id="contactPhone" inputmode="tel" autocomplete="tel" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50 focus:bg-white transition">
                    </div>
                </div>

                <!-- Professional Section -->
                <div class="space-y-4">
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Professional</p>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Company</label>
                        <input type="text" id="contactCompany" autocomplete="organization"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50 focus:bg-white transition">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">LinkedIn</label>
                        <input type="url" id="contactLinkedin" inputmode="url"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50 focus:bg-white transition"
                               placeholder="https://linkedin.com/in/username">
                    </div>
                </div>

                <!-- Notes Section -->
                <div class="space-y-4">
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Notes</p>
                    <div>
                        <textarea id="contactNotes" rows="3"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50 focus:bg-white transition resize-none"
                                  placeholder="Add notes about this contact..."></textarea>
                    </div>
                </div>

                <!-- Submit Button (sticky at bottom) -->
                <div class="sticky bottom-0 bg-white pt-4 pb-safe-area">
                    <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-lg font-semibold active:bg-blue-700 transition touch-feedback">
                        Save Contact
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ========================================
         BOTTOM SHEET - Settings
    ======================================== -->
    <div id="settingsSheet" class="fixed inset-0 z-50 hidden">
        <div class="backdrop absolute inset-0 bg-black/50" onclick="closeSettingsSheet()"></div>
        <div class="sheet-content absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl max-h-[90vh] flex flex-col transform translate-y-full transition-transform duration-300 slide-up">
            <div class="flex justify-center py-3 border-b border-gray-200">
                <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
            </div>
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                <h2 id="settingsSheetTitle" class="text-xl font-semibold">Settings</h2>
                <button onclick="closeSettingsSheet()" class="p-2 text-gray-400 active:bg-gray-100 rounded-lg transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="settingsSheetBody" class="flex-1 overflow-y-auto p-6 space-y-5">
                <!-- Populated dynamically -->
            </div>
        </div>
    </div>

    <!-- ========================================
         JAVASCRIPT
    ======================================== -->
    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            API_BASE_URL: window.location.hostname === 'localhost'
                ? 'http://localhost:8000'
                : 'https://event-scout-production.up.railway.app',
            API_KEY: 'OGibuBdW6KP52UMTpv8g46Zs37g47d9SGv4w21W-o6s'
        };

        // ==================== STATE MANAGEMENT ====================
        const AppState = {
            currentUser: null,
            contacts: [],
            activeScreen: 'contacts',
            editingContactId: null,
            userProfile: {},
            _voiceContactId: null,
            _voiceTranscript: '',
            _voiceAudioBlob: null,
        };

        // ==================== INITIALIZATION ====================
        window.addEventListener('DOMContentLoaded', () => {
            const savedUser = localStorage.getItem('eventScoutUser');
            if (savedUser) {
                AppState.currentUser = JSON.parse(savedUser);
                showDashboard();
            }

            // Register service worker (if available)
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => console.log('[SW] Registered', reg))
                    .catch(err => console.error('[SW] Registration failed', err));
            }
        });

        // ==================== AUTH FUNCTIONS ====================
        function switchAuthTab(tab) {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const tabs = document.querySelectorAll('.auth-tab');

            tabs.forEach(t => {
                t.classList.remove('active', 'text-blue-600', 'border-blue-600');
                t.classList.add('text-gray-600', 'border-transparent');
            });

            if (tab === 'login') {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                tabs[0].classList.add('active', 'text-blue-600', 'border-blue-600');
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                tabs[1].classList.add('active', 'text-blue-600', 'border-blue-600');
            }

            document.getElementById('authAlert').innerHTML = '';
        }

        async function handleLogin(event) {
            event.preventDefault();

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/login/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok && data.status === 'success') {
                    AppState.currentUser = {
                        user_id: data.user_id,
                        name: data.name,
                        email: data.email,
                        is_admin: data.is_admin || false
                    };
                    localStorage.setItem('eventScoutUser', JSON.stringify(AppState.currentUser));
                    showAlert('authAlert', '✓ Login successful!', 'success');
                    setTimeout(() => showDashboard(), 500);
                } else {
                    showAlert('authAlert', data.detail || 'Login failed', 'error');
                }
            } catch (error) {
                showAlert('authAlert', 'Network error. Please check your API configuration.', 'error');
                console.error('Login error:', error);
            }
        }

        async function handleRegister(event) {
            event.preventDefault();

            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/register/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password })
                });

                const data = await response.json();

                if (response.ok && data.status === 'success') {
                    showAlert('authAlert', '✓ Registration successful! Logging you in...', 'success');
                    AppState.currentUser = {
                        user_id: data.user_id,
                        name: data.name,
                        email: data.email,
                        is_admin: data.is_admin || false
                    };
                    localStorage.setItem('eventScoutUser', JSON.stringify(AppState.currentUser));
                    setTimeout(() => showDashboard(), 1000);
                } else {
                    showAlert('authAlert', data.detail || 'Registration failed', 'error');
                }
            } catch (error) {
                showAlert('authAlert', 'Network error. Please check your API configuration.', 'error');
                console.error('Register error:', error);
            }
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('eventScoutUser');
                AppState.currentUser = null;
                AppState.contacts = [];
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('authScreen').classList.remove('hidden');
            }
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling.querySelector('i');

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        // ==================== DASHBOARD FUNCTIONS ====================
        function showDashboard() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userName').textContent = AppState.currentUser.name;
            document.getElementById('profileName').textContent = AppState.currentUser.name;
            document.getElementById('profileEmail').textContent = AppState.currentUser.email;
            document.getElementById('profileInitial').textContent = AppState.currentUser.name.charAt(0).toUpperCase();

            // Show admin nav button if user is admin
            const adminBtn = document.getElementById('adminNavBtn');
            if (AppState.currentUser.is_admin) {
                adminBtn.classList.remove('hidden');
            } else {
                adminBtn.classList.add('hidden');
            }

            loadContacts();
            loadUserProfile();
            loadDigitalCard();
        }

        function switchScreen(screenName) {
            // Stop camera if leaving scan screen
            if (AppState.activeScreen === 'scan' && cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }

            // Hide all content screens
            document.querySelectorAll('.content-screen').forEach(s => s.classList.add('hidden'));

            // Show target screen
            document.getElementById(`${screenName}Screen`).classList.remove('hidden');

            // Update nav button states
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active', 'text-blue-600');
                btn.classList.add('text-gray-600');
            });

            // Highlight the correct nav button
            const navMap = { contacts: 0, scan: 1, chat: 2, expo: 3, admin: 4, profile: 5 };
            const navBtns = document.querySelectorAll('.nav-btn');
            const idx = navMap[screenName];
            if (idx !== undefined && navBtns[idx]) {
                navBtns[idx].classList.add('active', 'text-blue-600');
                navBtns[idx].classList.remove('text-gray-600');
            }

            // Update app state
            AppState.activeScreen = screenName;

            // Update URL (for back button)
            history.pushState({ screen: screenName }, '', `#${screenName}`);

            // Initialize screen-specific features
            if (screenName === 'profile') {
                document.getElementById('totalContacts').textContent = AppState.contacts.length;
                loadDashboardStats();
                loadDigitalCard();
            } else if (screenName === 'scan') {
                // Initialize camera and reset bulk scan counter
                scanSessionCount = 0;
                document.getElementById('scanCounter').classList.add('hidden');
                document.getElementById('bulkScanDone').classList.add('hidden');
                initCamera();
            } else if (screenName === 'chat') {
                // Load chat history when entering chat screen
                loadChatHistory();
            } else if (screenName === 'expo') {
                loadExhibitors();
            } else if (screenName === 'admin') {
                loadAdminDashboard();
            }
        }

        // ==================== CONTACT FUNCTIONS ====================
        async function loadContacts() {
            const contactsList = document.getElementById('contactsList');
            contactsList.innerHTML = '<div class="p-12 text-center text-gray-400"><i class="fas fa-spinner fa-spin text-4xl mb-3"></i><p>Loading contacts...</p></div>';

            try {
                const response = await fetch(
                    `${CONFIG.API_BASE_URL}/list_contacts/?user_id=${AppState.currentUser.user_id}`,
                    {
                        headers: { 'X-API-Key': CONFIG.API_KEY }
                    }
                );

                const data = await response.json();

                if (response.ok && data.status === 'success') {
                    AppState.contacts = data.contacts;
                    renderContacts(AppState.contacts);
                    renderHotLeads();
                } else {
                    contactsList.innerHTML = `<div class="p-6 text-center text-red-500">Failed to load contacts</div>`;
                }
            } catch (error) {
                contactsList.innerHTML = `<div class="p-6 text-center text-red-500">Network error. Please check your API configuration.</div>`;
                console.error('Load contacts error:', error);
            }
        }

        function getAvatarClass(name) {
            let hash = 0;
            for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
            return 'avatar-gradient-' + (Math.abs(hash) % 8);
        }

        function renderContacts(contacts) {
            const contactsList = document.getElementById('contactsList');

            if (contacts.length === 0) {
                contactsList.innerHTML = `
                    <div class="p-12 text-center text-gray-400">
                        <i class="fas fa-address-book text-6xl mb-4"></i>
                        <p class="text-lg font-medium">No contacts yet</p>
                        <p class="text-sm mt-2">Tap + to add or scan your first contact</p>
                    </div>
                `;
                return;
            }

            contactsList.innerHTML = contacts.map(contact => {
                const hasNotes = contact.notes && contact.notes.trim() && contact.notes !== 'N/A';
                const hasLinks = contact.links && contact.links.length > 0;
                const company = contact.company_name && contact.company_name !== 'N/A' ? contact.company_name : '';
                const escapedName = contact.name.replace(/'/g, "\\'");
                const score = contact.lead_score;
                const temp = contact.lead_temperature;
                const scoreColor = temp === 'hot' ? 'bg-red-500' : temp === 'warm' ? 'bg-orange-400' : temp === 'cold' ? 'bg-gray-400' : '';

                return `
                <div class="contact-card bg-white border-b border-gray-100 active:bg-gray-50 transition" data-id="${contact.id}" onclick="openContactDetail('${contact.id}')">
                    <div class="flex items-start p-4 gap-3">
                        <!-- Avatar with score badge -->
                        <div class="relative flex-shrink-0 mt-0.5">
                            <div class="w-12 h-12 rounded-full ${getAvatarClass(contact.name)} flex items-center justify-center text-white font-bold text-lg">
                                ${contact.name.charAt(0).toUpperCase()}
                            </div>
                            ${score != null ? `<div class="absolute -top-1 -right-1 w-6 h-6 rounded-full ${scoreColor} text-white text-[10px] flex items-center justify-center font-bold shadow-sm">${score}</div>` : ''}
                        </div>

                        <!-- Info -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <h3 class="font-semibold text-gray-900 truncate">${contact.name}</h3>
                                ${contact.source === 'scan' ? '<span class="text-xs bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded-full">scanned</span>' : ''}
                                ${temp === 'hot' ? '<span class="text-xs bg-red-100 text-red-600 px-1.5 py-0.5 rounded-full">hot</span>' : ''}
                            </div>
                            ${company ? `<p class="text-sm font-medium text-gray-600 truncate">${company}</p>` : ''}
                            <div class="flex items-center gap-3 mt-1">
                                ${contact.email && contact.email !== 'N/A' ? `<span class="text-xs text-gray-400 truncate"><i class="fas fa-envelope mr-1"></i>${contact.email}</span>` : ''}
                            </div>
                            ${hasNotes ? `<p class="text-xs text-gray-400 italic mt-1 truncate"><i class="fas fa-sticky-note mr-1"></i>${contact.notes.substring(0, 60)}${contact.notes.length > 60 ? '...' : ''}</p>` : ''}
                            ${hasLinks ? `<div class="flex gap-1 mt-1">${contact.links.slice(0, 2).map(l => `<span class="text-xs bg-blue-50 text-blue-500 px-1.5 py-0.5 rounded">${l.label || 'Link'}</span>`).join('')}${contact.links.length > 2 ? `<span class="text-xs text-gray-400">+${contact.links.length - 2}</span>` : ''}</div>` : ''}
                        </div>

                        <!-- Quick Actions -->
                        <div class="flex flex-col gap-1 flex-shrink-0" onclick="event.stopPropagation()">
                            <button onclick="editContact('${contact.id}')" class="p-2 text-gray-400 active:bg-blue-50 rounded-lg" title="Edit">
                                <i class="fas fa-pen text-sm"></i>
                            </button>
                            <button onclick="viewContactQR('${contact.id}')" class="p-2 text-gray-400 active:bg-gray-100 rounded-lg" title="QR">
                                <i class="fas fa-qrcode text-sm"></i>
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function renderHotLeads() {
            const hotContacts = AppState.contacts
                .filter(c => c.lead_temperature === 'hot')
                .sort((a, b) => (b.lead_score || 0) - (a.lead_score || 0))
                .slice(0, 5);

            const banner = document.getElementById('hotLeadsBanner');
            if (hotContacts.length === 0) {
                banner.classList.add('hidden');
                return;
            }

            banner.classList.remove('hidden');
            const container = document.getElementById('hotLeadsScroll');
            container.innerHTML = hotContacts.map(c => `
                <div onclick="openContactDetail('${c.id}')"
                     class="flex-shrink-0 bg-white/20 backdrop-blur-sm rounded-lg p-3 min-w-[140px] cursor-pointer active:bg-white/30">
                    <div class="flex items-center gap-2 mb-1">
                        <div class="w-8 h-8 rounded-full bg-white/30 flex items-center justify-center text-white text-sm font-bold">
                            ${c.name.charAt(0)}
                        </div>
                        <span class="text-white font-bold text-lg">${c.lead_score || '?'}</span>
                    </div>
                    <p class="text-white text-sm font-medium truncate">${c.name}</p>
                    <p class="text-white/70 text-xs truncate">${c.company_name || 'N/A'}</p>
                </div>
            `).join('');
        }

        function viewContactQR(contactId) {
            const contact = AppState.contacts.find(c => c.id === contactId);
            if (!contact) return;

            // Create QR modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70';
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };

            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-6 max-w-sm w-full">
                    <div class="text-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-900">${contact.name}</h3>
                        <p class="text-sm text-gray-500">${contact.company_name || 'No company'}</p>
                    </div>
                    ${contact.qr_base64 ? `
                        <img src="data:image/png;base64,${contact.qr_base64}"
                             alt="QR Code"
                             class="w-full rounded-lg border-2 border-gray-200 mb-4">
                        <p class="text-xs text-gray-500 text-center mb-4">Scan to save contact</p>
                    ` : '<p class="text-center text-gray-500 py-8">QR code not available</p>'}
                    <button onclick="this.closest('.fixed').remove()"
                            class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold active:bg-gray-300">
                        Close
                    </button>
                </div>
            `;

            document.body.appendChild(modal);
        }

        let searchTimeout;
        function handleSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const query = document.getElementById('searchInput').value.toLowerCase().trim();

                if (!query) {
                    renderContacts(AppState.contacts);
                    return;
                }

                // Multi-field search with relevance scoring
                const results = AppState.contacts.map(contact => {
                    let score = 0;

                    // Exact match bonus
                    if (contact.name.toLowerCase().includes(query)) score += 10;
                    if (contact.email.toLowerCase().includes(query)) score += 8;
                    if ((contact.company_name || '').toLowerCase().includes(query)) score += 6;
                    if (contact.phone.includes(query)) score += 5;
                    if ((contact.notes || '').toLowerCase().includes(query)) score += 4;

                    // Starts-with bonus
                    if (contact.name.toLowerCase().startsWith(query)) score += 5;
                    if ((contact.company_name || '').toLowerCase().startsWith(query)) score += 3;

                    return { contact, score };
                })
                .filter(r => r.score > 0)
                .sort((a, b) => b.score - a.score)
                .map(r => r.contact);

                renderContacts(results);
            }, 300); // 300ms debounce
        }


        // ==================== BOTTOM SHEET FUNCTIONS ====================
        function openAddContactSheet() {
            AppState.editingContactId = null;
            document.getElementById('sheetTitle').textContent = 'Add Contact';
            document.getElementById('contactForm').reset();
            document.getElementById('contactId').value = '';
            document.getElementById('modalAlert').innerHTML = '';

            const sheet = document.getElementById('contactSheet');
            sheet.classList.remove('hidden');

            // Trigger animation
            setTimeout(() => {
                sheet.querySelector('.sheet-content').style.transform = 'translateY(0)';
            }, 10);
        }

        function closeContactSheet() {
            const sheet = document.getElementById('contactSheet');
            const content = sheet.querySelector('.sheet-content');

            content.style.transform = 'translateY(100%)';

            setTimeout(() => {
                sheet.classList.add('hidden');
            }, 300); // Match transition duration
        }

        function editContact(contactId) {
            const contact = AppState.contacts.find(c => c.id === contactId);
            if (!contact) return;

            // Close detail view if open
            closeContactDetail();

            AppState.editingContactId = contactId;
            document.getElementById('sheetTitle').textContent = 'Edit Contact';
            document.getElementById('contactId').value = contactId;
            document.getElementById('contactName').value = contact.name;
            document.getElementById('contactEmail').value = contact.email;
            document.getElementById('contactPhone').value = contact.phone;
            document.getElementById('contactLinkedin').value = contact.linkedin !== 'N/A' ? contact.linkedin : '';
            document.getElementById('contactCompany').value = contact.company_name !== 'N/A' ? contact.company_name : '';
            document.getElementById('contactNotes').value = contact.notes && contact.notes !== 'N/A' ? contact.notes : '';
            document.getElementById('modalAlert').innerHTML = '';

            const sheet = document.getElementById('contactSheet');
            sheet.classList.remove('hidden');

            setTimeout(() => {
                sheet.querySelector('.sheet-content').style.transform = 'translateY(0)';
            }, 10);
        }

        async function handleContactSubmit(event) {
            event.preventDefault();

            const contactData = {
                name: document.getElementById('contactName').value,
                email: document.getElementById('contactEmail').value,
                phone: document.getElementById('contactPhone').value,
                linkedin: document.getElementById('contactLinkedin').value || 'N/A',
                company_name: document.getElementById('contactCompany').value || 'N/A',
                notes: document.getElementById('contactNotes').value || ''
            };

            try {
                let response;

                if (AppState.editingContactId) {
                    // Update contact
                    response = await fetch(
                        `${CONFIG.API_BASE_URL}/contact/${AppState.editingContactId}?user_id=${AppState.currentUser.user_id}`,
                        {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-API-Key': CONFIG.API_KEY
                            },
                            body: JSON.stringify(contactData)
                        }
                    );
                } else {
                    // Add new contact
                    response = await fetch(`${CONFIG.API_BASE_URL}/add_contact/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': CONFIG.API_KEY
                        },
                        body: JSON.stringify({
                            contact: contactData,
                            user_id: AppState.currentUser.user_id
                        })
                    });
                }

                const data = await response.json();

                if (response.ok && data.status === 'success') {
                    showAlert('modalAlert', '✓ Contact saved successfully!', 'success');
                    setTimeout(() => {
                        closeContactSheet();
                        loadContacts();
                    }, 1000);
                } else {
                    showAlert('modalAlert', data.detail || 'Failed to save contact', 'error');
                }
            } catch (error) {
                showAlert('modalAlert', 'Network error', 'error');
                console.error('Save contact error:', error);
            }
        }

        async function deleteContact(contactId, contactName) {
            if (!confirm(`Are you sure you want to delete ${contactName}?`)) {
                return;
            }

            try {
                const response = await fetch(
                    `${CONFIG.API_BASE_URL}/contact/${contactId}?user_id=${AppState.currentUser.user_id}`,
                    {
                        method: 'DELETE',
                        headers: { 'X-API-Key': CONFIG.API_KEY }
                    }
                );

                const data = await response.json();

                if (response.ok && data.status === 'success') {
                    showToast('✓ Contact deleted', 'success');
                    loadContacts();
                } else {
                    showToast('Failed to delete contact', 'error');
                }
            } catch (error) {
                showToast('Network error', 'error');
                console.error('Delete contact error:', error);
            }
        }

        // ==================== CAMERA SCANNER FUNCTIONS ====================
        let cameraStream = null;
        let facingMode = 'environment';
        let scanSessionCount = 0; // Bulk scan counter
        let scanProcessing = false; // Prevent double-tap

        async function initCamera() {
            try {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }
                const constraints = {
                    video: {
                        facingMode: facingMode,
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                const videoElement = document.getElementById('cameraStream');
                videoElement.srcObject = cameraStream;
                document.getElementById('cameraError').classList.add('hidden');
                videoElement.classList.remove('hidden');
            } catch (error) {
                console.error('Camera initialization error:', error);
                const errorDiv = document.getElementById('cameraError');
                errorDiv.classList.remove('hidden');
                document.getElementById('cameraStream').classList.add('hidden');
                errorDiv.innerHTML = `
                    <div class="text-center text-white">
                        <i class="fas fa-camera-slash text-6xl mb-4 text-gray-400"></i>
                        <h3 class="text-xl font-semibold mb-2">Camera Not Available</h3>
                        <p class="text-sm text-gray-300 mb-6">
                            ${error.name === 'NotAllowedError' ? 'Camera permission denied. Please enable camera access in settings.' : 'Unable to access camera. Use gallery upload instead.'}
                        </p>
                        <button onclick="uploadFromGallery()" class="bg-blue-600 px-6 py-3 rounded-lg text-white font-medium">
                            <i class="fas fa-image mr-2"></i>Upload from Gallery
                        </button>
                    </div>
                `;
            }
        }

        function updateProcessStep(step) {
            for (let i = 1; i <= 4; i++) {
                const el = document.getElementById(`processStep${i}`);
                const icon = el.querySelector('.w-8');
                if (i < step) {
                    el.classList.remove('text-gray-500');
                    el.classList.add('text-green-400');
                    icon.classList.remove('bg-gray-700', 'bg-blue-500');
                    icon.classList.add('bg-green-500');
                } else if (i === step) {
                    el.classList.remove('text-gray-500');
                    el.classList.add('text-white');
                    icon.classList.remove('bg-gray-700');
                    icon.classList.add('bg-blue-500');
                } else {
                    el.classList.remove('text-white', 'text-green-400');
                    el.classList.add('text-gray-500');
                    icon.classList.remove('bg-blue-500', 'bg-green-500');
                    icon.classList.add('bg-gray-700');
                }
            }
        }

        function showProcessing() {
            updateProcessStep(1);
            document.getElementById('processingOverlay').classList.remove('hidden');
            document.getElementById('processingOverlay').classList.add('flex');
        }

        function hideProcessing() {
            document.getElementById('processingOverlay').classList.add('hidden');
            document.getElementById('processingOverlay').classList.remove('flex');
        }

        function updateScanCounter() {
            const counter = document.getElementById('scanCounter');
            const text = document.getElementById('scanCountText');
            if (scanSessionCount > 0) {
                counter.classList.remove('hidden');
                text.textContent = `${scanSessionCount} scanned`;
                document.getElementById('bulkScanDone').classList.remove('hidden');
            }
        }

        async function processImageUpload(blob, filename) {
            /** Core upload function used by both camera capture and gallery. */
            showProcessing();

            try {
                const formData = new FormData();
                formData.append('file', blob, filename);

                // Step 1: Uploading
                updateProcessStep(1);
                const url = `${CONFIG.API_BASE_URL}/add_contact_from_image/?user_id=${encodeURIComponent(AppState.currentUser.user_id)}`;

                // Step 2: AI analyzing
                setTimeout(() => updateProcessStep(2), 500);
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'X-API-Key': CONFIG.API_KEY },
                    body: formData
                });

                // Step 3: Saving
                updateProcessStep(3);
                const data = await response.json();

                if (response.ok && data.status === 'success') {
                    // Step 4: Done
                    updateProcessStep(4);
                    const fields = data.extracted_fields || {};
                    const name = fields.name || 'Unknown';
                    const contactId = data.contact_id;
                    scanSessionCount++;
                    updateScanCounter();

                    await new Promise(r => setTimeout(r, 600));
                    hideProcessing();

                    // Trigger webhook for card acceptance (sends CookieMail)
                    if (contactId) {
                        triggerCardAcceptedWebhook(contactId, name);
                    }

                    // Show toast but DON'T leave camera - bulk scan mode
                    showToast(`${name} saved!`, 'success');
                    return true;
                } else {
                    hideProcessing();
                    let errMsg = 'Failed to extract contact info';
                    if (data.detail) {
                        errMsg = typeof data.detail === 'string' ? data.detail : JSON.stringify(data.detail);
                    } else if (data.message) {
                        errMsg = data.message;
                    }
                    showToast(errMsg, 'error');
                    return false;
                }
            } catch (error) {
                hideProcessing();
                showToast('Network error', 'error');
                console.error('Upload error:', error);
                return false;
            }
        }

        async function captureBusinessCard() {
            if (scanProcessing) return;
            scanProcessing = true;

            const videoElement = document.getElementById('cameraStream');
            if (!videoElement.srcObject) {
                showToast('Camera not initialized', 'error');
                scanProcessing = false;
                return;
            }

            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(videoElement, 0, 0);

            canvas.toBlob(async (blob) => {
                await processImageUpload(blob, 'business-card.jpg');
                scanProcessing = false;
                // Camera stays open for next scan
            }, 'image/jpeg', 0.95);
        }

        function finishBulkScan() {
            // Stop camera and go to contacts
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            scanSessionCount = 0;
            document.getElementById('scanCounter').classList.add('hidden');
            document.getElementById('bulkScanDone').classList.add('hidden');
            switchScreen('contacts');
            loadContacts();
        }

        function uploadFromGallery() {
            document.getElementById('galleryInput').click();
        }

        async function handleGalleryUpload(event) {
            const files = Array.from(event.target.files);
            if (!files.length) return;

            // Process multiple files in sequence
            for (const file of files) {
                await processImageUpload(file, file.name);
            }

            if (files.length > 1) {
                showToast(`${scanSessionCount} cards processed!`, 'success');
            }

            // If not in camera mode, go to contacts
            if (!cameraStream) {
                loadContacts();
                if (AppState.activeScreen !== 'scan') {
                    switchScreen('contacts');
                }
            }

            event.target.value = '';
        }

        async function switchCamera() {
            facingMode = facingMode === 'environment' ? 'user' : 'environment';
            await initCamera();
        }

        // ==================== AI CHAT FUNCTIONS ====================
        let chatHistory = [];

        function loadChatHistory() {
            const saved = localStorage.getItem('eventScoutChatHistory');
            if (saved) {
                try {
                    chatHistory = JSON.parse(saved);
                    renderChatHistory();
                } catch (error) {
                    console.error('Failed to load chat history:', error);
                    chatHistory = [];
                }
            }
        }

        function saveChatHistory() {
            localStorage.setItem('eventScoutChatHistory', JSON.stringify(chatHistory));
        }

        function renderChatHistory() {
            const messagesContainer = document.getElementById('chatMessages');
            const suggestionsContainer = document.getElementById('chatSuggestions');

            if (chatHistory.length === 0) {
                messagesContainer.innerHTML = '';
                suggestionsContainer.classList.remove('hidden');
            } else {
                suggestionsContainer.classList.add('hidden');
                messagesContainer.innerHTML = chatHistory.map(msg => renderChatMessage(msg)).join('');

                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        function renderChatMessage(message) {
            if (message.role === 'user') {
                return `
                    <div class="flex justify-end">
                        <div class="bg-blue-600 text-white rounded-2xl rounded-tr-sm px-4 py-3 max-w-[80%]">
                            <p class="text-sm">${escapeHtml(message.content)}</p>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="flex justify-start">
                        <div class="bg-white border border-gray-200 rounded-2xl rounded-tl-sm px-4 py-3 max-w-[80%]">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fas fa-robot text-purple-600"></i>
                                <span class="text-xs font-medium text-gray-500">AI Assistant</span>
                            </div>
                            <p class="text-sm text-gray-800">${escapeHtml(message.content)}</p>
                        </div>
                    </div>
                `;
            }
        }

        async function sendChatMessage(event) {
            event.preventDefault();

            const input = document.getElementById('chatInput');
            const query = input.value.trim();

            if (!query) return;

            // Add user message to history
            chatHistory.push({ role: 'user', content: query });
            renderChatHistory();

            // Clear input
            input.value = '';

            // Show typing indicator
            const messagesContainer = document.getElementById('chatMessages');
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'flex justify-start';
            typingIndicator.id = 'typingIndicator';
            typingIndicator.innerHTML = `
                <div class="bg-gray-100 rounded-2xl rounded-tl-sm px-4 py-3">
                    <div class="flex gap-1">
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(typingIndicator);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/converse/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': CONFIG.API_KEY
                    },
                    body: JSON.stringify({
                        user_id: AppState.currentUser.user_id,
                        query: query,
                        conversation_history: chatHistory.slice(-10).map(m => ({
                            role: m.role,
                            content: m.content
                        }))
                    })
                });

                const data = await response.json();

                // Remove typing indicator
                document.getElementById('typingIndicator')?.remove();

                if (response.ok) {
                    // Add AI response to history
                    const aiMessage = data.response || data.message || 'I found some information for you.';
                    chatHistory.push({ role: 'assistant', content: aiMessage });

                    if (data.model) {
                        document.getElementById('chatModelLabel').textContent = `Powered by ${data.model}`;
                    }

                    saveChatHistory();
                    renderChatHistory();
                } else {
                    showToast(data.detail || 'Failed to get response', 'error');
                    chatHistory.pop(); // Remove user message if failed
                    renderChatHistory();
                }
            } catch (error) {
                document.getElementById('typingIndicator')?.remove();
                showToast('Network error', 'error');
                console.error('Chat error:', error);
                chatHistory.pop();
                renderChatHistory();
            }
        }

        function askAI(query) {
            document.getElementById('chatInput').value = query;
            document.getElementById('chatInput').focus();
        }

        function clearChatHistory() {
            if (confirm('Clear all chat history?')) {
                chatHistory = [];
                saveChatHistory();
                renderChatHistory();
                showToast('Chat history cleared', 'success');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== CONTACT DETAIL VIEW ====================
        let _swipeVoiceTriggered = 0;
        function openContactDetail(contactId) {
            // Skip if voice recording was just triggered by swipe
            if (Date.now() - _swipeVoiceTriggered < 500) return;
            const contact = AppState.contacts.find(c => c.id === contactId);
            if (!contact) return;

            const detailView = document.getElementById('contactDetailView');
            const detailContent = document.getElementById('contactDetailContent');
            const company = contact.company_name && contact.company_name !== 'N/A' ? contact.company_name : '';
            const hasNotes = contact.notes && contact.notes.trim() && contact.notes !== 'N/A';
            const hasLinks = contact.links && contact.links.length > 0;
            const linkedin = contact.linkedin && contact.linkedin !== 'N/A' ? contact.linkedin : '';
            const escapedName = contact.name.replace(/'/g, "\\'");

            detailContent.innerHTML = `
                <!-- Header -->
                <div class="bg-gradient-to-br from-gray-900 to-gray-700 text-white p-6 pt-12 safe-area-inset-top">
                    <button onclick="closeContactDetail()" class="mb-4 flex items-center gap-2 text-white/80 active:text-white">
                        <i class="fas fa-arrow-left"></i>
                        <span class="text-sm">Back</span>
                    </button>
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 rounded-full ${getAvatarClass(contact.name)} flex items-center justify-center text-white text-2xl font-bold flex-shrink-0">
                            ${contact.name.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <h1 class="text-xl font-bold">${contact.name}</h1>
                            ${company ? `<p class="text-white/70 text-sm">${company}</p>` : ''}
                            ${contact.source === 'scan' ? '<span class="text-xs bg-white/20 px-2 py-0.5 rounded-full mt-1 inline-block">Scanned</span>' : ''}
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="flex justify-around py-4 bg-white border-b border-gray-100">
                    ${contact.phone && contact.phone !== 'N/A' ? `
                        <a href="tel:${contact.phone}" class="flex flex-col items-center gap-1 text-blue-600">
                            <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center"><i class="fas fa-phone text-sm"></i></div>
                            <span class="text-xs">Call</span>
                        </a>` : ''}
                    ${contact.email && contact.email !== 'N/A' ? `
                        <a href="mailto:${contact.email}" class="flex flex-col items-center gap-1 text-green-600">
                            <div class="w-10 h-10 rounded-full bg-green-50 flex items-center justify-center"><i class="fas fa-envelope text-sm"></i></div>
                            <span class="text-xs">Email</span>
                        </a>` : ''}
                    ${linkedin ? `
                        <a href="${linkedin.startsWith('http') ? linkedin : 'https://' + linkedin}" target="_blank" class="flex flex-col items-center gap-1 text-blue-700">
                            <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center"><i class="fab fa-linkedin text-sm"></i></div>
                            <span class="text-xs">LinkedIn</span>
                        </a>` : ''}
                    <button onclick="viewContactQR('${contact.id}')" class="flex flex-col items-center gap-1 text-purple-600">
                        <div class="w-10 h-10 rounded-full bg-purple-50 flex items-center justify-center"><i class="fas fa-qrcode text-sm"></i></div>
                        <span class="text-xs">QR Code</span>
                    </button>
                </div>

                <!-- Contact Info -->
                <div class="p-4 space-y-4">
                    <div class="bg-white rounded-xl p-4 shadow-sm space-y-3">
                        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Contact Information</h3>
                        ${contact.email && contact.email !== 'N/A' ? `
                        <div class="flex items-center gap-3">
                            <i class="fas fa-envelope text-gray-400 w-5 text-center"></i>
                            <div>
                                <p class="text-sm text-gray-900">${contact.email}</p>
                                <p class="text-xs text-gray-400">Email</p>
                            </div>
                        </div>` : ''}
                        ${contact.phone && contact.phone !== 'N/A' ? `
                        <div class="flex items-center gap-3">
                            <i class="fas fa-phone text-gray-400 w-5 text-center"></i>
                            <div>
                                <p class="text-sm text-gray-900">${contact.phone}</p>
                                <p class="text-xs text-gray-400">Phone</p>
                            </div>
                        </div>` : ''}
                        ${linkedin ? `
                        <div class="flex items-center gap-3">
                            <i class="fab fa-linkedin text-gray-400 w-5 text-center"></i>
                            <div>
                                <p class="text-sm text-blue-600 truncate">${linkedin}</p>
                                <p class="text-xs text-gray-400">LinkedIn ${contact.linkedin_source === 'ai_detected' ? '<span class="bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded text-[10px] ml-1">AI found</span>' : ''}</p>
                            </div>
                        </div>` : ''}
                        ${company ? `
                        <div class="flex items-center gap-3">
                            <i class="fas fa-building text-gray-400 w-5 text-center"></i>
                            <div>
                                <p class="text-sm text-gray-900">${company}</p>
                                <p class="text-xs text-gray-400">Company</p>
                            </div>
                        </div>` : ''}
                    </div>

                    <!-- Notes -->
                    <div class="bg-white rounded-xl p-4 shadow-sm">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Notes</h3>
                            <button onclick="editContact('${contact.id}')" class="text-xs text-blue-600">Edit</button>
                        </div>
                        ${hasNotes
                            ? `<p class="text-sm text-gray-700 whitespace-pre-wrap">${contact.notes}</p>`
                            : `<p class="text-sm text-gray-400 italic">No notes yet. Tap Edit to add notes about this contact.</p>`
                        }
                    </div>

                    <!-- Links -->
                    ${hasLinks ? `
                    <div class="bg-white rounded-xl p-4 shadow-sm">
                        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">Links & Attachments</h3>
                        <div class="space-y-2">
                            ${contact.links.map(link => `
                                <a href="${link.url}" target="_blank" class="link-chip ${link.added_by === 'n8n' ? 'auto' : ''}">
                                    <i class="fas fa-external-link-alt text-xs"></i>
                                    ${link.label || 'Link'}
                                    ${link.added_by === 'n8n' ? '<span class="text-xs opacity-60">auto</span>' : ''}
                                </a>
                            `).join('')}
                        </div>
                    </div>` : ''}

                    <!-- Intelligence Actions -->
                    <div class="flex gap-2 mb-3">
                        <button onclick="getPitchAngle('${contact.id}', '${escapedName}', '${(company || '').replace(/'/g, "\\'")}')"
                                class="flex-1 py-3 bg-purple-600 text-white rounded-lg font-semibold text-sm active:bg-purple-700">
                            <i class="fas fa-lightbulb mr-1"></i>Pitch Angle
                        </button>
                        <button onclick="getBriefing('${contact.id}', '${escapedName}', '${(company || '').replace(/'/g, "\\'")}')"
                                class="flex-1 py-3 bg-indigo-600 text-white rounded-lg font-semibold text-sm active:bg-indigo-700">
                            <i class="fas fa-file-alt mr-1"></i>Brief Me
                        </button>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-3 pt-2 pb-24">
                        <button onclick="editContact('${contact.id}')" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-semibold active:bg-blue-700 transition">
                            <i class="fas fa-pen mr-2"></i>Edit
                        </button>
                        <button onclick="deleteContact('${contact.id}', '${escapedName}')" class="bg-red-50 text-red-600 px-6 py-3 rounded-xl font-semibold active:bg-red-100 transition">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;

            detailView.classList.remove('hidden');
            detailContent.className = 'h-full overflow-y-auto slide-in-right';
        }

        function closeContactDetail() {
            const detailView = document.getElementById('contactDetailView');
            if (detailView.classList.contains('hidden')) return;

            const detailContent = document.getElementById('contactDetailContent');
            detailContent.className = 'h-full overflow-y-auto slide-out-right';
            setTimeout(() => {
                detailView.classList.add('hidden');
            }, 250);
        }

        function getPitchAngle(contactId, name, company) {
            closeContactDetail();
            switchScreen('chat');
            const query = `Generate a specific pitch angle for ${name} at ${company}. Consider their role, my products/services, and how my value propositions align with their potential needs. Give me 2-3 talking points I can use.`;
            document.getElementById('chatInput').value = query;
            sendChatMessage(new Event('submit'));
        }

        function getBriefing(contactId, name, company) {
            closeContactDetail();
            switchScreen('chat');
            const query = `Quick briefing on ${name} at ${company} before my meeting: Who are they? Why do they matter to me? Suggested talking points? What should I pitch? Keep it concise and actionable.`;
            document.getElementById('chatInput').value = query;
            sendChatMessage(new Event('submit'));
        }

        // ==================== EXPORT FUNCTIONS ====================
        async function exportContacts(format) {
            if (!AppState.currentUser) return;

            try {
                if (format === 'json') {
                    // Client-side JSON export
                    const data = AppState.contacts.map(c => ({
                        name: c.name, email: c.email, phone: c.phone,
                        linkedin: c.linkedin, company_name: c.company_name,
                        notes: c.notes || '', source: c.source || 'manual'
                    }));
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'event_scout_contacts.json';
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast(`Exported ${data.length} contacts as JSON`, 'success');
                } else {
                    // CSV export via backend
                    const url = `${CONFIG.API_BASE_URL}/export_contacts/?user_id=${encodeURIComponent(AppState.currentUser.user_id)}&format=csv`;
                    const response = await fetch(url, {
                        headers: { 'X-API-Key': CONFIG.API_KEY }
                    });

                    if (!response.ok) throw new Error('Export failed');

                    const blob = await response.blob();
                    const downloadUrl = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = 'event_scout_contacts.csv';
                    a.click();
                    URL.revokeObjectURL(downloadUrl);
                    showToast(`Exported ${AppState.contacts.length} contacts as CSV`, 'success');
                }
            } catch (error) {
                console.error('Export error:', error);
                showToast('Export failed. Please try again.', 'error');
            }
        }

        // ==================== DIGITAL BUSINESS CARD FUNCTIONS ====================
        async function loadDigitalCard() {
            if (!AppState.currentUser) return;

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/user/card/?user_id=${encodeURIComponent(AppState.currentUser.user_id)}`, {
                    headers: { 'X-API-Key': CONFIG.API_KEY }
                });

                if (!response.ok) throw new Error('Failed to load card');

                const data = await response.json();
                const card = data.card || {};

                // Populate form fields
                document.getElementById('cardFullName').value = card.full_name || '';
                document.getElementById('cardJobTitle').value = card.job_title || '';
                document.getElementById('cardCompanyName').value = card.company_name || '';
                document.getElementById('cardEmail').value = card.email || '';
                document.getElementById('cardPhone').value = card.phone || '';
                document.getElementById('cardLinkedIn').value = card.linkedin_url || '';
                document.getElementById('cardZoom').value = card.zoom_number || '';
                document.getElementById('cardWebsite').value = card.website || '';

                // Show QR if exists
                if (data.shareable_url) {
                    document.getElementById('cardShareableURL').textContent = data.shareable_url;
                }
            } catch (error) {
                console.error('Load card error:', error);
            }
        }

        async function saveDigitalCard() {
            if (!AppState.currentUser) return;

            // Convert empty strings to null for optional fields
            const cardData = {
                full_name: document.getElementById('cardFullName').value.trim(),
                email: document.getElementById('cardEmail').value.trim(),
                job_title: document.getElementById('cardJobTitle').value.trim() || null,
                company_name: document.getElementById('cardCompanyName').value.trim() || null,
                phone: document.getElementById('cardPhone').value.trim() || null,
                linkedin_url: document.getElementById('cardLinkedIn').value.trim() || null,
                zoom_number: document.getElementById('cardZoom').value.trim() || null,
                website: document.getElementById('cardWebsite').value.trim() || null,
            };

            // Validation - mandatory fields
            if (!cardData.full_name || !cardData.email) {
                showToast('Please enter at least your name and email', 'error');
                return;
            }

            // Email format validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(cardData.email)) {
                showToast('Please enter a valid email address', 'error');
                return;
            }

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/user/card/?user_id=${encodeURIComponent(AppState.currentUser.user_id)}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': CONFIG.API_KEY
                    },
                    body: JSON.stringify(cardData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Save card error details:', errorData);
                    showToast(errorData.detail || 'Failed to save card. Please try again.', 'error');
                    return;
                }

                const data = await response.json();
                showToast('Digital card saved successfully!', 'success');

                if (data.shareable_url) {
                    document.getElementById('cardShareableURL').textContent = data.shareable_url;
                }
            } catch (error) {
                console.error('Save card error:', error);
                showToast('Failed to save card. Please try again.', 'error');
            }
        }

        async function generateCardQR() {
            if (!AppState.currentUser) return;

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/user/card/generate_token/?user_id=${encodeURIComponent(AppState.currentUser.user_id)}`, {
                    method: 'POST',
                    headers: { 'X-API-Key': CONFIG.API_KEY }
                });

                if (!response.ok) throw new Error('Failed to generate QR');

                const data = await response.json();

                // Display QR code
                const qrContainer = document.getElementById('cardQRContainer');
                const qrImage = document.getElementById('cardQRImage');
                const urlDisplay = document.getElementById('cardShareableURL');

                qrImage.src = `data:image/png;base64,${data.qr_code_base64}`;
                urlDisplay.textContent = data.shareable_url;
                qrContainer.classList.remove('hidden');

                showToast('QR code generated! Share it with people you meet.', 'success');
            } catch (error) {
                console.error('Generate QR error:', error);
                showToast('Failed to generate QR code. Please try again.', 'error');
            }
        }

        async function triggerCardAcceptedWebhook(contactId, contactName) {
            /**
             * Triggered when user accepts/scans a card.
             * Sends webhook to n8n to trigger automated CookieMail.
             */
            if (!AppState.currentUser || !contactId) return;

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/contact/${contactId}/accepted?user_id=${encodeURIComponent(AppState.currentUser.user_id)}`, {
                    method: 'POST',
                    headers: { 'X-API-Key': CONFIG.API_KEY }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.webhook_sent) {
                        console.log(`[WEBHOOK] CookieMail triggered for ${contactName}`);
                    } else {
                        console.warn(`[WEBHOOK] ${data.webhook_message}`);
                    }
                }
            } catch (error) {
                // Silent failure - don't interrupt user flow
                console.error('[WEBHOOK] Error triggering card acceptance:', error);
            }
        }

        // ==================== UTILITY FUNCTIONS ====================
        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            const bgColor = type === 'success' ? 'bg-green-50 text-green-800 border-green-200' : 'bg-red-50 text-red-800 border-red-200';
            container.innerHTML = `<div class="border rounded-lg p-3 text-sm ${bgColor}">${message}</div>`;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            toast.className = `fixed top-20 left-4 right-4 px-6 py-4 rounded-lg shadow-lg transform transition-all duration-300 z-50 ${bgColor} text-white`;

            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                    <p class="flex-1">${message}</p>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-white/80">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            document.body.appendChild(toast);

            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        // ==================== USER PROFILE FUNCTIONS ====================
        async function loadUserProfile() {
            try {
                const response = await fetch(
                    `${CONFIG.API_BASE_URL}/user/profile/?user_id=${AppState.currentUser.user_id}`,
                    { headers: { 'X-API-Key': CONFIG.API_KEY } }
                );
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    AppState.userProfile = data.profile || {};
                    // Set AI model selector
                    const aiModelSelect = document.getElementById('aiModelSelect');
                    if (aiModelSelect && AppState.userProfile.preferred_ai_model) {
                        aiModelSelect.value = AppState.userProfile.preferred_ai_model;
                    }
                    updateChatModelLabel();
                }
            } catch (error) {
                console.error('Load profile error:', error);
            }
        }

        async function saveAIModel() {
            const model = document.getElementById('aiModelSelect').value;
            try {
                await fetch(`${CONFIG.API_BASE_URL}/user/profile/?user_id=${AppState.currentUser.user_id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': CONFIG.API_KEY
                    },
                    body: JSON.stringify({ preferred_ai_model: model })
                });
                AppState.userProfile.preferred_ai_model = model;
                updateChatModelLabel();
                showToast('AI model updated', 'success');
            } catch (error) {
                showToast('Failed to save model preference', 'error');
            }
        }

        function updateChatModelLabel() {
            const modelNames = {
                'claude-opus': 'Claude Opus 4.6',
                'gpt-5': 'GPT-5.2',
                'gemini-pro': 'Gemini 2.5 Pro'
            };
            const model = (AppState.userProfile || {}).preferred_ai_model || 'claude-opus';
            const label = modelNames[model] || 'Claude Opus 4.6';
            document.getElementById('chatModelLabel').textContent = `Powered by ${label}`;
        }

        async function saveUserProfile(updates) {
            try {
                const response = await fetch(
                    `${CONFIG.API_BASE_URL}/user/profile/?user_id=${AppState.currentUser.user_id}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': CONFIG.API_KEY
                        },
                        body: JSON.stringify(updates)
                    }
                );
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    AppState.userProfile = data.profile;
                    showToast('Settings saved', 'success');
                    return true;
                } else {
                    showToast('Failed to save settings', 'error');
                    return false;
                }
            } catch (error) {
                showToast('Network error', 'error');
                console.error('Save profile error:', error);
                return false;
            }
        }

        // ==================== SETTINGS SHEET FUNCTIONS ====================
        function openSettingsSheet(section) {
            const sheet = document.getElementById('settingsSheet');
            const title = document.getElementById('settingsSheetTitle');
            const body = document.getElementById('settingsSheetBody');
            const p = AppState.userProfile;

            if (section === 'products') {
                title.textContent = 'Products & Services';
                const products = p.products || [{ name: '', description: '', ideal_customer: '' }];
                body.innerHTML = `
                    <p class="text-sm text-gray-500 mb-4">What do you sell? This helps AI suggest relevant pitch angles.</p>
                    <div id="productsContainer">
                        ${products.map((prod, i) => `
                        <div class="product-entry bg-gray-50 rounded-xl p-4 mb-3 space-y-3">
                            <input type="text" placeholder="Product/Service name" value="${escapeHtml(prod.name || '')}"
                                class="product-name w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none">
                            <textarea placeholder="Brief description" rows="2"
                                class="product-desc w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none resize-none">${escapeHtml(prod.description || '')}</textarea>
                            <input type="text" placeholder="Ideal customer (e.g., VP Marketing at mid-market SaaS)" value="${escapeHtml(prod.ideal_customer || '')}"
                                class="product-customer w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none">
                        </div>`).join('')}
                    </div>
                    <button onclick="addProductEntry()" class="text-sm text-purple-600 font-medium mb-4"><i class="fas fa-plus mr-1"></i>Add another product</button>
                    <div class="space-y-3 mt-2">
                        <label class="block text-sm font-medium text-gray-700">Your Company</label>
                        <input type="text" id="settCompanyName" value="${escapeHtml(p.company_name || '')}" placeholder="Company name"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none">
                        <input type="text" id="settJobTitle" value="${escapeHtml(p.job_title || '')}" placeholder="Your job title"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none">
                    </div>
                    <button onclick="saveProductsSettings()" class="w-full mt-6 bg-purple-600 text-white py-3 rounded-lg font-semibold active:bg-purple-700">Save</button>
                `;
            } else if (section === 'targeting') {
                title.textContent = 'Target Market';
                body.innerHTML = `
                    <p class="text-sm text-gray-500 mb-4">Who are you trying to reach? This helps AI score leads.</p>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Target Industries</label>
                            <textarea id="settIndustries" rows="3" placeholder="One per line: Healthcare, FinTech, Manufacturing..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none resize-none">${(p.target_industries || []).join('\n')}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Target Roles</label>
                            <textarea id="settRoles" rows="3" placeholder="One per line: CTO, VP Marketing, Head of Data..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none resize-none">${(p.target_roles || []).join('\n')}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Target Company Sizes</label>
                            <textarea id="settSizes" rows="2" placeholder="One per line: startup, mid-market, enterprise..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none resize-none">${(p.target_company_sizes || []).join('\n')}</textarea>
                        </div>
                    </div>
                    <button onclick="saveTargetingSettings()" class="w-full mt-6 bg-blue-600 text-white py-3 rounded-lg font-semibold active:bg-blue-700">Save</button>
                `;
            } else if (section === 'pitch') {
                title.textContent = 'Pitch & Value Props';
                body.innerHTML = `
                    <p class="text-sm text-gray-500 mb-4">How do you sell? This shapes AI-generated pitch angles.</p>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Pitch Style</label>
                            <select id="settPitchStyle" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 outline-none">
                                <option value="consultative" ${p.pitch_style === 'consultative' ? 'selected' : ''}>Consultative (discover needs first)</option>
                                <option value="direct" ${p.pitch_style === 'direct' ? 'selected' : ''}>Direct (lead with solution)</option>
                                <option value="challenger" ${p.pitch_style === 'challenger' ? 'selected' : ''}>Challenger (reframe their thinking)</option>
                                <option value="relationship" ${p.pitch_style === 'relationship' ? 'selected' : ''}>Relationship (build trust first)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Value Propositions</label>
                            <textarea id="settValueProps" rows="4" placeholder="One per line: your key selling points in your own words..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 outline-none resize-none">${(p.value_propositions || []).join('\n')}</textarea>
                        </div>
                    </div>
                    <button onclick="savePitchSettings()" class="w-full mt-6 bg-green-600 text-white py-3 rounded-lg font-semibold active:bg-green-700">Save</button>
                `;
            } else if (section === 'event') {
                title.textContent = 'Current Event';
                body.innerHTML = `
                    <p class="text-sm text-gray-500 mb-4">Tell AI about the event you're attending.</p>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Event Name</label>
                            <input type="text" id="settEventName" value="${escapeHtml(p.current_event_name || '')}" placeholder="e.g., CES 2026, GITEX Dubai"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Event Description</label>
                            <textarea id="settEventDesc" rows="3" placeholder="What is this event about? Who attends?"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 outline-none resize-none">${escapeHtml(p.current_event_description || '')}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Your Goals</label>
                            <textarea id="settEventGoals" rows="3" placeholder="One per line: Find healthcare partners, Meet CTOs..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 outline-none resize-none">${(p.event_goals || []).join('\n')}</textarea>
                        </div>
                    </div>
                    <button onclick="saveEventSettings()" class="w-full mt-6 bg-orange-500 text-white py-3 rounded-lg font-semibold active:bg-orange-600">Save</button>
                `;
            }

            sheet.classList.remove('hidden');
            setTimeout(() => {
                sheet.querySelector('.sheet-content').style.transform = 'translateY(0)';
            }, 10);
        }

        function closeSettingsSheet() {
            const sheet = document.getElementById('settingsSheet');
            const content = sheet.querySelector('.sheet-content');
            content.style.transform = 'translateY(100%)';
            setTimeout(() => sheet.classList.add('hidden'), 300);
        }

        function addProductEntry() {
            const container = document.getElementById('productsContainer');
            const entry = document.createElement('div');
            entry.className = 'product-entry bg-gray-50 rounded-xl p-4 mb-3 space-y-3';
            entry.innerHTML = `
                <input type="text" placeholder="Product/Service name" class="product-name w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none">
                <textarea placeholder="Brief description" rows="2" class="product-desc w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none resize-none"></textarea>
                <input type="text" placeholder="Ideal customer" class="product-customer w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none">
            `;
            container.appendChild(entry);
        }

        async function saveProductsSettings() {
            const entries = document.querySelectorAll('.product-entry');
            const products = [];
            entries.forEach(entry => {
                const name = entry.querySelector('.product-name').value.trim();
                if (name) {
                    products.push({
                        name: name,
                        description: entry.querySelector('.product-desc').value.trim(),
                        ideal_customer: entry.querySelector('.product-customer').value.trim()
                    });
                }
            });
            const saved = await saveUserProfile({
                products: products,
                company_name: document.getElementById('settCompanyName').value.trim() || undefined,
                job_title: document.getElementById('settJobTitle').value.trim() || undefined
            });
            if (saved) closeSettingsSheet();
        }

        async function saveTargetingSettings() {
            const toList = (id) => document.getElementById(id).value.split('\n').map(s => s.trim()).filter(Boolean);
            const saved = await saveUserProfile({
                target_industries: toList('settIndustries'),
                target_roles: toList('settRoles'),
                target_company_sizes: toList('settSizes')
            });
            if (saved) closeSettingsSheet();
        }

        async function savePitchSettings() {
            const saved = await saveUserProfile({
                pitch_style: document.getElementById('settPitchStyle').value,
                value_propositions: document.getElementById('settValueProps').value.split('\n').map(s => s.trim()).filter(Boolean)
            });
            if (saved) closeSettingsSheet();
        }

        async function saveEventSettings() {
            const saved = await saveUserProfile({
                current_event_name: document.getElementById('settEventName').value.trim(),
                current_event_description: document.getElementById('settEventDesc').value.trim(),
                event_goals: document.getElementById('settEventGoals').value.split('\n').map(s => s.trim()).filter(Boolean)
            });
            if (saved) closeSettingsSheet();
        }

        // ==================== EXPO / EXHIBITOR FUNCTIONS ====================
        let exhibitorCache = [];
        let exhibitorCategories = [];

        async function loadExhibitors() {
            // Check if user has set their current event
            const eventName = AppState.userProfile?.current_event_name || '';
            const eventDesc = AppState.userProfile?.current_event_description || '';

            // Update header with event name and description
            if (eventName) {
                document.getElementById('expoEventName').textContent = eventName;
                document.getElementById('expoEventDetails').textContent = eventDesc || 'Loading exhibitors...';
            } else {
                document.getElementById('expoEventName').textContent = 'Select Event in Profile';
                document.getElementById('expoEventDetails').textContent = 'Set your current event to see exhibitors';
                document.getElementById('exhibitorList').innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-calendar-alt text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-600 font-medium mb-2">No Event Selected</p>
                        <p class="text-sm text-gray-500 mb-4">Please set your current event in Profile settings first</p>
                        <button onclick="switchScreen('profile'); setTimeout(() => openSettingsSheet('event'), 300);"
                                class="px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm font-medium">
                            Set Event Now
                        </button>
                    </div>`;
                return;
            }

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/exhibitors/?event=${encodeURIComponent(eventName)}&limit=200`, {
                    headers: { 'X-API-Key': CONFIG.API_KEY }
                });
                const data = await response.json();
                if (data.status === 'success') {
                    exhibitorCache = data.exhibitors || [];
                    renderExhibitors(exhibitorCache);
                    loadExhibitorCategories();
                } else if (data.status === 'error') {
                    document.getElementById('exhibitorList').innerHTML = `<p class="text-center text-gray-500 py-8">${data.detail || 'Failed to load exhibitors'}</p>`;
                }
            } catch (error) {
                console.error('Failed to load exhibitors:', error);
                document.getElementById('exhibitorList').innerHTML = '<p class="text-center text-gray-500 py-8">No exhibitor data available for this event.</p>';
            }
        }

        async function loadExhibitorCategories() {
            const eventName = AppState.userProfile?.current_event_name || '';
            if (!eventName) return; // No event set, no categories to load

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/exhibitors/categories/?event=${encodeURIComponent(eventName)}`, {
                    headers: { 'X-API-Key': CONFIG.API_KEY }
                });
                const data = await response.json();
                if (data.status === 'success') {
                    exhibitorCategories = data.categories || [];
                    renderCategoryFilters();
                }
            } catch (error) {
                console.error('Failed to load categories:', error);
            }
        }

        function renderCategoryFilters() {
            const container = document.getElementById('categoryFilter');
            let html = '<button onclick="filterByCategory(\'\')" class="category-btn active px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full whitespace-nowrap text-xs font-medium">All</button>';
            exhibitorCategories.forEach(cat => {
                html += `<button onclick="filterByCategory('${cat.replace(/'/g, "\\'")}')" class="category-btn px-3 py-1 bg-gray-100 text-gray-600 rounded-full whitespace-nowrap text-xs font-medium">${cat}</button>`;
            });
            container.innerHTML = html;
        }

        function filterByCategory(category) {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('bg-emerald-100', 'text-emerald-700', 'active');
                btn.classList.add('bg-gray-100', 'text-gray-600');
            });
            event.target.classList.add('bg-emerald-100', 'text-emerald-700', 'active');
            event.target.classList.remove('bg-gray-100', 'text-gray-600');

            const filtered = category ? exhibitorCache.filter(e => e.category.includes(category)) : exhibitorCache;
            renderExhibitors(filtered);
        }

        function filterExhibitors() {
            const search = document.getElementById('expoSearchInput').value.toLowerCase();
            const filtered = exhibitorCache.filter(e =>
                e.name.toLowerCase().includes(search) ||
                (e.category || '').toLowerCase().includes(search) ||
                (e.country || '').toLowerCase().includes(search)
            );
            renderExhibitors(filtered);
        }

        function renderExhibitors(exhibitors) {
            const container = document.getElementById('exhibitorList');
            if (!exhibitors || exhibitors.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">No exhibitors found. Check back after data is imported.</p>';
                return;
            }

            let html = `<p class="text-sm text-gray-500 mb-2">${exhibitors.length} exhibitors</p>`;
            exhibitors.forEach(ex => {
                // Verification badge
                let verificationBadge = '';
                if (ex.verification === 'verified') {
                    verificationBadge = '<span class="text-xs px-2 py-0.5 bg-green-100 text-green-700 rounded-full font-medium"><i class="fas fa-check-circle mr-1"></i>Verified Booth</span>';
                } else if (ex.verification === 'confirmed') {
                    verificationBadge = '<span class="text-xs px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full font-medium"><i class="fas fa-info-circle mr-1"></i>Confirmed</span>';
                } else {
                    verificationBadge = '<span class="text-xs px-2 py-0.5 bg-gray-100 text-gray-600 rounded-full font-medium"><i class="fas fa-tilde mr-1"></i>Estimated</span>';
                }

                html += `
                <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100" onclick="showExhibitorDetail('${ex.name.replace(/'/g, "\\'")}')">
                    <div class="flex items-start justify-between">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <h4 class="font-semibold text-gray-900 truncate">${ex.name}</h4>
                                ${verificationBadge}
                            </div>
                            ${ex.category ? `<p class="text-xs text-emerald-600 mt-0.5">${ex.category}</p>` : ''}
                            <div class="flex items-center gap-3 mt-1 text-xs text-gray-500">
                                ${ex.booth ? `<span><i class="fas fa-map-pin mr-1"></i>${ex.booth}${ex.hall ? `, ${ex.hall}` : ''}</span>` : ''}
                                ${ex.country ? `<span><i class="fas fa-globe mr-1"></i>${ex.country}</span>` : ''}
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); askAIAboutExhibitor('${ex.name.replace(/'/g, "\\'")}')"
                                class="ml-2 px-3 py-1.5 bg-purple-50 text-purple-600 rounded-lg text-xs font-medium active:bg-purple-100">
                            <i class="fas fa-robot mr-1"></i>Ask AI
                        </button>
                    </div>
                    ${ex.description ? `<p class="text-xs text-gray-500 mt-2 line-clamp-2">${ex.description}</p>` : ''}
                </div>`;
            });
            container.innerHTML = html;
        }

        function showExhibitorDetail(name) {
            const ex = exhibitorCache.find(e => e.name === name);
            if (!ex) return;

            // Use the AI chat to get info
            switchScreen('chat');
            const query = `Tell me about the exhibitor "${ex.name}"${ex.booth ? ` at booth ${ex.booth}` : ''}. What do they do and why might they be relevant to my goals?`;
            document.getElementById('chatInput').value = query;
            document.getElementById('chatInput').focus();
        }

        function askAIAboutExhibitor(name) {
            switchScreen('chat');
            const query = `Should I visit "${name}" at the expo? What's their relevance to my business and what should I pitch?`;
            document.getElementById('chatInput').value = query;
            document.getElementById('chatInput').focus();
        }

        // ==================== LEAD SCORING FUNCTIONS ====================
        async function scoreContact(contactId) {
            showToast('Scoring contact...', 'info');
            try {
                const response = await fetch(
                    `${CONFIG.API_BASE_URL}/contact/${contactId}/score?user_id=${AppState.currentUser.user_id}`,
                    {
                        method: 'POST',
                        headers: { 'X-API-Key': CONFIG.API_KEY }
                    }
                );
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    showToast(`Score: ${data.score}/100 (${data.temperature})`, 'success');
                    // Update local state
                    const contact = AppState.contacts.find(c => c.id === contactId);
                    if (contact) {
                        contact.lead_score = data.score;
                        contact.lead_temperature = data.temperature;
                        contact.lead_score_reasoning = data.reasoning;
                    }
                    renderContacts(AppState.contacts);
                    return data;
                } else {
                    showToast('Scoring failed', 'error');
                    return null;
                }
            } catch (error) {
                showToast('Network error', 'error');
                console.error('Score error:', error);
                return null;
            }
        }

        async function scoreAllContacts() {
            const btn = document.getElementById('scoreAllBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Scoring...';
            btn.disabled = true;

            try {
                const response = await fetch(
                    `${CONFIG.API_BASE_URL}/contacts/score_all?user_id=${AppState.currentUser.user_id}`,
                    {
                        method: 'POST',
                        headers: { 'X-API-Key': CONFIG.API_KEY }
                    }
                );
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    showToast(`Scored ${data.scored} contacts (${data.skipped} already scored)`, 'success');
                    loadContacts();
                    loadDashboardStats();
                } else {
                    showToast('Scoring failed', 'error');
                }
            } catch (error) {
                showToast('Network error', 'error');
                console.error('Score all error:', error);
            }

            btn.innerHTML = '<i class="fas fa-bolt mr-2"></i>Score All Contacts';
            btn.disabled = false;
        }

        async function loadDashboardStats() {
            try {
                const response = await fetch(
                    `${CONFIG.API_BASE_URL}/dashboard?user_id=${AppState.currentUser.user_id}`,
                    { headers: { 'X-API-Key': CONFIG.API_KEY } }
                );
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    document.getElementById('statHot').textContent = data.by_temperature.hot || 0;
                    document.getElementById('statWarm').textContent = data.by_temperature.warm || 0;
                    document.getElementById('statCold').textContent = data.by_temperature.cold || 0;
                }
            } catch (error) {
                console.error('Dashboard stats error:', error);
            }
        }

        // ==================== ENHANCED CONTACT DETAIL ====================
        // Override openContactDetail to include lead score section
        const _originalOpenContactDetail = openContactDetail;
        openContactDetail = function(contactId) {
            const contact = AppState.contacts.find(c => c.id === contactId);
            if (!contact) return;

            // Call original to set up the base view
            _originalOpenContactDetail(contactId);

            // Now inject lead score section if score exists
            const detailContent = document.getElementById('contactDetailContent');
            const actionsSection = detailContent.querySelector('.flex.gap-3.pt-2.pb-24');
            if (!actionsSection) return;

            const score = contact.lead_score;
            const temp = contact.lead_temperature;
            const reasoning = contact.lead_score_reasoning || '';
            const scoreColor = temp === 'hot' ? 'border-red-500 text-red-600' : temp === 'warm' ? 'border-orange-400 text-orange-500' : temp === 'cold' ? 'border-gray-400 text-gray-500' : 'border-gray-300 text-gray-400';
            const scoreBg = temp === 'hot' ? 'bg-red-50' : temp === 'warm' ? 'bg-orange-50' : temp === 'cold' ? 'bg-gray-50' : 'bg-gray-50';
            const tempLabel = temp ? temp.charAt(0).toUpperCase() + temp.slice(1) + ' Lead' : 'Not Scored';

            const scoreSection = document.createElement('div');
            scoreSection.className = 'bg-white rounded-xl p-4 shadow-sm';
            scoreSection.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Lead Score</h3>
                    <button onclick="scoreContactAndRefresh('${contactId}')" class="text-xs text-blue-600 font-medium">
                        <i class="fas fa-sync-alt mr-1"></i>${score != null ? 'Rescore' : 'Score Now'}
                    </button>
                </div>
                ${score != null ? `
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 rounded-full border-4 ${scoreColor} flex items-center justify-center ${scoreBg}">
                        <span class="text-2xl font-bold">${score}</span>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-semibold ${scoreColor}">${tempLabel}</p>
                        <p class="text-xs text-gray-500 mt-1">${escapeHtml(reasoning)}</p>
                    </div>
                </div>
                ` : `
                <div class="text-center py-4">
                    <p class="text-sm text-gray-400 italic">Not scored yet. Tap "Score Now" to analyze this lead.</p>
                </div>
                `}
            `;

            actionsSection.parentElement.insertBefore(scoreSection, actionsSection);
        };

        async function scoreContactAndRefresh(contactId) {
            const result = await scoreContact(contactId);
            if (result) { openContactDetail(contactId); }
        }

        // ==================== ADMIN DASHBOARD ====================
        async function loadAdminDashboard() {
            try {
                const resp = await fetch(`${CONFIG.API_BASE_URL}/admin/dashboard?user_id=${AppState.currentUser.user_id}`, { headers: { 'X-API-Key': CONFIG.API_KEY } });
                const data = await resp.json();
                if (!resp.ok || data.status !== 'success') { showToast(data.detail || 'Admin access denied', 'error'); return; }
                document.getElementById('adminStatUsers').textContent = data.total_users;
                document.getElementById('adminStatContacts').textContent = data.total_contacts;
                document.getElementById('adminStatHot').textContent = data.by_temperature.hot;
                document.getElementById('adminStatWarm').textContent = data.by_temperature.warm;
                document.getElementById('adminTeamList').innerHTML = data.per_user.map(u => '<div class="flex items-center justify-between py-2 border-b border-gray-50 last:border-0"><div class="flex items-center gap-3"><div class="w-9 h-9 rounded-full bg-gradient-to-br from-purple-400 to-blue-400 flex items-center justify-center text-white font-bold text-sm">' + u.name.charAt(0).toUpperCase() + '</div><div><p class="text-sm font-medium text-gray-900">' + escapeHtml(u.name) + (u.is_admin ? ' <span class="text-[10px] bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded ml-1">Admin</span>' : '') + '</p><p class="text-xs text-gray-400">' + escapeHtml(u.email) + '</p></div></div><span class="text-sm font-semibold text-gray-600">' + u.contact_count + ' <span class="text-xs text-gray-400">contacts</span></span></div>').join('');
                const rl = document.getElementById('adminRecentContacts');
                if (data.recent_contacts.length === 0) { rl.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">No contacts yet</p>'; }
                else { rl.innerHTML = data.recent_contacts.map(c => { const sc = c.lead_temperature === 'hot' ? 'text-red-600' : c.lead_temperature === 'warm' ? 'text-orange-500' : 'text-gray-400'; return '<div class="flex items-center justify-between py-2 border-b border-gray-50 last:border-0"><div><p class="text-sm font-medium text-gray-900">' + escapeHtml(c.name) + '</p><p class="text-xs text-gray-400">' + escapeHtml(c.company_name) + ' &middot; by ' + escapeHtml(c.user_name) + '</p></div><div class="text-right">' + (c.lead_score != null ? '<span class="text-sm font-bold ' + sc + '">' + c.lead_score + '</span>' : '<span class="text-xs text-gray-300">--</span>') + '<p class="text-[10px] text-gray-400">' + c.source + '</p></div></div>'; }).join(''); }
            } catch (err) { console.error('Admin dashboard error:', err); showToast('Failed to load admin data', 'error'); }
        }

        // ==================== VOICE RECORDING (Swipe Right) ====================
        let voiceRecognition = null, voiceMediaRecorder = null, voiceAudioChunks = [], voiceTimerInterval = null, voiceSeconds = 0, voiceIsRecording = false;

        function initSwipeHandlers() {
            const cl = document.getElementById('contactsList');
            let sx = 0, sy = 0, sc = null;
            cl.addEventListener('touchstart', e => { const c = e.target.closest('.contact-card'); if (!c) return; sx = e.touches[0].clientX; sy = e.touches[0].clientY; sc = c; }, { passive: true });
            cl.addEventListener('touchmove', e => { if (!sc) return; const dx = e.touches[0].clientX - sx, dy = Math.abs(e.touches[0].clientY - sy); if (dy > 30) { sc.style.transform = ''; sc.style.background = ''; sc = null; return; } if (dx > 20 && dx < 120) { sc.style.transform = 'translateX(' + Math.min(dx * 0.3, 30) + 'px)'; sc.style.background = 'linear-gradient(90deg, rgba(124,58,237,' + (dx/300) + ') 0%, transparent 40%)'; } }, { passive: true });
            cl.addEventListener('touchend', e => { if (!sc) return; const dx = e.changedTouches[0].clientX - sx, dy = Math.abs(e.changedTouches[0].clientY - sy); sc.style.transform = ''; sc.style.background = ''; if (dx > 80 && dy < 40) { _swipeVoiceTriggered = Date.now(); const cid = sc.dataset.id; const ct = AppState.contacts.find(c => c.id === cid); if (ct) openVoiceRecordingOverlay(cid, ct.name); } sc = null; }, { passive: true });
        }

        const _origRender = renderContacts;
        renderContacts = function(contacts) { _origRender(contacts); setTimeout(initSwipeHandlers, 100); };

        function openVoiceRecordingOverlay(contactId, contactName) {
            AppState._voiceContactId = contactId; AppState._voiceTranscript = ''; AppState._voiceAudioBlob = null;
            document.getElementById('voiceContactName').textContent = 'Voice note for ' + contactName;
            document.getElementById('voiceTimer').textContent = '0:00';
            document.getElementById('voiceStatus').textContent = 'Starting...';
            document.getElementById('voiceTranscript').classList.add('hidden');
            document.getElementById('voiceSaveBtn').classList.add('hidden');
            var btn = document.getElementById('voiceRecordBtn'); btn.innerHTML = '<i class="fas fa-microphone"></i>'; btn.classList.remove('bg-gray-500'); btn.classList.add('bg-red-500', 'recording-pulse');
            document.getElementById('voiceRecordingOverlay').classList.remove('hidden');
            setTimeout(function() { toggleVoiceRecording(); }, 300);
        }

        function toggleVoiceRecording() { voiceIsRecording ? stopVoiceRecording() : startVoiceRecording(); }

        async function startVoiceRecording() {
            voiceIsRecording = true; voiceSeconds = 0; voiceAudioChunks = []; AppState._voiceTranscript = '';
            var btn = document.getElementById('voiceRecordBtn'); btn.innerHTML = '<i class="fas fa-stop"></i>'; btn.classList.remove('bg-red-500'); btn.classList.add('bg-gray-500');
            document.getElementById('voiceStatus').textContent = 'Recording...';
            document.getElementById('voiceTranscript').classList.remove('hidden');
            document.getElementById('voiceTranscript').innerHTML = '<span class="text-gray-400 italic">Listening...</span>';
            voiceTimerInterval = setInterval(function() { voiceSeconds++; var m = Math.floor(voiceSeconds/60), s = voiceSeconds%60; document.getElementById('voiceTimer').textContent = m + ':' + s.toString().padStart(2,'0'); if (voiceSeconds >= 60) stopVoiceRecording(); }, 1000);
            try { var stream = await navigator.mediaDevices.getUserMedia({audio:true}); voiceMediaRecorder = new MediaRecorder(stream, {mimeType:'audio/webm;codecs=opus'}); voiceMediaRecorder.ondataavailable = function(e) { if (e.data.size > 0) voiceAudioChunks.push(e.data); }; voiceMediaRecorder.onstop = function() { stream.getTracks().forEach(function(t){t.stop();}); if (voiceAudioChunks.length > 0) AppState._voiceAudioBlob = new Blob(voiceAudioChunks, {type:'audio/webm'}); }; voiceMediaRecorder.start(1000); } catch(err) { console.warn('[Voice] MediaRecorder unavailable:', err); }
            var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SR) { voiceRecognition = new SR(); voiceRecognition.continuous = true; voiceRecognition.interimResults = true; voiceRecognition.lang = 'en-US'; var finalT = ''; voiceRecognition.onresult = function(evt) { var interim = ''; for (var i = evt.resultIndex; i < evt.results.length; i++) { if (evt.results[i].isFinal) finalT += evt.results[i][0].transcript + ' '; else interim += evt.results[i][0].transcript; } AppState._voiceTranscript = finalT.trim(); document.getElementById('voiceTranscript').innerHTML = finalT + '<span class="text-gray-400">' + interim + '</span>'; }; voiceRecognition.onerror = function(e) { console.warn('[Voice] Recognition error:', e.error); }; voiceRecognition.onend = function() { if (voiceIsRecording) try { voiceRecognition.start(); } catch(e) {} }; voiceRecognition.start(); }
            else { document.getElementById('voiceTranscript').innerHTML = '<span class="text-gray-400 italic">Live transcription unavailable. Audio sent for AI transcription on save.</span>'; }
        }

        function stopVoiceRecording() {
            voiceIsRecording = false; clearInterval(voiceTimerInterval);
            if (voiceRecognition) { voiceRecognition.onend = null; try { voiceRecognition.stop(); } catch(e) {} voiceRecognition = null; }
            if (voiceMediaRecorder && voiceMediaRecorder.state !== 'inactive') voiceMediaRecorder.stop();
            var btn = document.getElementById('voiceRecordBtn'); btn.innerHTML = '<i class="fas fa-microphone"></i>'; btn.classList.remove('bg-gray-500'); btn.classList.add('bg-red-500');
            document.getElementById('voiceStatus').textContent = 'Recording complete';
            document.getElementById('voiceSaveBtn').classList.remove('hidden');
            if (!AppState._voiceTranscript) document.getElementById('voiceTranscript').innerHTML = '<span class="text-gray-400 italic">No live transcript. Audio will be transcribed by AI on save.</span>';
        }

        function cancelVoiceRecording() { stopVoiceRecording(); AppState._voiceContactId = null; AppState._voiceTranscript = ''; AppState._voiceAudioBlob = null; document.getElementById('voiceRecordingOverlay').classList.add('hidden'); }

        async function saveVoiceNote() {
            var contactId = AppState._voiceContactId, transcript = AppState._voiceTranscript, audioBlob = AppState._voiceAudioBlob;
            if (!contactId) return;
            document.getElementById('voiceStatus').textContent = 'Saving...'; document.getElementById('voiceSaveBtn').disabled = true;
            if (!transcript && audioBlob) { try { var fd = new FormData(); fd.append('file', audioBlob, 'voice_note.webm'); var r = await fetch(CONFIG.API_BASE_URL + '/transcribe_audio/?user_id=' + AppState.currentUser.user_id, {method:'POST', headers:{'X-API-Key':CONFIG.API_KEY}, body:fd}); var d = await r.json(); if (r.ok && d.transcript) transcript = d.transcript; } catch(err) { console.error('[Voice] Gemini transcription failed:', err); } }
            var audioBase64 = '';
            if (audioBlob) { try { var buf = await audioBlob.arrayBuffer(); var bytes = new Uint8Array(buf); var bin = ''; bytes.forEach(function(b){ bin += String.fromCharCode(b); }); audioBase64 = btoa(bin); } catch(err) { console.warn('[Voice] Audio encode failed:', err); } }
            try { var response = await fetch(CONFIG.API_BASE_URL + '/contact/' + contactId + '/audio_note?user_id=' + AppState.currentUser.user_id, { method:'POST', headers:{'Content-Type':'application/json','X-API-Key':CONFIG.API_KEY}, body:JSON.stringify({contact_id:contactId, transcript:transcript||'(no transcription)', audio_base64:audioBase64}) }); if (response.ok) { showToast('Voice note saved!', 'success'); loadContacts(); } else showToast('Failed to save voice note', 'error'); } catch(err) { showToast('Network error saving voice note', 'error'); }
            AppState._voiceContactId = null; AppState._voiceTranscript = ''; AppState._voiceAudioBlob = null;
            document.getElementById('voiceRecordingOverlay').classList.add('hidden'); document.getElementById('voiceSaveBtn').disabled = false;
        }

        // ==================== CHAT VOICE INPUT ====================
        let chatVoiceRecognition = null, chatVoiceActive = false;
        function toggleChatVoice() { chatVoiceActive ? stopChatVoice() : startChatVoice(); }
        function startChatVoice() {
            var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) { showToast('Voice input not supported in this browser', 'error'); return; }
            chatVoiceActive = true; var btn = document.getElementById('chatMicBtn'); btn.classList.remove('bg-gray-100','text-gray-500'); btn.classList.add('bg-red-500','text-white','recording-pulse');
            chatVoiceRecognition = new SR(); chatVoiceRecognition.continuous = true; chatVoiceRecognition.interimResults = true; chatVoiceRecognition.lang = 'en-US';
            var chatInput = document.getElementById('chatInput'), finalText = '';
            chatVoiceRecognition.onresult = function(evt) { var interim = ''; for (var i = evt.resultIndex; i < evt.results.length; i++) { if (evt.results[i].isFinal) finalText += evt.results[i][0].transcript + ' '; else interim = evt.results[i][0].transcript; } chatInput.value = (finalText + interim).trim(); };
            chatVoiceRecognition.onerror = function(e) { console.warn('[Chat Voice] Error:', e.error); stopChatVoice(); };
            chatVoiceRecognition.onend = function() { if (chatVoiceActive) try { chatVoiceRecognition.start(); } catch(e) { stopChatVoice(); } };
            chatVoiceRecognition.start(); chatInput.placeholder = 'Listening... speak now';
        }
        function stopChatVoice() {
            chatVoiceActive = false; var btn = document.getElementById('chatMicBtn'); btn.classList.remove('bg-red-500','text-white','recording-pulse'); btn.classList.add('bg-gray-100','text-gray-500');
            if (chatVoiceRecognition) { chatVoiceRecognition.onend = null; try { chatVoiceRecognition.stop(); } catch(e) {} chatVoiceRecognition = null; }
            document.getElementById('chatInput').placeholder = 'Ask about your contacts...';
        }
    </script>
</body>
</html>
